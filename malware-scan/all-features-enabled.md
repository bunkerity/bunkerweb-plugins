# Malware Scan Plugin - All Features Enabled Configuration

**Version**: 0.7.2
**Use Case**: Maximum protection with all scanners, notifications, and reporting enabled

---

## Complete Configuration

Copy these settings to `/etc/bunkerweb/variables.env` on your BunkerWeb cluster.

```env
# ============================================================================
# CORE SETTINGS
# ============================================================================

# Enable malware scanning
MALWARE_SCAN_ENABLED=yes

# Enable debug logging (disable in production after testing)
MALWARE_SCAN_DEBUG=no

# ============================================================================
# CLAMAV SETTINGS (Local Signature-Based Scanning)
# ============================================================================

# ClamAV daemon connection
MALWARE_SCAN_CLAMAV_HOST=127.0.0.1
MALWARE_SCAN_CLAMAV_PORT=3310
MALWARE_SCAN_CLAMAV_TIMEOUT=10000

# File size limits (in bytes)
MALWARE_SCAN_CLAMAV_MAX_SIZE=26214400      # 25MB for ClamAV INSTREAM
MALWARE_SCAN_HASH_MAX_SIZE=67108864        # 64MB for hash-based scanners

# ============================================================================
# ALLOW LIST (FALSE POSITIVE HANDLING)
# ============================================================================

# SHA256 hashes of known-good files to skip scanning
# Comma-separated list of full SHA256 hashes (64 hex characters each)
# Files matching these hashes skip all scanning and are cached as clean
# Use for legitimate files incorrectly flagged as malware
MALWARE_SCAN_ALLOWLIST_HASHES=

# Path to file containing SHA256 hashes (one per line)
# File format: one SHA256 hash per line, blank lines and # comments ignored
# For large allow lists, use this instead of MALWARE_SCAN_ALLOWLIST_HASHES
MALWARE_SCAN_ALLOWLIST_FILE=

# ============================================================================
# MULTI-LAYER SCANNING STRATEGY
# ============================================================================

# Skip cloud scanners if ClamAV detects malware (faster response)
# Set to "no" for full analysis mode (all scanners run even on ClamAV hit)
MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT=no

# WARNING: Denial of Service Risk
# Continue scanning all files and scanners after first detection
# Collects comprehensive threat intelligence but allows attackers to force expensive operations
# Default: no (block immediately on first detection for best performance and security)
MALWARE_SCAN_RESUME_SCAN_ON_FIRST_HIT=no

# Filename Injection Attack Handling (Path Traversal, Null Bytes, etc.)
# Controls behavior when malicious filename patterns are detected
# Behavior matrix (see README.md for details):
#   BLOCK=yes, RESUME=yes:  Skip file, continue scanning other files, block at end
#   BLOCK=yes, RESUME=no:   Block immediately (default, fastest protection)
#   BLOCK=no,  RESUME=yes:  Log attack, scan file content anyway, continue to other files
#   BLOCK=no,  RESUME=no:   Log attack, scan file content anyway until first virus hit
# Default: yes (immediate blocking for maximum security)
MALWARE_SCAN_BLOCK_ON_FILENAME_INJECTION_ATTACK=yes

# Full Multipart Body Scan (Not Recommended)
# Enable scanning of entire multipart request body in addition to individual file extraction
# WARNING: Full body SHA256 changes on every upload due to random HTTP boundary strings
# This makes caching completely ineffective and wastes ClamAV resources
# Individual file extraction always occurs and provides consistent SHA256s for caching
# Only enable if you suspect malware might be split across multipart boundaries (extremely rare)
# Default: no (skip full body scan, extract and scan individual files only)
MALWARE_SCAN_SCAN_FULL_MULTIPART_BODY=no

# ============================================================================
# VIRUSTOTAL (70+ AV Engines + ML)
# ============================================================================

# Enable VirusTotal scanning
MALWARE_SCAN_API_USE_VIRUSTOTAL=yes

# Your VirusTotal API key (REQUIRED - replace with actual key)
# Get free key: https://www.virustotal.com/gui/join-us
MALWARE_SCAN_API_VIRUSTOTAL_KEY=

# Detection thresholds
MALWARE_SCAN_API_VIRUSTOTAL_SUSPICIOUS=5       # Suspicious if 5+ engines flag
MALWARE_SCAN_API_VIRUSTOTAL_MALICIOUS=3        # Malicious if 3+ engines flag

# Upload unknown files to VirusTotal for analysis
MALWARE_SCAN_API_VIRUSTOTAL_UPLOAD_UNKNOWN=yes

# Auto-vote on uploaded files (community contribution)
MALWARE_SCAN_API_VIRUSTOTAL_AUTO_VOTE=yes

# Maximum file size for VirusTotal upload (32MB)
MALWARE_SCAN_API_VIRUSTOTAL_MAX_UPLOAD_SIZE=33554432

# ============================================================================
# THREATFOX (Community IOC Database)
# ============================================================================

# Enable ThreatFox scanning (checks before VirusTotal to save API quota)
MALWARE_SCAN_API_USE_THREATFOX=yes

# Your ThreatFox API key (REQUIRED - replace with actual key)
# Get free key: https://auth.abuse.ch/
MALWARE_SCAN_API_THREATFOX_KEY=

# ============================================================================
# SENTINELONE (Enterprise Threat Intelligence)
# ============================================================================

# Enable SentinelOne scanning
MALWARE_SCAN_API_USE_SENTINELONE=yes

# Your SentinelOne console URL (REQUIRED - replace with actual URL)
# Example: https://your-console.sentinelone.net
MALWARE_SCAN_API_SENTINELONE_URL=

# Your SentinelOne API token (REQUIRED - replace with actual token)
# Generate: POST /web/api/v2.0/users/generate-api-token
MALWARE_SCAN_API_SENTINELONE_TOKEN=

# ============================================================================
# THREAT INTELLIGENCE SHARING
# ============================================================================

# Share detected malware files with VirusTotal for community protection
# WARNING: Only enable if you have permission to share uploaded files
# This helps the security community but may have legal/privacy implications
MALWARE_SCAN_SHARE_FILES=no

# ============================================================================
# WEBHOOK NOTIFICATIONS
# ============================================================================

# Microsoft Teams Webhook (optional)
# Create: Teams ‚Üí Channel ‚Üí ¬∑¬∑¬∑ ‚Üí Connectors ‚Üí Incoming Webhook
# Leave empty to disable Teams notifications
MALWARE_SCAN_TEAMS_WEBHOOK_URL=

# Teams rate limit (notifications per minute)
# Microsoft Teams limit: 200/min. Set to 0 for maximum (200). Default: 3/min
MALWARE_SCAN_TEAMS_WEBHOOK_RATE_LIMIT=3

# Discord Webhook (optional)
# Create: Discord ‚Üí Channel ‚Üí Edit ‚Üí Integrations ‚Üí Webhooks
# Leave empty to disable Discord notifications
MALWARE_SCAN_DISCORD_WEBHOOK_URL=

# Discord rate limit (notifications per minute)
# Discord limit: 30/min. Set to 0 for maximum (30). Default: 3/min
MALWARE_SCAN_DISCORD_WEBHOOK_RATE_LIMIT=3

# Unmask webhook URLs in logs (SECURITY RISK - debugging only)
# Set to 'I_WANT_TO_LEAK_MY_SECRETS_TO_LOG' to show full URLs in logs
# Leave empty to mask sensitive webhook URLs
MALWARE_SCAN_UNMASK_KEYS=

# ============================================================================
# ATTACKER TRACKING
# ============================================================================

# Track IP addresses that upload malware
# Shows repeat offender count, first upload time, and tracking duration in webhooks
# NOTE: TTL is reset on each new malware upload, allowing tracking of persistent attackers
MALWARE_SCAN_TRACK_ATTACKERS=yes

# Duration (in seconds) to track attacker IP addresses
# Default: 90 days (7776000 seconds)
# If attacker uploads malware again within this period, TTL is reset (tracking continues)
MALWARE_SCAN_TRACK_ATTACKER_TTL=7776000

# ============================================================================
# CACHING SETTINGS
# ============================================================================

# Enable Redis shared cache for cluster deployments
# Automatically disabled if BunkerWeb's global USE_REDIS is disabled
# Shares scan results across all worker nodes for better performance
MALWARE_SCAN_USE_SHARED_DATABASE=yes

# Cache TTL for malicious scan results (local cache)
# Lower values = faster response to new threats during outbreaks
# Higher values = fewer API calls and better performance
MALWARE_SCAN_CACHE_VIRUS_TTL=7776000       # 90 days (7776000 seconds)

# Cache TTL for clean scan results (local cache)
# Shorter than malicious TTL for security (differential caching)
# Allows quick detection of newly-identified threats
MALWARE_SCAN_CACHE_CLEAN_TTL=300           # 5 minutes (300 seconds)

# Cache TTL for Redis shared cache (cluster-wide)
# Longer than local cache to benefit from cluster knowledge
MALWARE_SCAN_CACHE_SHARED_TTL=21600        # 6 hours (21600 seconds)

# Redis circuit breaker max backoff time
# Protects against Redis outages with exponential backoff
# Sequence: 1ms, 2ms, 4ms, 8ms, 16ms, 32ms, 64ms, 128ms, 256ms, 512ms, 1s, 2s, 4s, up to this max
MALWARE_SCAN_REDIS_CIRCUIT_BREAKER_MAX_BACKOFF=8  # 8 seconds (default)

# Granular cache cleanup on plugin startup/reload
# Allows selective cache clearing per scanner or attacker tracking
# Useful after signature updates or to force fresh scans on specific scanners
# Clears both local (cachestore) and Redis (clusterstore) caches
# Default: no for all (preserve cache across restarts for performance)

# Master switch: Clear ALL caches (overrides individual flags below)
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ALL=no

# Individual cache cleanup flags (ignored if ALL=yes)
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_CLAMAV=no        # ClamAV - after signature updates
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_VIRUSTOTAL=no    # VirusTotal - for fresh lookups
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_THREATFOX=no     # ThreatFox - for fresh IOC data
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_SENTINELONE=no   # SentinelOne - for fresh threat intel
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ATTACKER_IPV4=no # IPv4 attacker tracking data
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ATTACKER_IPV6=no # IPv6 attacker tracking data

# ============================================================================
# FILE CLEANUP
# ============================================================================

# Auto-cleanup detected malware files
MALWARE_SCAN_CLEANUP_FILES=yes

# Cleanup orphaned temp files on worker start (workers only)
MALWARE_SCAN_CLEANUP_ORPHANED=yes

# Cleanup orphaned temp files older than this (seconds)
MALWARE_SCAN_CLEANUP_AGE=3600              # 1 hour

# ============================================================================
# MEMORY UPLOADS HANDLING
# ============================================================================

# Block uploads that are buffered in memory (can't be scanned)
# Set to "no" to allow with warning only
MALWARE_SCAN_BLOCK_MEMORY_UPLOADS=yes
```

---

## Scanner Execution Order

1. **ClamAV** (local, ~200ms)
   - Fast signature-based scanning
   - No API rate limits
   
2. **ThreatFox** (IOC database, ~100ms)
   - Checks before VirusTotal to save API quota
   - Community-contributed indicators of compromise
   
3. **VirusTotal** (70+ engines, ~500ms)
   - Most comprehensive scanning
   - Rate limited: 4 req/min, 500 req/day (public API)
   
4. **SentinelOne** (enterprise, ~200ms)
   - Requires commercial license
   - Rate limited: 10 req/sec (50 burst)

**Note**: Each scanner can block independently. First detection wins and request is immediately blocked.

---

## API Rate Limits

| Service | Free Tier | Rate Limit | Notes |
|---------|-----------|------------|-------|
| **ClamAV** | ‚úÖ Yes | None | Local scanning |
| **ThreatFox** | ‚úÖ Yes | Generous | Community database |
| **VirusTotal** | ‚úÖ Yes | 4/min, 500/day | Not for commercial use |
| **SentinelOne** | ‚ùå No | 10/sec, 50 burst | Requires license |

---

## Webhook Setup

### Microsoft Teams

1. Open Teams ‚Üí Channel ‚Üí **¬∑¬∑¬∑** ‚Üí **Connectors**
2. Add **Incoming Webhook**
3. Name: "BunkerWeb Malware Alerts"
4. Copy webhook URL
5. Paste into `MALWARE_SCAN_TEAMS_WEBHOOK_URL`
6. Optionally adjust `MALWARE_SCAN_TEAMS_WEBHOOK_RATE_LIMIT` (default: 3/min, max: 200/min)

### Discord

1. Open Discord ‚Üí Channel ‚Üí Right-click ‚Üí **Edit Channel**
2. **Integrations** ‚Üí **Webhooks** ‚Üí **New Webhook**
3. Name: "BunkerWeb Malware Alerts"
4. Copy webhook URL
5. Paste into `MALWARE_SCAN_DISCORD_WEBHOOK_URL`
6. Optionally adjust `MALWARE_SCAN_DISCORD_WEBHOOK_RATE_LIMIT` (default: 3/min, max: 30/min)

**Note**: You can configure both Teams and Discord webhooks simultaneously. Malware notifications will be sent to both platforms.

---

## Notification Example

When malware is detected, you'll receive:

```
üö® MALWARE DETECTED - BunkerWeb Alert

File: malicious_file.exe
SHA256: a1b2c3d4e5f6...
Detection: Win.Trojan.Generic
Scanner: VirusTotal (52 engines)
Server: www.example.com
Client IP: 203.0.113.45
Time: 2026-01-17 19:54:24 UTC

Status: Request blocked (HTTP 403)
```

---

## Verification

After configuration, verify all components are working:

### 1. Check Module Loading

```bash
journalctl -u bunkerweb -n 50 | grep "\[INIT\]"
```

Expected output on ALL nodes:
```
[INIT] Starting malware-scan module initialization
[INIT] file_ops module loaded successfully
[INIT] clamav module loaded successfully
[INIT] virustotal module loaded successfully
[INIT] threatfox module loaded successfully
[INIT] sentinelone module loaded successfully
[INIT] Module initialization complete
```

### 2. Test with EICAR File

```bash
# Create EICAR test file
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.txt

# Upload to protected site
curl -F "file=@eicar.txt" https://your-site.com/upload
```

Expected:
- ‚úÖ Request blocked (HTTP 403)
- ‚úÖ Malware detected in logs
- ‚úÖ Webhook notification received (if configured)

### 3. Verify Scanners

Check logs for scanner activity:

```bash
# ClamAV
journalctl -u bunkerweb | grep "MALWARE-SCAN.*ClamAV"

# VirusTotal
journalctl -u bunkerweb | grep "MALWARE-SCAN.*VirusTotal"

# ThreatFox
journalctl -u bunkerweb | grep "MALWARE-SCAN.*ThreatFox"

# SentinelOne (if enabled)
journalctl -u bunkerweb | grep "MALWARE-SCAN.*SentinelOne"

# Webhooks (if configured)
journalctl -u bunkerweb | grep "WEBHOOK"
```

---

## Performance Considerations

### Expected Scan Times

| Configuration | Avg Time | Use Case |
|---------------|----------|----------|
| ClamAV only | ~200ms | Fast, local scanning |
| ClamAV + ThreatFox | ~300ms | Good balance |
| ClamAV + ThreatFox + VT | ~800ms | Comprehensive |
| All scanners | ~1000ms | Maximum protection |

**Note**: Times assume cache misses. Cache hits return instantly.

### Optimization Tips

1. **Cache hits**: Most EICAR/common malware will be cached
   - First request: Full scan time
   - Subsequent requests: Instant (cache hit)

2. **Fast response mode**: `MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT=yes`
   - Blocks immediately on ClamAV detection
   - Skips cloud scanners (saves API quota)
   - Reduces response time by ~500ms

3. **File size limits**:
   - Large files skip appropriate scanners
   - Prevents timeouts and resource exhaustion

---

## Security Best Practices

### API Keys

- ‚úÖ Store in `/etc/bunkerweb/variables.env`
- ‚úÖ Set permissions: `chmod 600 /etc/bunkerweb/variables.env`
- ‚úÖ Never commit to version control
- ‚úÖ Rotate periodically
- ‚úÖ Use separate keys for staging/production

### Webhook URLs

- ‚úÖ Treat as secrets (contain authentication tokens)
- ‚úÖ Use separate webhooks for staging/production
- ‚úÖ Restrict access to webhook channels
- ‚úÖ Rotate webhook URLs if compromised

### File Sharing

- ‚ö†Ô∏è `MALWARE_SCAN_SHARE_FILES=no` by default
- ‚ö†Ô∏è Only enable if legally permitted
- ‚ö†Ô∏è Consider data privacy implications (GDPR, etc.)
- ‚ö†Ô∏è User-uploaded files may contain sensitive data

---

## Deployment

### Cluster Deployment (All Nodes Required)

```bash
# Deploy to manager
scp *.lua plugin.json waf-mgr:/etc/bunkerweb/plugins/malware-scan/

# Deploy to workers
scp *.lua plugin.json waf01:/etc/bunkerweb/plugins/malware-scan/
scp *.lua plugin.json waf02:/etc/bunkerweb/plugins/malware-scan/

# Set permissions on all nodes
for node in waf-mgr waf01 waf02; do
  ssh $node 'chmod 644 /etc/bunkerweb/plugins/malware-scan/*.lua /etc/bunkerweb/plugins/malware-scan/plugin.json'
done

# Restart on all nodes
for node in waf-mgr waf01 waf02; do
  ssh $node 'systemctl restart bunkerweb'
done
```

### Configuration Deployment

```bash
# Edit configuration on manager
nano /etc/bunkerweb/variables.env

# Add all settings from this file
# Save and restart
systemctl restart bunkerweb*
```

---

## Troubleshooting

### No malware detections

1. Verify plugin is enabled: `MALWARE_SCAN_ENABLED=yes`
2. Check ClamAV is running: `systemctl status clamav-daemon`
3. Test with EICAR file (see above)
4. Check logs: `journalctl -u bunkerweb | grep MALWARE-SCAN`

### API rate limit errors

**VirusTotal**:
- Symptom: "429 Too Many Requests"
- Solution: Reduce scan frequency or upgrade to premium API
- Workaround: Enable ThreatFox to reduce VT usage

**SentinelOne**:
- Symptom: "429 Too Many Requests"
- Solution: Contact SentinelOne support to increase limits

### Webhook notifications not received

1. Test webhook URL manually:

   **Teams**:
   ```bash
   curl -X POST -H "Content-Type: application/json" \
     -d '{"text":"Test from BunkerWeb"}' \
     YOUR-TEAMS-WEBHOOK-URL
   ```

   **Discord**:
   ```bash
   curl -X POST -H "Content-Type: application/json" \
     -d '{"content":"Test from BunkerWeb"}' \
     YOUR-DISCORD-WEBHOOK-URL
   ```

2. Check logs: `journalctl -u bunkerweb | grep WEBHOOK`

3. Verify rate limiting:
   - Teams: `MALWARE_SCAN_TEAMS_WEBHOOK_RATE_LIMIT` (default: 3/min)
   - Discord: `MALWARE_SCAN_DISCORD_WEBHOOK_RATE_LIMIT` (default: 3/min)

### Module loading errors

```bash
# Check for errors
journalctl -u bunkerweb | grep -E "\[INIT\].*FAILED|error"

# Verify all files present
ls -lh /etc/bunkerweb/plugins/malware-scan/*.lua

# Check permissions
ls -l /etc/bunkerweb/plugins/malware-scan/
```

---

## Support

- **BunkerWeb Docs**: https://docs.bunkerweb.io/
- **ClamAV Docs**: https://docs.clamav.net/
- **VirusTotal API**: https://developers.virustotal.com/
- **ThreatFox API**: https://threatfox.abuse.ch/
- **Plugin Issues**: Check logs first: `journalctl -u bunkerweb | grep MALWARE-SCAN`

---

## Related Documentation

- [README.md](README.md) - Main plugin documentation
- [install.md](install.md) - Installation guide
- [old/WHY_IT_BROKE.md](old/WHY_IT_BROKE.md) - Refactoring post-mortem

---

**Plugin Version**: 0.7.2
**Last Updated**: 2026-01-19
**Status**: Production Ready ‚úÖ

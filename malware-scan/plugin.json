{
  "id": "malware-scan",
  "name": "Malware Scanner",
  "description": "Scan uploaded files for malware using ClamAV. Works with HTTP/1.1, HTTP/2, and HTTP/3.",
  "version": "0.7.2",
  "stream": "no",
  "settings": {
    "MALWARE_SCAN_ENABLED": {
      "context": "global",
      "default": "no",
      "help": "Enable malware scanning for file uploads",
      "id": "use-malware-scan",
      "label": "Enable malware scanning",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_DEBUG": {
      "context": "global",
      "default": "no",
      "help": "Enable detailed debug logging (shows every operation step, byte analysis, pattern matching). Only enable for troubleshooting as it generates verbose logs.",
      "id": "malware-scan-debug",
      "label": "Debug mode",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CLAMAV_HOST": {
      "context": "global",
      "default": "127.0.0.1",
      "help": "ClamAV server hostname or IP address",
      "id": "malware-scan-clamav-host",
      "label": "ClamAV host",
      "regex": "^.*$",
      "type": "text"
    },
    "MALWARE_SCAN_CLAMAV_PORT": {
      "context": "global",
      "default": "3310",
      "help": "ClamAV server TCP port",
      "id": "malware-scan-clamav-port",
      "label": "ClamAV port",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_CLAMAV_TIMEOUT": {
      "context": "global",
      "default": "10000",
      "help": "ClamAV connection timeout in milliseconds",
      "id": "malware-scan-clamav-timeout",
      "label": "ClamAV timeout (ms)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_CLAMAV_MAX_SIZE": {
      "context": "global",
      "default": "26214400",
      "help": "Maximum file size (in bytes) for ClamAV scanning via INSTREAM. Files larger than this will skip ClamAV scan but continue with hash-based scanners. Default: 25MB (26214400 bytes). Should match or be less than ClamAV's StreamMaxLength setting (default 25M on Debian).",
      "id": "malware-scan-clamav-max-size",
      "label": "ClamAV max file size (bytes)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_HASH_MAX_SIZE": {
      "context": "global",
      "default": "67108864",
      "help": "Maximum file size (in bytes) for hash-based scanning (VirusTotal, ThreatFox, SentinelOne). Files larger than this will skip SHA256 calculation and hash-based scanners to avoid performance issues with large files like ISOs. Default: 64MB (67108864 bytes). ClamAV scan is unaffected by this limit.",
      "id": "malware-scan-hash-max-size",
      "label": "Hash scan max file size (bytes)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_ALLOWLIST_HASHES": {
      "context": "global",
      "default": "",
      "help": "SHA256 hashes of known-good files to skip scanning (for false positive handling). Comma-separated list of full SHA256 hashes (64 hex characters each). Files matching these hashes will skip all scanning (ClamAV, VirusTotal, ThreatFox, SentinelOne) and be cached as clean. Example: abc123...,def456... Use this for legitimate files incorrectly flagged as malware. For large lists, use MALWARE_SCAN_ALLOWLIST_FILE instead. Leave empty to scan all files.",
      "id": "malware-scan-allowlist-hashes",
      "label": "Allow list SHA256 hashes (comma-separated)",
      "regex": "^([a-fA-F0-9]{64}(,[a-fA-F0-9]{64})*)?$",
      "type": "text"
    },
    "MALWARE_SCAN_ALLOWLIST_FILE": {
      "context": "global",
      "default": "",
      "help": "Path to file containing SHA256 hashes of known-good files to skip scanning (for false positive handling). File format: one SHA256 hash per line (64 hex characters), blank lines and lines starting with # are ignored. Files matching these hashes will skip all scanning (ClamAV, VirusTotal, ThreatFox, SentinelOne) and be cached as clean. Use this for large allow lists. Leave empty to disable file-based allow list.",
      "id": "malware-scan-allowlist-file",
      "label": "Allow list file path",
      "regex": "^.*$",
      "type": "text"
    },
    "MALWARE_SCAN_BLOCK_MEMORY_UPLOADS": {
      "context": "global",
      "default": "no",
      "help": "Block uploads that are buffered in memory instead of files (cannot scan memory uploads)",
      "id": "malware-scan-block-memory",
      "label": "Block memory uploads",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CLEANUP_FILES": {
      "context": "global",
      "default": "yes",
      "help": "Automatically delete temporary files after scanning",
      "id": "malware-scan-cleanup",
      "label": "Cleanup temp files",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CLEANUP_ORPHANED": {
      "context": "global",
      "default": "no",
      "help": "Clean up orphaned temporary files on worker start",
      "id": "malware-scan-cleanup-orphaned",
      "label": "Cleanup orphaned files",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CLEANUP_AGE": {
      "context": "global",
      "default": "3600",
      "help": "Maximum age (in seconds) for temporary files before cleanup",
      "id": "malware-scan-cleanup-age",
      "label": "Cleanup age (seconds)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_USE_SHARED_DATABASE": {
      "context": "global",
      "default": "yes",
      "help": "Enable Redis shared cache for scan results across cluster nodes. Automatically disabled if BunkerWeb's global USE_REDIS is disabled. Improves performance in multi-node deployments by sharing scan results between workers.",
      "id": "malware-scan-use-shared-database",
      "label": "Use Redis shared cache",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CACHE_VIRUS_TTL": {
      "context": "global",
      "default": "7776000",
      "help": "Cache duration (in seconds) for malicious scan results (all scanners). Default: 90 days (7776000 seconds). Extended retention improves performance by avoiding re-scanning of known malware, reduces API calls to external scanners (VirusTotal, ThreatFox), and maintains detection history. Malware file hashes (SHA256) rarely change, making long-term caching safe and beneficial.",
      "id": "malware-scan-cache-virus-ttl",
      "label": "Malicious scan cache TTL (seconds)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_CACHE_CLEAN_TTL": {
      "context": "global",
      "default": "300",
      "help": "Cache duration (in seconds) for clean scan results. Shorter than malicious TTL to quickly detect newly-identified threats. Default: 5 minutes (300 seconds). This implements differential caching for security.",
      "id": "malware-scan-cache-clean-ttl",
      "label": "Clean scan cache TTL (seconds)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_CACHE_SHARED_TTL": {
      "context": "global",
      "default": "21600",
      "help": "Cache duration (in seconds) for scan results stored in Redis (shared across cluster). Longer than local cache to benefit from cluster-wide knowledge. Default: 6 hours (21600 seconds).",
      "id": "malware-scan-cache-shared-ttl",
      "label": "Redis shared cache TTL (seconds)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_REDIS_CIRCUIT_BREAKER_MAX_BACKOFF": {
      "context": "global",
      "default": "8",
      "help": "Maximum backoff time (in seconds) for Redis circuit breaker. Circuit breaker uses exponential backoff starting at 1ms (2ms, 4ms, 8ms, 16ms, 32ms, 64ms, 128ms, 256ms, 512ms, 1s, 2s, 4s, up to this max). Protects against Redis outages by temporarily skipping Redis operations. Default: 8 seconds.",
      "id": "malware-scan-redis-circuit-breaker-max-backoff",
      "label": "Redis circuit breaker max backoff (seconds)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_API_USE_VIRUSTOTAL": {
      "context": "global",
      "default": "no",
      "help": "Enable VirusTotal API integration for cloud-based scanning. Can be used together with ClamAV (dual-layer) or independently (VirusTotal-only mode by disabling ClamAV)",
      "id": "malware-scan-api-use-virustotal",
      "label": "Enable VirusTotal",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT": {
      "context": "global",
      "default": "yes",
      "help": "Skip cloud scanner checks (ThreatFox, VirusTotal, SentinelOne) if ClamAV already detected malware (faster blocking). Disable to get additional cloud analysis even after ClamAV detection.",
      "id": "malware-scan-skip-others-clamav",
      "label": "Skip cloud scanners if ClamAV detects",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_RESUME_SCAN_ON_FIRST_HIT": {
      "context": "global",
      "default": "no",
      "help": "WARNING: Possible denial of service risk. When malware is detected, continue scanning remaining files/scanners to collect comprehensive threat intelligence. Plugin performs dual scanning: (1) entire multipart body to catch malware split across boundaries, (2) individual files. Resume mode collects all detections before blocking. Default: no (block immediately on first detection).",
      "id": "malware-scan-resume-on-first-hit",
      "label": "Resume scan on first hit (DOS risk)",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_BLOCK_ON_FILENAME_INJECTION_ATTACK": {
      "context": "global",
      "default": "yes",
      "help": "Block filename injection attacks (path traversal, null bytes). Behavior depends on RESUME_SCAN_ON_FIRST_HIT: (1) BLOCK=yes, RESUME=yes: Skip file, scan others, block at end. (2) BLOCK=yes, RESUME=no: Block immediately (default). (3) BLOCK=no, RESUME=yes: Log, scan content, continue. (4) BLOCK=no, RESUME=no: Log, scan until detection. When BLOCK=no, file content is still scanned for malware. Default: yes (immediate blocking).",
      "id": "malware-scan-block-on-filename-injection",
      "label": "Block on filename injection attack",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_SCAN_FULL_MULTIPART_BODY": {
      "context": "global",
      "default": "no",
      "help": "Enable full multipart body scan (in addition to individual file extraction). WARNING: Full body SHA256 changes on every upload due to random HTTP boundary strings, making caching ineffective and wasting ClamAV resources. Individual file extraction always occurs regardless of this setting. Keep disabled (no) unless you suspect malware split across multipart boundaries. Default: no (skip full body scan, extract and scan individual files only).",
      "id": "malware-scan-scan-full-multipart-body",
      "label": "Scan full multipart body (not recommended)",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_API_VIRUSTOTAL_KEY": {
      "context": "global",
      "default": "",
      "help": "VirusTotal API key for authentication",
      "id": "malware-scan-api-virustotal-key",
      "label": "VirusTotal API key",
      "regex": "^.*$",
      "type": "password"
    },
    "MALWARE_SCAN_API_VIRUSTOTAL_SUSPICIOUS": {
      "context": "global",
      "default": "5",
      "help": "Minimum number of suspicious reports before considering file as malicious",
      "id": "malware-scan-api-virustotal-suspicious",
      "label": "Suspicious threshold",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_API_VIRUSTOTAL_MALICIOUS": {
      "context": "global",
      "default": "3",
      "help": "Minimum number of malicious reports before considering file as malicious",
      "id": "malware-scan-api-virustotal-malicious",
      "label": "Malicious threshold",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_API_VIRUSTOTAL_UPLOAD_UNKNOWN": {
      "context": "global",
      "default": "no",
      "help": "Upload file to VirusTotal if ClamAV detects malware but the file is unknown to VirusTotal (not in their database). Helps improve VirusTotal's malware database.",
      "id": "malware-scan-api-virustotal-upload-unknown",
      "label": "Upload unknown malware to VT",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_API_VIRUSTOTAL_AUTO_VOTE": {
      "context": "global",
      "default": "no",
      "help": "Automatically vote on files uploaded to VirusTotal. If a file was uploaded (unknown to VT) and ClamAV detected it as malware, automatically add a 'malicious' vote.",
      "id": "malware-scan-api-virustotal-auto-vote",
      "label": "Auto-vote on uploaded files",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_API_VIRUSTOTAL_MAX_UPLOAD_SIZE": {
      "context": "global",
      "default": "33554432",
      "help": "Maximum file size (in bytes) for uploading to VirusTotal. Default is 32MB (33554432 bytes), which is VirusTotal's limit for standard API.",
      "id": "malware-scan-api-virustotal-max-upload-size",
      "label": "Max VT upload size (bytes)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_SHARE_FILES": {
      "context": "global",
      "default": "no",
      "help": "Share detected malware files with threat intelligence platforms (currently VirusTotal) when any scanner (ClamAV, ThreatFox, SentinelOne) detects malware but the file is unknown to the platform. Helps improve global threat intelligence. Requires VirusTotal integration to be enabled. Only real malware is shared, not PUA.",
      "id": "malware-scan-share-files",
      "label": "Share detected malware files",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_API_USE_THREATFOX": {
      "context": "global",
      "default": "no",
      "help": "Enable ThreatFox (abuse.ch) API integration for IOC lookup. Checks file hashes against known malware indicators. Can be used together with ClamAV and VirusTotal for multi-layer protection.",
      "id": "malware-scan-api-use-threatfox",
      "label": "Enable ThreatFox",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_API_THREATFOX_KEY": {
      "context": "global",
      "default": "",
      "help": "ThreatFox API key for authentication (REQUIRED). Get your free key from https://auth.abuse.ch/",
      "id": "malware-scan-api-threatfox-key",
      "label": "ThreatFox API key",
      "regex": "^.*$",
      "type": "password"
    },
    "MALWARE_SCAN_API_USE_SENTINELONE": {
      "context": "global",
      "default": "no",
      "help": "Enable SentinelOne API integration for threat intelligence lookup. Checks file hashes against SentinelOne's threat database. Can be used together with ClamAV, VirusTotal, and ThreatFox for multi-layer protection.",
      "id": "malware-scan-api-use-sentinelone",
      "label": "Enable SentinelOne",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_API_SENTINELONE_URL": {
      "context": "global",
      "default": "",
      "help": "SentinelOne Management Console URL (e.g., https://your-console.sentinelone.net). Required for SentinelOne integration.",
      "id": "malware-scan-api-sentinelone-url",
      "label": "SentinelOne Console URL",
      "regex": "^.*$",
      "type": "text"
    },
    "MALWARE_SCAN_API_SENTINELONE_TOKEN": {
      "context": "global",
      "default": "",
      "help": "SentinelOne API token for authentication (REQUIRED). Generate from Console: POST /web/api/v2.0/users/generate-api-token",
      "id": "malware-scan-api-sentinelone-token",
      "label": "SentinelOne API token",
      "regex": "^.*$",
      "type": "password"
    },
    "MALWARE_SCAN_TEAMS_WEBHOOK_URL": {
      "context": "global",
      "default": "",
      "help": "Microsoft Teams webhook URL for malware detection notifications. Create an Incoming Webhook connector in Teams. Leave empty to disable Teams notifications.",
      "id": "malware-scan-teams-webhook-url",
      "label": "Teams webhook URL",
      "regex": "^.*$",
      "type": "password"
    },
    "MALWARE_SCAN_TEAMS_WEBHOOK_RATE_LIMIT": {
      "context": "global",
      "default": "3",
      "help": "Maximum Teams webhook notifications per minute. Microsoft Teams limit: 200/min. Set to 0 to use maximum (200). Default: 3/min.",
      "id": "malware-scan-teams-webhook-rate-limit",
      "label": "Teams rate limit (per min)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_DISCORD_WEBHOOK_URL": {
      "context": "global",
      "default": "",
      "help": "Discord webhook URL for malware detection notifications. Create a webhook in Discord channel settings. Leave empty to disable Discord notifications.",
      "id": "malware-scan-discord-webhook-url",
      "label": "Discord webhook URL",
      "regex": "^.*$",
      "type": "password"
    },
    "MALWARE_SCAN_DISCORD_WEBHOOK_RATE_LIMIT": {
      "context": "global",
      "default": "3",
      "help": "Maximum Discord webhook notifications per minute. Discord limit: 30/min. Set to 0 to use maximum (30). Default: 3/min.",
      "id": "malware-scan-discord-webhook-rate-limit",
      "label": "Discord rate limit (per min)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_ANONYMIZE_WEBHOOK_IPS": {
      "context": "global",
      "default": "yes",
      "help": "Anonymize IP addresses in webhook notifications for GDPR data minimization (Article 5(1)(c)). Masks last octet/group (192.168.1.123 -> 192.168.1.x) to provide network-level information without exposing full IPs to third parties (Microsoft Teams/Discord). Set to 'no' to send full IPs. Default: yes (recommended for GDPR compliance).",
      "id": "malware-scan-anonymize-webhook-ips",
      "label": "Anonymize IPs in webhooks",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_TRACK_ATTACKERS": {
      "context": "global",
      "default": "yes",
      "help": "Track IP addresses that upload malware to identify repeat offenders. Shows upload history in webhook notifications and logs. Data stored in cache with configurable TTL.",
      "id": "malware-scan-track-attackers",
      "label": "Track attacker IPs",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_TRACK_ATTACKER_TTL": {
      "context": "global",
      "default": "7776000",
      "help": "Duration (in seconds) to track attacker IP addresses. Default: 90 days (7776000 seconds). This extended retention period allows sufficient time to gather evidence for law enforcement and legal proceedings. After this period, the IP's malware upload history is cleared. TTL is reset on each new malware upload.",
      "id": "malware-scan-track-attacker-ttl",
      "label": "Attacker tracking TTL (seconds)",
      "regex": "^\\d+$",
      "type": "text"
    },
    "MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ALL": {
      "context": "global",
      "default": "no",
      "help": "Clear ALL cached scan results on plugin startup/reload. Master switch that overrides individual scanner cleanup flags. Useful after signature updates. Clears both local and Redis caches.",
      "id": "malware-scan-cache-cleanup-on-restart-all",
      "label": "Clear all caches on restart",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_CLAMAV": {
      "context": "global",
      "default": "no",
      "help": "Clear ClamAV cached scan results on plugin startup/reload. Useful after ClamAV signature database updates. Ignored if cleanup_all is enabled.",
      "id": "malware-scan-cache-cleanup-on-restart-clamav",
      "label": "Clear ClamAV cache on restart",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_VIRUSTOTAL": {
      "context": "global",
      "default": "no",
      "help": "Clear VirusTotal cached scan results on plugin startup/reload. Use when you want fresh VirusTotal lookups. Ignored if cleanup_all is enabled.",
      "id": "malware-scan-cache-cleanup-on-restart-virustotal",
      "label": "Clear VirusTotal cache on restart",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_THREATFOX": {
      "context": "global",
      "default": "no",
      "help": "Clear ThreatFox cached scan results on plugin startup/reload. Use when you want fresh ThreatFox IOC lookups. Ignored if cleanup_all is enabled.",
      "id": "malware-scan-cache-cleanup-on-restart-threatfox",
      "label": "Clear ThreatFox cache on restart",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_SENTINELONE": {
      "context": "global",
      "default": "no",
      "help": "Clear SentinelOne cached scan results on plugin startup/reload. Use when you want fresh SentinelOne threat intelligence. Ignored if cleanup_all is enabled.",
      "id": "malware-scan-cache-cleanup-on-restart-sentinelone",
      "label": "Clear SentinelOne cache on restart",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ATTACKER_IPV4": {
      "context": "global",
      "default": "no",
      "help": "Clear IPv4 attacker tracking data on plugin startup/reload. Removes malware upload history for all tracked IPv4 addresses. Ignored if cleanup_all is enabled.",
      "id": "malware-scan-cache-cleanup-on-restart-attacker-ipv4",
      "label": "Clear IPv4 attacker tracking on restart",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ATTACKER_IPV6": {
      "context": "global",
      "default": "no",
      "help": "Clear IPv6 attacker tracking data on plugin startup/reload. Removes malware upload history for all tracked IPv6 addresses. Ignored if cleanup_all is enabled.",
      "id": "malware-scan-cache-cleanup-on-restart-attacker-ipv6",
      "label": "Clear IPv6 attacker tracking on restart",
      "regex": "^(yes|no)$",
      "type": "check"
    },
    "MALWARE_SCAN_UNMASK_KEYS": {
      "context": "global",
      "default": "",
      "help": "SECURITY RISK: Set to 'I_WANT_TO_LEAK_MY_SECRETS_TO_LOG' to show full webhook URLs in logs (for debugging only). Leave empty to mask sensitive URLs.",
      "id": "malware-scan-unmask-keys",
      "label": "Unmask secrets in logs",
      "regex": "^.*$",
      "type": "text"
    }
  }
}

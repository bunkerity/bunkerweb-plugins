-- BunkerWeb Malware Scan - Initialization Module
-- Centralized module loading and dependency initialization
-- Provides clean interface for plugin setup and dependency management

local logger = require("malware_scan_logger")
local ngx = ngx

-- Module table
local init = {}

-- Module version
init.VERSION = "0.8.0"

-- ============================================================================
-- MODULE LOADING
-- ============================================================================

-- Load all plugin dependencies with error handling.
-- Uses pcall to safely load each module, allowing the plugin to continue
-- functioning even if some optional modules fail to load.
--
-- Returns a table with:
-- - modules: Table of loaded modules (nil if failed to load)
-- - status: Table of load status (true/false for each module)
-- - errors: Table of error messages for failed loads
--
-- Example:
--   local deps = init.deps_load()
--   if deps.modules.clamav then
--     -- Use ClamAV module
--   else
--     -- ClamAV not available: deps.errors.clamav
--   end
--
--- @return table deps Table with modules, status, and errors
function init.deps_load()
	local modules = {}
	local status = {}
	local errors = {}

	-- Load logger module first (may be used by other modules)
	status.logger, errors.logger = pcall(function()
		modules.logger = require("malware_scan_logger")
	end)
	if not status.logger then
		modules.logger = nil
	end

	-- Load utilities module (required by other modules)
	status.utils, errors.utils = pcall(function()
		modules.utils = require("malware_scan_utils")
	end)
	if not status.utils then
		modules.utils = nil
	end

	-- Load database module (Redis connection and operations)
	status.database, errors.database = pcall(function()
		modules.database = require("malware_scan_database")
	end)
	if not status.database then
		modules.database = nil
	end

	-- Load cache module
	status.cache, errors.cache = pcall(function()
		modules.cache = require("malware_scan_cache")
	end)
	if not status.cache then
		modules.cache = nil
	end

	-- Load file operations module
	status.file_ops, errors.file_ops = pcall(function()
		modules.file_ops = require("malware_scan_file")
	end)
	if not status.file_ops then
		modules.file_ops = nil
	end

	-- Load ClamAV scanner module
	status.clamav, errors.clamav = pcall(function()
		modules.clamav = require("malware_scan_clamav")
	end)
	if not status.clamav then
		modules.clamav = nil
	end

	-- Load VirusTotal API module
	status.virustotal, errors.virustotal = pcall(function()
		modules.virustotal = require("malware_scan_virustotal")
	end)
	if not status.virustotal then
		modules.virustotal = nil
	end

	-- Load SentinelOne API module
	status.sentinelone, errors.sentinelone = pcall(function()
		modules.sentinelone = require("malware_scan_sentinelone")
	end)
	if not status.sentinelone then
		modules.sentinelone = nil
	end

	-- Load MalwareBazaar API module
	status.malwarebazaar, errors.malwarebazaar = pcall(function()
		modules.malwarebazaar = require("malware_scan_malwarebazaar")
	end)
	if not status.malwarebazaar then
		modules.malwarebazaar = nil
	end

	-- Load webhook notification module
	status.webhook, errors.webhook = pcall(function()
		modules.webhook = require("malware_scan_webhook")
	end)
	if not status.webhook then
		modules.webhook = nil
	end

	-- Load multipart full scan module
	status.multipart_full_scan, errors.multipart_full_scan = pcall(function()
		modules.multipart_full_scan = require("malware_scan_multipart_full_scan")
	end)
	if not status.multipart_full_scan then
		modules.multipart_full_scan = nil
	end

	-- Load utilities module
	status.ms_utils, errors.ms_utils = pcall(function()
		modules.ms_utils = require("malware_scan_utils")
	end)
	if not status.ms_utils then
		modules.ms_utils = nil
	end

	-- Load file types module
	status.filetypes, errors.filetypes = pcall(function()
		modules.filetypes = require("malware_scan_filetypes")
	end)
	if not status.filetypes then
		modules.filetypes = nil
	end

	-- Load configuration module
	status.ms_config, errors.ms_config = pcall(function()
		modules.ms_config = require("malware_scan_config")
	end)
	if not status.ms_config then
		modules.ms_config = nil
	end

	-- Load orchestrator module
	status.ms_orchestrator, errors.ms_orchestrator = pcall(function()
		modules.ms_orchestrator = require("malware_scan_orchestrator")
	end)
	if not status.ms_orchestrator then
		modules.ms_orchestrator = nil
	end

	-- Load API handler module
	status.ms_api, errors.ms_api = pcall(function()
		modules.ms_api = require("malware_scan_api")
	end)
	if not status.ms_api then
		modules.ms_api = nil
	end

	-- Load scheduler module
	status.ms_scheduler, errors.ms_scheduler = pcall(function()
		modules.ms_scheduler = require("malware_scan_scheduler")
	end)
	if not status.ms_scheduler then
		modules.ms_scheduler = nil
	end

	-- Load UI metrics module
	status.ui_metrics, errors.ui_metrics = pcall(function()
		modules.ui_metrics = require("malware_scan_ui_metrics")
	end)
	if not status.ui_metrics then
		modules.ui_metrics = nil
	end

	return {
		modules = modules,
		status = status,
		errors = errors
	}
end

-- ============================================================================
-- DEPENDENCY INITIALIZATION
-- ============================================================================

-- Initialize cross-module dependencies.
-- Sets up modules that depend on other modules (e.g., scanners need cache).
-- This function should be called after deps_load().
--
-- Dependency relationships:
-- - Cache module → ClamAV, VirusTotal, SentinelOne, MalwareBazaar, Multipart
-- - File ops module → VirusTotal, Multipart
-- - Scanner modules (ClamAV, VirusTotal, SentinelOne, MalwareBazaar) → Multipart
-- - Webhook module → Multipart
--
-- Example:
--   local deps = init.deps_load()
--   init.deps_initialize(deps.modules, deps.status)
--
--- @param modules Table of loaded modules from deps_load()
--- @param status Table of load status from deps_load()
function init.deps_initialize(modules, status)
	-- Set cache module for scanners (if cache is loaded)
	if status.cache and modules.cache then
		-- ClamAV needs cache for result caching
		if status.clamav and modules.clamav then
			modules.clamav.set_cache_module(modules.cache)
		end

		-- VirusTotal needs cache for API response caching
		if status.virustotal and modules.virustotal then
			modules.virustotal.set_cache_module(modules.cache)
		end

		-- SentinelOne needs cache for API response caching
		if status.sentinelone and modules.sentinelone then
			modules.sentinelone.set_cache_module(modules.cache)
		end

		-- MalwareBazaar uses Redis directly (no API caching needed)
		-- Cache setup not required - MalwareBazaar integrates with Redis hash lookup

		-- Multipart scanner needs cache for body hash caching
		if status.multipart_full_scan and modules.multipart_full_scan then
			modules.multipart_full_scan.set_cache_module(modules.cache)
		end
	end

	-- Set file operations module (if file_ops is loaded)
	if status.file_ops and modules.file_ops then
		-- VirusTotal needs file ops for file upload
		if status.virustotal and modules.virustotal then
			modules.virustotal.set_file_ops_module(modules.file_ops)
		end

		-- Multipart scanner needs file ops for body extraction
		if status.multipart_full_scan and modules.multipart_full_scan then
			modules.multipart_full_scan.set_file_ops_module(modules.file_ops)
		end
	end

	-- Set scanner modules for multipart full scan (if multipart is loaded)
	if status.multipart_full_scan and modules.multipart_full_scan then
		-- ClamAV scanner for body scanning
		if status.clamav and modules.clamav then
			modules.multipart_full_scan.set_clamav_module(modules.clamav)
		end

		-- VirusTotal scanner for body hash lookup
		if status.virustotal and modules.virustotal then
			modules.multipart_full_scan.set_virustotal_module(modules.virustotal)
		end

		-- SentinelOne scanner for body hash lookup
		if status.sentinelone and modules.sentinelone then
			modules.multipart_full_scan.set_sentinelone_module(modules.sentinelone)
		end

		-- MalwareBazaar scanner for body hash lookup
		if status.malwarebazaar and modules.malwarebazaar then
			modules.multipart_full_scan.set_malwarebazaar_module(modules.malwarebazaar)
		end

		-- Webhook for malware detection notifications
		if status.webhook and modules.webhook then
			modules.multipart_full_scan.set_webhook_module(modules.webhook)
		end
	end
end

-- ============================================================================
-- PACKAGE PATH SETUP
-- ============================================================================

-- Setup package.path to include plugin directory.
-- This allows require() to find plugin modules in the BunkerWeb plugins directory.
-- Should be called before deps_load().
--
-- Default path: /etc/bunkerweb/plugins/malware-scan/
-- Can be overridden by passing custom path.
--
-- Example:
--   init.path_setup()  -- Use default path
--   init.path_setup("/custom/path/?.lua")  -- Use custom path
--
--- @param custom_path Optional custom path to add (default: /etc/bunkerweb/plugins/malware-scan/?.lua)
function init.path_setup(custom_path)
	local path = custom_path or "/etc/bunkerweb/plugins/malware-scan/?.lua"

	-- Only add if not already present (avoid duplicates)
	if not package.path:match(path:gsub("([%.%-%?])", "%%%1")) then
		package.path = package.path .. ";" .. path
	end
end

-- ============================================================================
-- CONFIGURATION VALIDATION
-- ============================================================================

-- Validate plugin configuration at startup.
-- Performs comprehensive checks on paths, numerical values, scanner dependencies,
-- and logical consistency of configuration options.
--
-- Validation errors are critical and should prevent plugin from starting.
-- Validation warnings are informational and logged but don't prevent startup.
--
-- Example:
--   local deps = init.initialize()
--   local valid, errors, warnings = init.validate_configuration(plugin, deps)
--   if not valid then
--     -- Log errors and abort
--   end
--
--- @param plugin Plugin instance (provides access to plugin.variables and plugin.logger)
--- @param deps Dependencies structure from deps_load() or initialize()
--- @return boolean valid True if validation passed
--- @return table errors List of validation errors
--- @return table warnings List of validation warnings
function init.validate_configuration(plugin, deps)
	-- Check if config module is loaded
	if not deps.status.ms_config or not deps.modules.ms_config then
		return false, {"Configuration module failed to load: " .. tostring(deps.errors.ms_config)}, {}
	end

	local config_module = deps.modules.ms_config

	-- Run comprehensive startup validation
	local valid, errors, warnings = config_module.validate_startup(plugin.variables)

	-- Log validation results
	if #errors > 0 then
		logger.log_error( "[INIT] Configuration validation FAILED:")
		for _, err in ipairs(errors) do
			logger.log_error( "[INIT]   " .. err)
		end
	end

	if #warnings > 0 then
		logger.log_warn( "[INIT] Configuration validation warnings:")
		for _, warn in ipairs(warnings) do
			logger.log_warn( "[INIT]   " .. warn)
		end
	end

	if valid and #warnings == 0 then
		logger.log_notice( "[INIT] Configuration validation passed (no errors or warnings)")
	elseif valid then
		logger.log_notice( "[INIT] Configuration validation passed with " .. #warnings .. " warning(s)")
	end

	return valid, errors, warnings
end

-- ============================================================================
-- COMPLETE INITIALIZATION
-- ============================================================================

-- Complete initialization workflow in one call.
-- Convenience function that runs all initialization steps:
-- 1. Setup package path
-- 2. Load all dependencies
-- 3. Initialize cross-module dependencies
--
-- Returns the same structure as deps_load() for easy access to modules.
--
-- Example:
--   local deps = init.initialize()
--   local clamav = deps.modules.clamav
--   local cache = deps.modules.cache
--
--- @param custom_path Optional custom package path
--- @return table deps Table with modules, status, and errors
function init.initialize(custom_path)
	-- Setup package path
	init.path_setup(custom_path)

	-- Load all dependencies
	local deps = init.deps_load()

	-- Initialize cross-module dependencies
	init.deps_initialize(deps.modules, deps.status)

	return deps
end

-- Complete initialization workflow with validation.
-- Like initialize() but also validates configuration at startup.
-- Returns validation results along with dependencies.
--
-- Example:
--   local deps, valid, errors, warnings = init.initialize_and_validate(plugin)
--   if not valid then
--     -- Abort startup due to configuration errors
--   end
--
--- @param plugin Plugin instance (provides access to plugin.variables and plugin.logger)
--- @param custom_path Optional custom package path
--- @return table deps Table with modules, status, and errors
--- @return boolean valid True if validation passed
--- @return table errors List of validation errors
--- @return table warnings List of validation warnings
function init.initialize_and_validate(plugin, custom_path)
	-- Run normal initialization
	local deps = init.initialize(custom_path)

	-- Validate configuration
	local valid, errors, warnings = init.validate_configuration(plugin, deps)

	return deps, valid, errors, warnings
end

-- Return module
return init

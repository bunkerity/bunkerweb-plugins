#!/bin/bash
# Clean up and re-register malware-scan plugin in BunkerWeb database
# Can run locally on manager or remotely via SSH
#
# Usage:
#   Local (on manager):  sudo ./cleanup-plugin.sh
#   Remote:              ./cleanup-plugin.sh --manager waf-mgr [--workers "waf01 waf02"]
#
# Updated for malware-scan v0.7.16 (59 settings)

set -e

PLUGIN_ID="malware-scan"
DB_PATH="/var/lib/bunkerweb/db.sqlite3"

# Parse command-line arguments
MANAGER_HOST=""
WORKER_HOSTS=""
REMOTE_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --manager)
            MANAGER_HOST="$2"
            REMOTE_MODE=true
            shift 2
            ;;
        --workers)
            WORKER_HOSTS="$2"
            shift 2
            ;;
        -h|--help)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --manager HOST     Manager host for remote execution (e.g., waf-mgr)"
            echo "  --workers HOSTS    Space-separated worker hosts (e.g., \"waf01 waf02\")"
            echo "  -h, --help         Show this help message"
            echo ""
            echo "Examples:"
            echo "  Local:   sudo $0"
            echo "  Remote:  $0 --manager waf-mgr --workers \"waf01 waf02\""
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Helper functions for local/remote execution
run_cmd() {
    if $REMOTE_MODE; then
        ssh "root@$MANAGER_HOST" "$1"
    else
        eval "$1"
    fi
}

copy_file() {
    if $REMOTE_MODE; then
        ssh "root@$MANAGER_HOST" "cp $1 $2"
    else
        cp "$1" "$2"
    fi
}

echo "=========================================================================="
echo "BUNKERWEB PLUGIN DATABASE CLEANUP"
echo "=========================================================================="
echo ""
echo "Plugin: $PLUGIN_ID"

if $REMOTE_MODE; then
    echo "Mode: Remote SSH"
    echo "Manager: $MANAGER_HOST"
    if [ -n "$WORKER_HOSTS" ]; then
        echo "Workers: $WORKER_HOSTS"
    fi
else
    echo "Mode: Local"
    echo "Running on: $(hostname)"
fi

echo ""
echo "This script will:"
echo "  1. Backup the database"
echo "  2. Delete the plugin from the database"
echo "  3. Trigger automatic re-registration"
if $REMOTE_MODE && [ -n "$WORKER_HOSTS" ]; then
    echo "  4. Restart manager and all workers"
else
    echo "  4. Restart BunkerWeb services"
fi
echo ""
echo "Use when:"
echo "  - Plugin.json updated but changes not reflected"
echo "  - Variables not loading despite correct configuration"
echo "  - 'Ignoring external plugin' warnings persist after fixes"
echo ""

read -p "Continue with cleanup? (y/n) " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Cleanup cancelled"
    exit 1
fi
echo ""

# Check if running as root (local mode only)
if ! $REMOTE_MODE; then
    if [ "$EUID" -ne 0 ]; then
        echo "❌ ERROR: This script must be run as root when running locally"
        echo "   Please run: sudo $0"
        exit 1
    fi
fi

# Check if database exists
if ! $REMOTE_MODE; then
    if [ ! -f "$DB_PATH" ]; then
        echo "❌ ERROR: Database not found at $DB_PATH"
        echo "   Is this a BunkerWeb manager node?"
        exit 1
    fi
fi

echo "1. Creating database backup..."
BACKUP_FILE="${DB_PATH}.backup-$(date +%Y%m%d-%H%M%S)"
copy_file "$DB_PATH" "$BACKUP_FILE"
echo "  ✅ Backup created: $BACKUP_FILE"
echo ""

echo "2. Checking current plugin state..."
CURRENT_VERSION=$(run_cmd "sqlite3 $DB_PATH \"SELECT version FROM bw_plugins WHERE id='$PLUGIN_ID';\" 2>/dev/null" || echo "NOT_FOUND")
SETTINGS_COUNT=$(run_cmd "sqlite3 $DB_PATH \"SELECT COUNT(*) FROM bw_settings WHERE id LIKE 'MALWARE_SCAN_%';\" 2>/dev/null" || echo "0")
VALUES_COUNT=$(run_cmd "sqlite3 $DB_PATH \"SELECT COUNT(*) FROM bw_global_values WHERE setting_id LIKE 'MALWARE_SCAN_%';\" 2>/dev/null" || echo "0")

if [ "$CURRENT_VERSION" == "NOT_FOUND" ]; then
    echo "  ⚠️  Plugin not found in database (nothing to clean up)"
    echo ""
    read -p "Do you want to trigger re-registration anyway? (y/n) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Exiting"
        exit 0
    fi
    echo ""
    echo "Skipping to step 5 (re-registration)..."
    echo ""
else
    echo "  Current state:"
    echo "    Version in DB: $CURRENT_VERSION"
    echo "    Settings count: $SETTINGS_COUNT"
    echo "    Configured values: $VALUES_COUNT"
    echo ""

    echo "3. Deleting plugin from database..."
    run_cmd "sqlite3 $DB_PATH \"DELETE FROM bw_plugins WHERE id='$PLUGIN_ID';\""
    echo "  ✅ Plugin deleted (cascades to settings and values)"
    echo ""

    echo "4. Verifying deletion..."
    REMAINING=$(run_cmd "sqlite3 $DB_PATH \"SELECT COUNT(*) FROM bw_plugins WHERE id='$PLUGIN_ID';\"")
    if [ "$REMAINING" -eq 0 ]; then
        echo "  ✅ Plugin successfully removed"
    else
        echo "  ❌ ERROR: Plugin still in database"
        exit 1
    fi
    echo ""
fi

echo "5. Restarting scheduler to trigger re-registration..."
run_cmd "systemctl restart bunkerweb-scheduler"
echo "  ✅ Scheduler restarted"
echo ""

echo "6. Waiting 15 seconds for re-registration..."
sleep 15
echo ""

echo "7. Checking re-registration..."
NEW_VERSION=$(run_cmd "sqlite3 $DB_PATH \"SELECT version FROM bw_plugins WHERE id='$PLUGIN_ID';\" 2>/dev/null" || echo "NOT_FOUND")
NEW_SETTINGS=$(run_cmd "sqlite3 $DB_PATH \"SELECT COUNT(*) FROM bw_settings WHERE id LIKE 'MALWARE_SCAN_%';\" 2>/dev/null" || echo "0")
NEW_VALUES=$(run_cmd "sqlite3 $DB_PATH \"SELECT COUNT(*) FROM bw_global_values WHERE setting_id LIKE 'MALWARE_SCAN_%';\" 2>/dev/null" || echo "0")

if [ "$NEW_VERSION" != "NOT_FOUND" ]; then
    echo "  ✅ Plugin re-registered successfully"
    echo "     New version: $NEW_VERSION"
    echo "     Settings imported: $NEW_SETTINGS"
    echo "     Values configured: $NEW_VALUES"

    # Validate settings count
    if [ "$NEW_SETTINGS" -ne 59 ]; then
        echo ""
        echo "  ⚠️  WARNING: Expected 59 settings, got $NEW_SETTINGS"
        echo "     This may indicate incomplete registration"
    fi
else
    echo "  ❌ ERROR: Plugin not re-registered"
    echo ""
    echo "  Checking scheduler logs for errors..."
    run_cmd "journalctl -u bunkerweb-scheduler --since '1 minute ago' --no-pager | grep -i 'malware-scan\|ignoring\|invalid' | head -20"
    echo ""
    echo "  Common issues:"
    echo "    - Invalid version format in plugin.json (must be X.Y or X.Y.Z, no suffixes)"
    echo "    - Help text exceeds 512 characters"
    echo "    - JSON syntax error in plugin.json"
    echo "    - Plugin directory not readable by nginx user"
    echo ""
    echo "  To restore from backup:"
    if $REMOTE_MODE; then
        echo "    ssh root@$MANAGER_HOST \"systemctl stop bunkerweb bunkerweb-scheduler\""
        echo "    ssh root@$MANAGER_HOST \"cp $BACKUP_FILE $DB_PATH\""
        echo "    ssh root@$MANAGER_HOST \"systemctl start bunkerweb-scheduler bunkerweb\""
    else
        echo "    systemctl stop bunkerweb bunkerweb-scheduler"
        echo "    cp $BACKUP_FILE $DB_PATH"
        echo "    systemctl start bunkerweb-scheduler bunkerweb"
    fi
    exit 1
fi
echo ""

echo "8. Restarting BunkerWeb services..."
if $REMOTE_MODE && [ -n "$WORKER_HOSTS" ]; then
    # Restart manager
    ssh "root@$MANAGER_HOST" "systemctl restart bunkerweb" &
    PID_MGR=$!

    # Restart workers in parallel
    declare -a WORKER_PIDS
    for worker in $WORKER_HOSTS; do
        ssh "root@$worker" "systemctl restart bunkerweb" &
        WORKER_PIDS+=($!)
    done

    # Wait for all restarts
    wait $PID_MGR && echo "  ✅ $MANAGER_HOST restarted"

    i=0
    for worker in $WORKER_HOSTS; do
        wait ${WORKER_PIDS[$i]} && echo "  ✅ $worker restarted"
        ((i++))
    done
else
    run_cmd "systemctl restart bunkerweb"
    echo "  ✅ BunkerWeb restarted"
fi
echo ""

echo "9. Waiting 10 seconds for startup..."
sleep 10
echo ""

echo "=========================================================================="
echo "CLEANUP COMPLETE"
echo "=========================================================================="
echo ""
echo "Plugin re-registered with version: $NEW_VERSION"
echo "Settings imported: $NEW_SETTINGS"
echo "Values configured: $NEW_VALUES"
echo ""

if [ "$NEW_VALUES" -eq 0 ]; then
    echo "⚠️  WARNING: No values were imported from variables.env"
    echo ""
    echo "This usually means:"
    echo "  1. Variables not defined in /etc/bunkerweb/variables.env"
    echo "  2. Variables need server prefix for multisite mode"
    echo ""
    echo "Check configuration:"
    if $REMOTE_MODE; then
        echo "  ssh root@$MANAGER_HOST 'grep MALWARE_SCAN /etc/bunkerweb/variables.env'"
    else
        echo "  grep MALWARE_SCAN /etc/bunkerweb/variables.env"
    fi
    echo ""
fi

echo "Next: Test variable loading by uploading a file"
echo ""
echo "  # Watch logs in real-time"
if $REMOTE_MODE && [ -n "$WORKER_HOSTS" ]; then
    FIRST_WORKER=$(echo "$WORKER_HOSTS" | awk '{print $1}')
    echo "  ssh root@$FIRST_WORKER 'tail -f /var/log/bunkerweb/access.log | grep --color=always MALWARE'"
else
    echo "  tail -f /var/log/bunkerweb/access.log | grep --color=always MALWARE"
fi
echo ""
echo "  # Upload a test file through your web application, then check:"
if $REMOTE_MODE && [ -n "$WORKER_HOSTS" ]; then
    FIRST_WORKER=$(echo "$WORKER_HOSTS" | awk '{print $1}')
    echo "  ssh root@$FIRST_WORKER 'tail -100 /var/log/bunkerweb/access.log | grep \"Found.*variables\"'"
else
    echo "  tail -100 /var/log/bunkerweb/access.log | grep \"Found.*variables\""
fi
echo ""
echo "Expected output:"
echo "  [MALWARE-SCAN] Found 59 variables in self.variables"
echo ""
echo "Database backup saved to: $BACKUP_FILE"
echo ""

if $REMOTE_MODE && [ -n "$WORKER_HOSTS" ]; then
    echo "=========================================================================="
    echo "CLUSTER DEPLOYMENT NOTE"
    echo "=========================================================================="
    echo ""
    echo "All cluster nodes have been restarted:"
    echo "  - Manager: $MANAGER_HOST"
    echo "  - Workers: $WORKER_HOSTS"
    echo ""
    echo "Verify workers loaded the plugin:"
    echo ""
    for worker in $WORKER_HOSTS; do
        echo "  ssh root@$worker 'journalctl -u bunkerweb --since \"1 minute ago\" | grep \"malware-scan.*loaded\"'"
    done
    echo ""
    echo "=========================================================================="
    echo ""
fi

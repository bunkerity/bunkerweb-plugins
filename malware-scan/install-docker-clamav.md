# ClamAV Docker Installation Guide - Debian & CentOS

This guide covers installing and configuring ClamAV using official Docker images from Docker Hub on Debian and CentOS-based systems.

**Supported Operating Systems:**
- Debian 11+
- Ubuntu 20.04+
- CentOS 7+
- Rocky Linux 8+
- AlmaLinux 8+
- Fedora 33+

The installation script automatically detects your OS and uses the appropriate package manager.

## Quick Installation (Automated)

For a fully automated installation with optimized configuration:

```bash
# Download and make executable
chmod +x install-docker-clamav.sh

# Run as root (default installation directory: /DATA/clamav)
sudo ./install-docker-clamav.sh

# Or specify custom installation directory
sudo ./install-docker-clamav.sh --install_dir=/opt/clamav
```

### Installation Options

- `--install_dir=PATH` - Custom installation directory (default: `/DATA/clamav`)
- `--help` - Show help message

### Examples

```bash
# Default installation to /DATA/clamav
sudo ./install-docker-clamav.sh

# Custom installation directory
sudo ./install-docker-clamav.sh --install_dir=/opt/clamav
sudo ./install-docker-clamav.sh --install_dir=/home/user/clamav
```

The script will:
1. Check if ClamAV is already running (prevents duplicate installations)
2. Validate system requirements (RAM, disk space)
3. Install Docker if needed
4. Create installation directory structure (default: `/DATA/clamav`)
5. Generate optimized configuration files (DetectPUA disabled, verbose logging)
6. Start ClamAV container with memory limits
7. **Configure syslog logging** (logs sent to host syslog/journald)
8. Wait for signature database download
9. Test installation with EICAR
10. Create helper scripts (start.sh, stop.sh, status.sh, logs.sh, update.sh)

**Logging**: By default, the script configures ClamAV to send logs to the host's syslog daemon using Docker's syslog logging driver. View logs with `sudo journalctl -t clamav -f` (not `docker logs`).

**Note**: If ClamAV is already running on port 3310, the script will detect it and exit without making changes.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Docker Installation](#docker-installation)
- [ClamAV Docker Setup](#clamav-docker-setup)
- [Container Configuration](#container-configuration)
- [Memory Optimization](#memory-optimization)
- [Testing ClamAV](#testing-clamav)
- [Integration with BunkerWeb](#integration-with-bunkerweb)
- [Troubleshooting](#troubleshooting)

## Prerequisites

### System Requirements

- **RAM**: **Minimum 4GB** for 24/7 ClamAV operation with concurrent database reload
- **Disk Space**: Minimum 2GB for signature databases
- **OS**:
  - Debian 11+
  - Ubuntu 20.04+
  - CentOS 7+
  - Rocky Linux 8+
  - AlmaLinux 8+
  - Fedora 33+
- **Architecture**: amd64, arm64, or arm/v7

### Why Use Docker for ClamAV?

- **Isolation**: ClamAV runs in isolated container environment
- **Easy Updates**: Pull new images for updates
- **Persistent Storage**: Database signatures survive container restarts
- **Simplified Deployment**: No package dependency conflicts

### Automated Installation Script

This guide includes an automated installation script (`install-docker-clamav.sh`) that:
- Checks if ClamAV is already running on port 3310 before installation
- Validates system requirements (RAM, disk space)
- Installs Docker if not present
- Creates optimized configuration files
- Sets up persistent data directory (default: `/DATA/clamav`, customizable with `--install_dir`)
- Tests installation with EICAR
- Creates helper scripts for management

**Safety Feature**: The script will detect if ClamAV is already running and exit gracefully to prevent conflicts.

## Docker Installation

### Automatic Docker Installation (Recommended)

The installation script handles Docker installation automatically for all supported operating systems. It will:
- Detect your OS (Debian/Ubuntu or CentOS/RHEL/Rocky/AlmaLinux)
- Use the appropriate package manager (`apt-get` or `yum`/`dnf`)
- Install Docker from the official repository
- Enable Docker service for auto-start on boot

**No manual Docker installation needed!** Just run the script and it takes care of everything.

### Manual Docker Installation

#### 1a. Install Docker Engine on Debian/Ubuntu

```bash
# Update package index
sudo apt update

# Install prerequisites
sudo apt install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# Add Docker's official GPG key
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg | \
    sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# Set up Docker repository
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
  https://download.docker.com/linux/debian \
  $(lsb_release -cs) stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install Docker Engine
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Verify installation
sudo docker --version
```

#### 1b. Install Docker Engine on CentOS/RHEL/Rocky/AlmaLinux

```bash
# Update package index
sudo yum update -y
# Or on newer systems (9+):
sudo dnf update -y

# Install prerequisites
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
# Or on newer systems (9+):
sudo dnf install -y dnf-plugins-core

# Add Docker repository
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
# Or on newer systems:
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# Install Docker Engine
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
# Or on newer systems:
sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Verify installation
sudo docker --version
```

### 2. Configure Docker (Optional)

```bash
# Add your user to docker group (to run docker without sudo)
sudo usermod -aG docker $USER

# Log out and back in for group changes to take effect
# Or run: newgrp docker

# Enable Docker to start on boot
sudo systemctl enable docker
sudo systemctl start docker
```

### Important: Using the Automated Installation Script

The `install-docker-clamav.sh` script handles all Docker installation automatically. You don't need to run these manual steps if you use the script. The script will:

1. **Detect your OS** from `/etc/os-release` or `/etc/redhat-release`
2. **Normalize OS names** (debian, ubuntu, centos, rhel, rocky, almalinux, fedora)
3. **Use the correct package manager** (apt-get for Debian/Ubuntu, yum/dnf for CentOS/RHEL)
4. **Install Docker** from the official repository for your OS
5. **Enable Docker service** for auto-start on boot

Example of OS detection in action:
```
[INFO] Detected OS: debian (Type: debian) Version: 13
# or
[INFO] Detected OS: centos (Type: rhel) Version: 7
# or
[INFO] Detected OS: rocky (Type: rhel) Version: 8
```

## ClamAV Docker Setup

### 1. Pull Official ClamAV Image

```bash
# Pull stable ClamAV image from Docker Hub
docker pull clamav/clamav:stable

# Verify image downloaded
docker images | grep clamav
```

**Available Image Tags:**
- `clamav/clamav:stable` - Full ClamAV with clamd and freshclam
- `clamav/clamav:stable_base` - Minimal image (no freshclam)
- `clamav/clamav:latest` - Latest development version (not recommended for production)

### 2. Create Persistent Volume for Signature Databases

ClamAV signature databases need to persist across container restarts:

```bash
# Create dedicated volume for ClamAV databases
docker volume create clamav-db

# Verify volume created
docker volume ls | grep clamav-db

# Inspect volume location
docker volume inspect clamav-db
```

**Volume Details:**
- **Mount Point**: `/var/lib/clamav` inside container
- **Purpose**: Stores virus signature databases (~1-2GB)
- **Persistence**: Survives container deletion and recreation

### 3. Run ClamAV Container

#### Basic Configuration (Recommended)

```bash
docker run -d \
  --name clamav \
  --restart unless-stopped \
  -p 3310:3310 \
  -v clamav-db:/var/lib/clamav \
  -e CLAMAV_NO_FRESHCLAMD=false \
  -e CLAMD_STARTUP_TIMEOUT=1800 \
  clamav/clamav:stable
```

**Configuration Breakdown:**
- `-d`: Run in detached mode (background)
- `--name clamav`: Container name for easy reference
- `--restart unless-stopped`: Auto-restart on failure/reboot
- `-p 3310:3310`: Expose clamd TCP socket on port 3310
- `-v clamav-db:/var/lib/clamav`: Mount persistent database volume
- `-e CLAMAV_NO_FRESHCLAMD=false`: Enable automatic signature updates
- `-e CLAMD_STARTUP_TIMEOUT=1800`: Allow 30 minutes for initial database download

#### Production Configuration with 24/7 Availability

For production use with BunkerWeb integration:

```bash
docker run -d \
  --name clamav \
  --restart unless-stopped \
  --memory="4g" \
  --memory-swap="4g" \
  -p 3310:3310 \
  -v clamav-db:/var/lib/clamav \
  -e CLAMAV_NO_FRESHCLAMD=false \
  -e CLAMD_STARTUP_TIMEOUT=1800 \
  -e FRESHCLAM_CHECKS=12 \
  clamav/clamav:stable
```

**Memory Settings:**
- `--memory="4g"`: Limit container to 4GB RAM (required for concurrent reload)
- `--memory-swap="4g"`: Disable swap to prevent OOM issues
- `-e FRESHCLAM_CHECKS=12`: Check for updates every 2 hours

**Why 4GB:** Concurrent database reload (enabled by default) requires ~4GB peak memory but ensures the ClamAV socket remains available 24/7 without interruption during signature updates.

### 4. Monitor Container Startup

```bash
# Watch container logs during startup
docker logs -f clamav

# Initial database download takes 10-30 minutes
# Look for: "clamd[1]: Self checking every 600 seconds"
# This indicates ClamAV is ready
```

**Expected Startup Messages:**
```
+++ Starting initial checks +++
+++ Database check passed +++
+++ Starting FreshClam +++
+++ Starting ClamAV +++
clamd[1]: Self checking every 600 seconds
```

## Container Configuration

### Environment Variables

Configure ClamAV behavior using environment variables:

```bash
# Create config file for easier management
cat > clamav.env <<EOF
# FreshClam (signature updates)
CLAMAV_NO_FRESHCLAMD=false
FRESHCLAM_CHECKS=12  # 12 checks per day = every 2 hours

# Clamd (scanner daemon)
CLAMD_STARTUP_TIMEOUT=1800
CLAMD_CONF_MaxScanSize=150M
CLAMD_CONF_MaxFileSize=30M
CLAMD_CONF_StreamMaxLength=30M
CLAMD_CONF_MaxThreads=12
CLAMD_CONF_MaxConnectionQueueLength=30

# Performance tuning
CLAMD_CONF_SelfCheck=600
CLAMD_CONF_IdleTimeout=60
EOF

# Run container with config file
docker run -d \
  --name clamav \
  --restart unless-stopped \
  -p 3310:3310 \
  -v clamav-db:/var/lib/clamav \
  --env-file clamav.env \
  clamav/clamav:stable
```

### Common Configuration Options

| Variable | Default | Description |
|----------|---------|-------------|
| `CLAMAV_NO_FRESHCLAMD` | `false` | Disable automatic signature updates |
| `FRESHCLAM_CHECKS` | `12` | Checks per day (1-50): 2 checks = every 12 hours, 4 checks = every 6 hours, 12 checks = every 2 hours |
| `CLAMD_STARTUP_TIMEOUT` | `1800` | Seconds to wait for first startup |
| `CLAMD_CONF_MaxScanSize` | `150M` | Maximum archive scan size |
| `CLAMD_CONF_MaxFileSize` | `30M` | Maximum file size to scan |
| `CLAMD_CONF_StreamMaxLength` | `25M` | Maximum stream length (should match plugin max size) |
| `CLAMD_CONF_MaxThreads` | `12` | Concurrent scanning threads |
| `CLAMD_CONF_TCPAddr` | `0.0.0.0` | TCP listen address |
| `CLAMD_CONF_TCPSocket` | `3310` | TCP listen port |
| `CLAMD_CONF_DetectPUA` | `no` | Disable PUA detection (recommended) |
| `CLAMD_CONF_LogVerbose` | `yes` | Enable verbose logging |
| `CLAMD_CONF_Debug` | `yes` | Enable debug logging |
| `CLAMD_CONF_LogClean` | `yes` | Log clean files (helps troubleshooting) |

### Custom Configuration Files

Mount custom configuration files into container:

```bash
# Create custom clamd.conf
cat > clamd.conf <<EOF
TCPSocket 3310
TCPAddr 127.0.0.1
MaxThreads 12
MaxConnectionQueueLength 30
MaxScanSize 150M
MaxFileSize 30M
StreamMaxLength 25M
SelfCheck 600
IdleTimeout 60

# IMPORTANT: Disable PUA detection (recommended for malware-scan plugin)
# Focus on real malware only, not potentially unwanted applications
DetectPUA no

# Logging (verbose mode for troubleshooting)
LogTime yes
LogVerbose yes
Debug yes
LogClean yes

# 24/7 Availability: Enable concurrent reload (no scanning interruption)
ConcurrentDatabaseReload yes
EOF

# Create custom freshclam.conf
cat > freshclam.conf <<EOF
DatabaseMirror database.clamav.net
Checks 12
LogSyslog no
LogVerbose yes
DatabaseDirectory /var/lib/clamav

# Database testing enabled for reliability
TestDatabases yes
EOF

# Run with custom configs
docker run -d \
  --name clamav \
  --restart unless-stopped \
  -p 3310:3310 \
  -v clamav-db:/var/lib/clamav \
  -v $(pwd)/clamd.conf:/etc/clamav/clamd.conf:ro \
  -v $(pwd)/freshclam.conf:/etc/clamav/freshclam.conf:ro \
  clamav/clamav:stable
```

### Important: Disable PUA Detection (Recommended)

By default, ClamAV may detect PUA (Potentially Unwanted Applications). For malware scanning purposes with the malware-scan plugin, it's **strongly recommended** to disable PUA detection to focus only on real malware threats.

**Why disable PUA detection?**

- **False Positives**: PUA can include legitimate software that users may intentionally want to use
- **Threat Intelligence**: Sharing examples and threat intelligence should only be done for real malware, not for PUA
- **Accurate Detection**: Flagging PUA could lead to unnecessary blocking of legitimate files
- **Focus**: Ensures only actual malicious threats are detected and reported

**Configuration:**

The `DetectPUA no` setting is included in all configuration examples in this guide. When using custom configuration files, always ensure this line is present:

```bash
# In clamd.conf
DetectPUA no
```

Or via environment variable:

```bash
docker run -d \
  --name clamav \
  -e CLAMD_CONF_DetectPUA=no \
  clamav/clamav:stable
```

**Verification:**

After starting ClamAV, verify PUA detection is disabled:

```bash
docker exec clamav grep DetectPUA /etc/clamav/clamd.conf
```

Expected output:
```
DetectPUA no
```

## Memory Optimization

### Understanding ClamAV Memory Usage

ClamAV requires significant RAM for signature databases:

- **Base Memory**: ~1.5-2GB for signature databases loaded into RAM
- **Concurrent Reload**: +1.5-2GB during signature updates (double memory)
- **Scanning Overhead**: ~500MB for active scanning operations
- **Total Peak Usage**: ~3.5-4GB during database reloads

### Default Configuration: Concurrent Reload Enabled

**The automated installation script enables concurrent reload by default for 24/7 availability.**

```bash
# In clamd.conf (default in this guide)
ConcurrentDatabaseReload yes
```

**Benefits:**
- **24/7 Availability**: ClamAV socket remains available during database updates
- **No Interruption**: Scanning continues uninterrupted during signature updates
- **Zero Downtime**: No ~30-second gap when clamd is unavailable
- **Production Ready**: Suitable for high-availability environments

**Memory Requirement:**
- **Peak Usage**: ~4GB during database reload
- **Normal Usage**: ~2GB after reload completes

### Alternative: Memory-Constrained Configuration (Not Recommended)

If you have limited RAM (3GB), you can disable concurrent reload:

**Trade-off**: Scanning unavailable for ~30 seconds during database updates

```bash
# Add to clamd.conf
ConcurrentDatabaseReload no

# Benefit: Reduces peak memory usage from ~4GB to ~2.5GB
```

**Effect:**
- ClamAV unloads old databases before loading new ones
- Memory usage: ~2.5GB peak instead of ~4GB
- **Downside**: TCP socket unavailable during ~30-second reload window
- **Not suitable** for BunkerWeb integration requiring 24/7 availability

### Alternative Optimization: Limit Scan Sizes

**Trade-off**: Very large files won't be scanned completely

```bash
# Add to clamd.conf or use environment variables
cat >> clamd.conf <<EOF
MaxScanSize 100M
MaxFileSize 25M
StreamMaxLength 25M
MaxRecursion 10
EOF

# Or via environment variables
docker run -d \
  --name clamav \
  -e CLAMD_CONF_MaxScanSize=100M \
  -e CLAMD_CONF_MaxFileSize=25M \
  -e CLAMD_CONF_StreamMaxLength=25M \
  clamav/clamav:stable
```

### Recommended Configuration for 24/7 Availability

```bash
# clamd.conf - Production configuration with 24/7 availability
cat > clamd.conf <<EOF
TCPSocket 3310
TCPAddr 127.0.0.1
MaxThreads 12
MaxConnectionQueueLength 30
MaxScanSize 150M
MaxFileSize 30M
StreamMaxLength 25M
SelfCheck 600
IdleTimeout 60

# IMPORTANT: Disable PUA detection (recommended)
DetectPUA no

# Logging (verbose mode for troubleshooting)
LogTime yes
LogVerbose yes
Debug yes
LogClean yes

# 24/7 Availability: Enable concurrent reload (no scanning interruption)
ConcurrentDatabaseReload yes
EOF

# freshclam.conf - Production configuration
cat > freshclam.conf <<EOF
DatabaseMirror database.clamav.net
Checks 12
LogSyslog no
LogVerbose yes
DatabaseDirectory /var/lib/clamav

# Database testing enabled for reliability
TestDatabases yes
EOF

# Run with memory limits and production configs
docker run -d \
  --name clamav \
  --restart unless-stopped \
  --memory="4g" \
  --memory-swap="4g" \
  -p 3310:3310 \
  -v clamav-db:/var/lib/clamav \
  -v $(pwd)/clamd.conf:/etc/clamav/clamd.conf:ro \
  -v $(pwd)/freshclam.conf:/etc/clamav/freshclam.conf:ro \
  clamav/clamav:stable
```

**Expected Memory Usage:**
- **Idle**: ~2GB
- **Scanning**: ~2.5GB
- **Database Reload**: ~4GB (with `ConcurrentDatabaseReload yes`)
- **Benefit**: Socket available 24/7, no downtime during updates

## Testing ClamAV

### 1. Verify Container is Running

```bash
# Check container status
docker ps | grep clamav

# Check container health
docker inspect clamav | grep Status

# View recent logs
docker logs --tail 50 clamav
```

### 2. Test TCP Socket Connection

```bash
# Install netcat if not available
sudo apt install -y netcat-openbsd

# Test TCP connection to clamd
echo "PING" | nc localhost 3310

# Expected response: "PONG"
```

### 3. Test EICAR Test File

EICAR is a harmless test file designed to trigger antivirus detection:

```bash
# Create EICAR test file
cat > eicar.txt <<'EOF'
X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
EOF

# Scan using clamdscan (from host)
# Install clamav-daemon package for clamdscan tool
sudo apt install -y clamav-daemon

# Configure clamdscan to use Docker container
sudo tee /etc/clamav/clamd.conf <<EOF
TCPSocket 3310
TCPAddr localhost
EOF

# Scan EICAR file
clamdscan eicar.txt

# Expected output:
# eicar.txt: Eicar-Signature FOUND
# ----------- SCAN SUMMARY -----------
# Infected files: 1
```

### 4. Test Using Docker Exec

```bash
# Scan file inside container
docker exec clamav clamdscan /tmp/eicar.txt

# Check ClamAV version
docker exec clamav clamconf -V

# Check loaded signature count
docker exec clamav sigtool --info=/var/lib/clamav/main.cvd
```

## Integration with BunkerWeb

### Prerequisites

- BunkerWeb installed and running
- ClamAV Docker container running on same host
- BunkerWeb malware-scan plugin enabled

### Configuration

Edit BunkerWeb environment variables:

```bash
# Enable malware scanning
USE_MALWARE_SCANNER=yes

# ClamAV Configuration
MALWARE_SCAN_CLAMAV_ENABLED=yes
MALWARE_SCAN_CLAMAV_HOST=localhost
MALWARE_SCAN_CLAMAV_PORT=3310
MALWARE_SCAN_CLAMAV_TIMEOUT=10000
MALWARE_SCAN_CLAMAV_MAX_SIZE=26214400  # 25MB, must match ClamAV StreamMaxLength

# Debugging (optional)
MALWARE_SCAN_DEBUG=yes
LOG_LEVEL=info
```

**Important**: The `MALWARE_SCAN_CLAMAV_MAX_SIZE` setting (default: 26214400 bytes = 25MB) must match or be less than ClamAV's `StreamMaxLength` configuration (default: 25M). If these values don't match, files between the two limits may fail to scan properly.

### Docker Compose Integration

If running BunkerWeb with Docker Compose:

```yaml
version: '3.8'

services:
  # ClamAV Service
  clamav:
    image: clamav/clamav:stable
    container_name: clamav
    restart: unless-stopped
    networks:
      - bunkerweb-net
    ports:
      - "3310:3310"
    volumes:
      - clamav-db:/var/lib/clamav
    environment:
      - CLAMAV_NO_FRESHCLAMD=false
      - CLAMD_STARTUP_TIMEOUT=1800
      - FRESHCLAM_CHECKS=12  # 12 checks per day = every 2 hours
    deploy:
      resources:
        limits:
          memory: 4g
        reservations:
          memory: 2g

  # BunkerWeb Service
  bunkerweb:
    image: bunkerity/bunkerweb:latest
    container_name: bunkerweb
    restart: unless-stopped
    networks:
      - bunkerweb-net
    ports:
      - "80:8080"
      - "443:8443"
    environment:
      # Malware Scanner Configuration
      - USE_MALWARE_SCANNER=yes
      - MALWARE_SCAN_CLAMAV_ENABLED=yes
      - MALWARE_SCAN_CLAMAV_HOST=clamav
      - MALWARE_SCAN_CLAMAV_PORT=3310
      - MALWARE_SCAN_CLAMAV_TIMEOUT=10000
      - MALWARE_SCAN_CLAMAV_MAX_SIZE=26214400  # 25MB, matches StreamMaxLength
      # Other BunkerWeb settings...
    depends_on:
      - clamav

networks:
  bunkerweb-net:
    driver: bridge

volumes:
  clamav-db:
    driver: local
```

```bash
# Check BunkerWeb logs
docker logs bunkerweb | grep -i malware

# Check ClamAV logs
docker logs clamav | grep -i eicar
```

## Troubleshooting

### Installation Script Detects Existing ClamAV

**Problem**: Script exits with message "ClamAV is already running on port 3310"

**Cause**: Another ClamAV instance (Docker container or system service) is already running

**Solution**:

```bash
# Check what's running on port 3310
sudo netstat -tlnp | grep 3310
# or
sudo ss -tlnp | grep 3310

# If it's a Docker container:
docker ps | grep clamav
docker stop clamav
docker rm clamav

# If it's a system service (most common):
# Disable the system ClamAV service and socket
systemctl status clamav-daemon
systemctl stop clamav-daemon
systemctl disable clamav-daemon

# Also disable freshclam if running as a service
systemctl stop clamav-freshclam || true
systemctl disable clamav-freshclam || true

# Verify the port is now free
sudo ss -tlnp | grep 3310

# Then run the installation script again
sudo ./install-docker-clamav.sh
```

**Important Note on System ClamAV Service**:

On Debian/Ubuntu systems, ClamAV may be installed as a system package with automatic service startup. The Docker installation script will detect this and prompt you to continue or exit.

**To permanently disable the system ClamAV service:**

```bash
# Stop all ClamAV services
sudo systemctl stop clamav-daemon
sudo systemctl stop clamav-freshclam

# Disable from auto-start
sudo systemctl disable clamav-daemon
sudo systemctl disable clamav-freshclam

# Remove system ClamAV package (optional, but recommended for clean Docker-only setup)
sudo apt remove clamav clamav-daemon clamav-freshclam -y

# Verify port 3310 is now free
sudo ss -tlnp | grep 3310  # Should return nothing

# Now run the Docker installation script
sudo ./install-docker-clamav.sh
```

**Why use Docker instead of system service?**
- **Isolation**: ClamAV runs in isolated container, doesn't interfere with system packages
- **Easy updates**: Pull new Docker image instead of package manager updates
- **Simplified uninstall**: Just `docker rm clamav` to remove everything
- **Better resource management**: Memory limits prevent system crashes
- **Consistent across systems**: Same image runs on all OS versions

### Port 3310 in Use by Systemd Socket

**Problem**: Script says "Port 3310 is in use but not responding as ClamAV" and `netstat` shows init process listening:
```
tcp        0      0 127.0.0.1:3310          0.0.0.0:*               LISTEN      1/init
```

**Cause**: ClamAV is installed as a system package with systemd socket activation. The init process (systemd) is listening on the socket and will spawn the ClamAV daemon on-demand.

**Solution**:

```bash
# Disable all ClamAV systemd sockets and services
sudo systemctl stop clamav.socket
sudo systemctl disable clamav.socket

sudo systemctl stop clamav-daemon.socket || true
sudo systemctl disable clamav-daemon.socket || true

# Stop any running ClamAV services
sudo systemctl stop clamav-daemon
sudo systemctl stop clamav-freshclam

# Disable services
sudo systemctl disable clamav-daemon
sudo systemctl disable clamav-freshclam

# Verify socket is released (may take a moment)
sleep 2
sudo ss -tlnp | grep 3310  # Should return nothing now

# Run the installation script again
sudo ./install-docker-clamav.sh
```

**Alternative: Remove system ClamAV completely**

If you want a clean break from system ClamAV:

```bash
# Stop all services and sockets
sudo systemctl stop clamav.socket clamav-daemon.socket clamav-daemon clamav-freshclam 2>/dev/null || true

# Disable all ClamAV systemd units
sudo systemctl disable clamav.socket clamav-daemon.socket clamav-daemon clamav-freshclam 2>/dev/null || true

# Uninstall ClamAV packages
sudo apt remove -y clamav clamav-daemon clamav-freshclam clamav-base

# Remove ClamAV configuration directories
sudo rm -rf /etc/clamav /var/lib/clamav

# Verify port is free
sudo ss -tlnp | grep 3310

# Now install Docker ClamAV
sudo ./install-docker-clamav.sh
```

### Port 3310 in Use by Init but No ClamAV Units Found

**Problem**: `netstat` shows init process listening on port 3310, but ClamAV systemd units don't exist:
```bash
tcp        0      0 127.0.0.1:3310          0.0.0.0:*               LISTEN      1/init
# and...
Failed to stop clamavd.service: Unit clamavd.service not loaded.
```

**Cause**: This typically indicates a leftover socket file or a previous ClamAV installation's artifacts. The init process (PID 1/systemd) has inherited the socket binding but there's no active service managing it.

**Solution**:

```bash
# 1. Use lsof to see exactly what has the port open
sudo lsof -i :3310

# 2. Look for socket files left behind
sudo find /var/run -name "*clamav*" -o -name "*clamd*" 2>/dev/null
sudo find /tmp -name "*clamav*" -o -name "*clamd*" 2>/dev/null
sudo find /var/lib -path "*clamav*" -type s 2>/dev/null

# 3. Remove any leftover socket files
sudo rm -f /var/run/clamav/clamd.ctl
sudo rm -f /var/run/clamav/clamd.sock
sudo rm -f /tmp/clamd.sock

# 4. Remove leftover ClamAV package (if installed)
sudo apt remove -y clamav clamav-daemon clamav-freshclam clamav-base 2>/dev/null || true

# 5. Clean up ClamAV directories
sudo rm -rf /etc/clamav
sudo rm -rf /var/lib/clamav

# 6. Force release the port by restarting systemd
# (last resort if socket persists)
sudo systemctl daemon-reload

# 7. Verify port is now free
sleep 1
sudo ss -tlnp | grep 3310  # Should return nothing

# 8. Now run the installation script
sudo ./install-docker-clamav.sh
```

**If clamd process is actually running (found via lsof):**

If `lsof -i :3310` shows clamd process is holding the socket:
```bash
# Kill the clamd daemon directly using the PID from lsof output
# From lsof output: clamd   804923 clamav  4u  IPv4   2919      0t0  TCP localhost:3310 (LISTEN)
sudo kill 804923  # Replace 804923 with the actual PID from your lsof output

# Or kill all clamd processes:
sudo kill $(pgrep clamd) 2>/dev/null || true

# If it doesn't stop gracefully, force kill it:
sudo kill -9 $(pgrep clamd) 2>/dev/null || true

# Wait for cleanup
sleep 2

# Verify port is now free
sudo ss -tlnp | grep 3310  # Should now only show systemd or be empty

# Clean up remaining artifacts
sudo rm -rf /var/run/clamav
sudo rm -rf /tmp/clamd.*

# Reload systemd to clear socket binding
sudo systemctl daemon-reload

# Verify port is completely free
sleep 1
sudo ss -tlnp | grep 3310  # Should return nothing now

# Run the installation script
sudo ./install-docker-clamav.sh
```

**Complete ClamAV Uninstall (Recommended for Docker-only setup)**

To completely remove system ClamAV and free up port 3310:

```bash
# 1. Stop and kill any running clamd processes
sudo kill -9 $(pgrep clamd) 2>/dev/null || true
sudo kill -9 $(pgrep freshclam) 2>/dev/null || true

# 2. Stop systemd services and sockets
sudo systemctl stop clamav-daemon clamav-freshclam 2>/dev/null || true
sudo systemctl stop clamav.socket clamav-daemon.socket 2>/dev/null || true

# 3. Disable from auto-start
sudo systemctl disable clamav-daemon clamav-freshclam 2>/dev/null || true
sudo systemctl disable clamav.socket clamav-daemon.socket 2>/dev/null || true

# 4. Uninstall ClamAV packages
sudo apt remove -y clamav clamav-daemon clamav-freshclam clamav-base 2>/dev/null || true

# 5. Remove ClamAV configuration and data directories
sudo rm -rf /etc/clamav
sudo rm -rf /var/lib/clamav
sudo rm -rf /var/run/clamav
sudo rm -rf /tmp/clamd*

# 6. Clean up package manager
sudo apt autoclean
sudo apt autoremove

# 7. Reload systemd to clear all socket bindings
sudo systemctl daemon-reload

# 8. Verify port 3310 is completely free
sleep 2
sudo ss -tlnp | grep 3310  # Should return nothing

# 9. Now run the Docker installation script
sudo ./install-docker-clamav.sh
```

**If port still shows as in use after all cleanup:**

```bash
# The socket may be stuck in the kernel. Reboot required.
sudo reboot

# After reboot, verify:
sudo ss -tlnp | grep 3310  # Should be empty

# Then run installation:
sudo ./install-docker-clamav.sh
```

### Syslog Logging Driver Not Available

**Problem**: Docker fails with "protocol wrong type for socket" when starting container:
```
docker: Error response from daemon: failed to create task for container: failed to initialize logging driver: dial unix /dev/log: connect: protocol wrong type for socket
```

**Cause**: The syslog logging driver is not available on this system (common on minimal Debian/Alpine installations).

**Solution**: The installation script has already created the container but failed on logging setup. Restart without syslog logging:

```bash
# Stop the failed container
docker stop clamav 2>/dev/null || true
docker rm clamav 2>/dev/null || true

# Start container with default json-file logging instead
docker run -d \
  --name clamav \
  --restart unless-stopped \
  --memory="4g" \
  --memory-swap="4g" \
  -p 3310:3310 \
  -v clamav-db:/var/lib/clamav \
  -e CLAMAV_NO_FRESHCLAMD=false \
  -e CLAMD_STARTUP_TIMEOUT=1800 \
  -e FRESHCLAM_CHECKS=12 \
  clamav/clamav:stable

# Check if it started
sleep 5
docker ps | grep clamav

# View logs
docker logs clamav
```

**Note**: With the default json-file logging driver, use `docker logs clamav` to view logs instead of `journalctl`. If you prefer syslog logging, see the **Send Logs to Host Syslog** section below.

### Container Won't Start

**Problem**: Container exits immediately after starting

```bash
# Check container logs
docker logs clamav

# Common causes:
# 1. Port 3310 already in use
sudo netstat -tulpn | grep 3310

# 2. Insufficient memory
free -h

# 3. Permission issues with volume
docker volume inspect clamav-db
```

**Solution**:
```bash
# Remove existing container and volume
docker stop clamav
docker rm clamav
docker volume rm clamav-db

# Recreate with correct configuration
docker volume create clamav-db
docker run -d --name clamav -p 3310:3310 \
  -v clamav-db:/var/lib/clamav \
  clamav/clamav:stable
```

### Database Download Fails

**Problem**: FreshClam can't download signature databases

```bash
# Check logs
docker logs clamav | grep -i freshclam

# Common error: "Can't download daily.cvd"
```

**Solution**:
```bash
# 1. Check internet connectivity
docker exec clamav ping -c 3 database.clamav.net

# 2. Try alternative mirror
docker run -d --name clamav \
  -e FRESHCLAM_MIRRORS=https://database.clamav.net \
  clamav/clamav:stable

# 3. Manual database download
docker exec clamav freshclam --verbose
```

### High Memory Usage

**Problem**: Container using more than 4GB RAM

```bash
# Check memory usage
docker stats clamav

# Check concurrent reload setting
docker exec clamav grep ConcurrentDatabaseReload /etc/clamav/clamd.conf
```

**Expected Behavior**:
- With `ConcurrentDatabaseReload yes` (default): Peak ~4GB during database updates, normal ~2GB
- This is **intentional** for 24/7 availability

**If Memory is Critical Issue**:

Only if you can tolerate ~30-second scanning interruption during updates:

```bash
# Stop container
docker stop clamav

# Create memory-constrained config (NOT RECOMMENDED for production)
cat > clamd.conf <<EOF
ConcurrentDatabaseReload no
EOF

# Recreate with lower memory limits
docker run -d --name clamav \
  --memory="3g" --memory-swap="3g" \
  -v $(pwd)/clamd.conf:/etc/clamav/clamd.conf:ro \
  clamav/clamav:stable
```

**Trade-off**: ClamAV socket will be unavailable for ~30 seconds during signature updates (not suitable for BunkerWeb integration).

### TCP Connection Refused

**Problem**: Can't connect to clamd TCP socket

```bash
# Test connection
echo "PING" | nc localhost 3310
# Error: Connection refused
```

**Solution**:
```bash
# 1. Verify container is running and ready
docker logs clamav | tail -20

# Look for: "clamd[1]: Self checking every 600 seconds"

# 2. Check if port is exposed
docker port clamav

# 3. Verify clamd is listening
docker exec clamav netstat -tulpn | grep 3310

# 4. Check firewall rules
sudo iptables -L -n | grep 3310
```

### ClamAV Not Detecting EICAR

**Problem**: EICAR test file not detected as malware

```bash
# Verify signature databases are loaded
docker exec clamav sigtool --info=/var/lib/clamav/main.cvd

# Check if EICAR signature exists
docker exec clamav grep -r "Eicar" /var/lib/clamav/
```

**Solution**:
```bash
# Force database update
docker exec clamav freshclam --verbose

# Restart container
docker restart clamav

# Wait for startup
docker logs -f clamav

# Test again
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' | \
  docker exec -i clamav clamdscan -
```

### Scanning Timeouts with BunkerWeb

**Problem**: Malware scan timeouts with large files

```bash
# BunkerWeb logs show:
# [MALWARE-SCAN] ClamAV scan timeout after 30000ms
```

**Solution**:
```bash
# Increase timeout in BunkerWeb configuration
MALWARE_SCAN_CLAMAV_TIMEOUT=60000

# Reduce file size limits in ClamAV
docker stop clamav

cat > clamd.conf <<EOF
MaxScanSize 100M
MaxFileSize 25M
StreamMaxLength 25M
MaxRecursion 10
EOF

docker run -d --name clamav \
  -v $(pwd)/clamd.conf:/etc/clamav/clamd.conf:ro \
  clamav/clamav:stable
```

## Container Management

### Docker Log Storage

By default, Docker stores container logs in:
```
/var/lib/docker/containers/<container-id>/<container-id>-json.log
```

To find your ClamAV container's log file:
```bash
# Get container ID
docker inspect clamav --format='{{.Id}}'

# View log file location
docker inspect clamav --format='{{.LogPath}}'

# View log file directly
sudo cat $(docker inspect clamav --format='{{.LogPath}}')
```

### View Container Logs

**Note**: If you used the automated installation script (`install-docker-clamav.sh`), json-file logging is used by default (most compatible). Use `docker logs -f clamav` to view logs. If you customized the installation with syslog driver, use `sudo journalctl -t clamav -f` instead.

```bash
# Follow logs in real-time
docker logs -f clamav

# Show last 100 lines
docker logs --tail 100 clamav

# Show logs with timestamps
docker logs -t clamav

# Filter for errors only
docker logs clamav 2>&1 | grep -i error
```

### Send Logs to Host Syslog

To send ClamAV container logs to the host's syslog daemon, use the `syslog` logging driver:

#### Option 1: Using docker run

```bash
docker run -d \
  --name clamav \
  --restart unless-stopped \
  --memory="3g" \
  --memory-swap="3g" \
  -p 3310:3310 \
  -v clamav-db:/var/lib/clamav \
  --log-driver=syslog \
  --log-opt syslog-address=unix:///dev/log \
  --log-opt tag="clamav" \
  clamav/clamav:stable
```

**Log Options:**
- `--log-driver=syslog` - Use syslog logging driver
- `--log-opt syslog-address=unix:///dev/log` - Send to host's syslog socket (default)
- `--log-opt tag="clamav"` - Tag logs with "clamav" identifier
- `--log-opt syslog-facility=daemon` - Optional: Set syslog facility (default: daemon)

#### Option 2: Using docker-compose.yml

```yaml
version: '3.8'

services:
  clamav:
    image: clamav/clamav:stable
    container_name: clamav
    restart: unless-stopped
    ports:
      - "3310:3310"
    volumes:
      - clamav-db:/var/lib/clamav
      - /DATA/clamav/config/clamd.conf:/etc/clamav/clamd.conf:ro
      - /DATA/clamav/config/freshclam.conf:/etc/clamav/freshclam.conf:ro
    logging:
      driver: syslog
      options:
        syslog-address: "unix:///dev/log"
        tag: "clamav"
        syslog-facility: "daemon"
    environment:
      - CLAMAV_NO_FRESHCLAMD=false
      - CLAMD_STARTUP_TIMEOUT=1800
    deploy:
      resources:
        limits:
          memory: 4g
        reservations:
          memory: 2g

volumes:
  clamav-db:
    driver: local
```

#### Option 3: Send to Remote Syslog Server

```bash
docker run -d \
  --name clamav \
  --log-driver=syslog \
  --log-opt syslog-address=tcp://192.168.1.100:514 \
  --log-opt tag="clamav" \
  clamav/clamav:stable
```

**Remote syslog addresses:**
- `tcp://hostname:port` - TCP connection
- `udp://hostname:port` - UDP connection (default port: 514)
- `tcp+tls://hostname:port` - TLS-encrypted TCP

### View Syslog Logs

After configuring syslog logging, view ClamAV logs through your system's syslog:

```bash
# For systemd systems (journald)
sudo journalctl -t clamav -f

# For traditional syslog
sudo tail -f /var/log/syslog | grep clamav

# Or check /var/log/messages on some systems
sudo tail -f /var/log/messages | grep clamav
```

### Send Logs to Systemd Journal

Alternative to syslog, use the `journald` driver to integrate with systemd:

```bash
docker run -d \
  --name clamav \
  --log-driver=journald \
  --log-opt tag="clamav" \
  clamav/clamav:stable

# View logs via journalctl
sudo journalctl CONTAINER_NAME=clamav -f

# Or by container ID
sudo journalctl CONTAINER_ID=$(docker inspect clamav --format='{{.Id}}') -f
```

**Note**: When using `syslog` or `journald` drivers, `docker logs` command will not work. Use `journalctl` or syslog viewers instead.

### Update ClamAV

```bash
# Pull latest stable image
docker pull clamav/clamav:stable

# Stop and remove old container
docker stop clamav
docker rm clamav

# Run new container with same volume (preserves databases)
docker run -d \
  --name clamav \
  --restart unless-stopped \
  -p 3310:3310 \
  -v clamav-db:/var/lib/clamav \
  clamav/clamav:stable
```

### Backup Signature Databases

```bash
# Create backup directory
mkdir -p ~/clamav-backups

# Backup database volume
docker run --rm \
  -v clamav-db:/data \
  -v ~/clamav-backups:/backup \
  alpine tar czf /backup/clamav-db-$(date +%Y%m%d).tar.gz /data

# Verify backup
ls -lh ~/clamav-backups/
```

### Restore Signature Databases

```bash
# Stop ClamAV container
docker stop clamav

# Restore from backup
docker run --rm \
  -v clamav-db:/data \
  -v ~/clamav-backups:/backup \
  alpine tar xzf /backup/clamav-db-20260127.tar.gz -C /

# Start ClamAV container
docker start clamav
```

### Remove ClamAV Completely

```bash
# Stop and remove container
docker stop clamav
docker rm clamav

# Remove database volume (WARNING: Deletes all signature data)
docker volume rm clamav-db

# Remove image
docker rmi clamav/clamav:stable

# Clean up configuration files
rm -f clamd.conf freshclam.conf clamav.env
```

## Additional Resources

- **Official ClamAV Documentation**: https://docs.clamav.net/
- **ClamAV Docker Hub**: https://hub.docker.com/r/clamav/clamav
- **ClamAV GitHub Repository**: https://github.com/Cisco-Talos/clamav
- **BunkerWeb Documentation**: https://docs.bunkerweb.io/
- **BunkerWeb Malware-Scan Plugin**: https://github.com/bunkerity/bunkerweb-plugins

## License

ClamAV is licensed under the GNU General Public License v2.0. See the [ClamAV license](https://github.com/Cisco-Talos/clamav/blob/main/COPYING) for details.

## Support

For ClamAV issues:
- ClamAV Users Mailing List: https://www.clamav.net/contact.html#ml
- ClamAV GitHub Issues: https://github.com/Cisco-Talos/clamav/issues

For BunkerWeb integration issues:
- BunkerWeb GitHub Issues: https://github.com/bunkerity/bunkerweb/issues
- BunkerWeb Discord: https://discord.gg/bunkerweb

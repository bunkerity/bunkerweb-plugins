# ClamAV Installation for Network Scanning

This guide explains how to install and configure ClamAV as a network scanner that listens on `127.0.0.1:3310` for the malware-scan plugin.

## Installation

Install ClamAV daemon and the core ClamAV package:

```bash
apt-get install -y clamav-daemon clamav
```

This will install:
- `clamav-daemon`: The ClamAV daemon (clamd) that provides network scanning capabilities
- `clamav`: Core ClamAV package with virus definitions

## Configuration

To enable ClamAV to listen on `127.0.0.1:3310`, you need to configure the systemd socket. Edit `/lib/systemd/system/clamav-daemon.socket`:

```bash
# Check if ListenStream is already configured
grep -q "^ListenStream=127.0.0.1:3310" /lib/systemd/system/clamav-daemon.socket || \
  sed -i '/\[Socket\]/a ListenStream=127.0.0.1:3310' /lib/systemd/system/clamav-daemon.socket
```

The socket file should contain:

```ini
[Unit]
Description=Socket for Clam AntiVirus userspace daemon
Documentation=man:clamd(8) man:clamd.conf(5) https://docs.clamav.net/
ConditionPathExistsGlob=/var/lib/clamav/main.{c[vl]d,inc}
ConditionPathExistsGlob=/var/lib/clamav/daily.{c[vl]d,inc}

[Socket]
ListenStream=/run/clamav/clamd.ctl
ListenStream=127.0.0.1:3310
SocketUser=clamav
SocketGroup=clamav
RemoveOnStop=True

[Install]
WantedBy=sockets.target
```

After modifying the socket file, reload systemd and restart the service:

```bash
systemctl daemon-reload
systemctl restart clamav-daemon
```

### Disable PUA Detection (Recommended)

By default, ClamAV may detect PUA (Potentially Unwanted Applications). For malware scanning purposes, it's recommended to disable PUA detection to focus only on real malware threats.

**Important**: Sharing examples and threat intelligence should only be done for real malware, not for PUA. PUA can include legitimate software that users may intentionally want to use, and flagging these could lead to false positives and unnecessary blocking. By disabling PUA detection, you ensure that only actual malicious threats are detected and reported.

Check if PUA detection is enabled:

```bash
grep "^DetectPUA" /etc/clamav/clamd.conf
```

If `DetectPUA` is set to `yes`, disable it:

```bash
# Disable PUA detection if enabled
sed -i 's/^DetectPUA yes/DetectPUA no/' /etc/clamav/clamd.conf

# Or ensure it's explicitly disabled if the line doesn't exist
grep -q "^DetectPUA" /etc/clamav/clamd.conf || echo "DetectPUA no" >> /etc/clamav/clamd.conf
```

Verify your configuration:

```bash
clamconf | grep "DetectPUA"
```

Expected output:
```
DetectPUA disabled
```

After changing this setting, restart the daemon:

```bash
systemctl restart clamav-daemon
```

## Testing the Installation

Verify that ClamAV is listening on the correct port by sending a PING command:

```bash
echo "PING" | nc 127.0.0.1 3310
```

Expected response:
```
PONG
```

If you receive `PONG`, ClamAV is correctly installed and listening on the network socket.

## Updating Virus Definitions

To ensure ClamAV has the latest virus definitions, run:

```bash
freshclam
```

You can also enable automatic updates by ensuring the `clamav-freshclam` service is running:

```bash
systemctl enable clamav-freshclam
systemctl start clamav-freshclam
```

## Troubleshooting

If the service is not responding:

1. Check the service status:
   ```bash
   systemctl status clamav-daemon
   ```

2. Check if the port is listening:
   ```bash
   netstat -tlnp | grep 3310
   ```

3. Review logs for errors:
   ```bash
   journalctl -u clamav-daemon -n 50
   ```

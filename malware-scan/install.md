# ClamAV Installation for Network Scanning

This guide explains how to install and configure ClamAV as a network scanner that listens on `127.0.0.1:3310` for the malware-scan plugin.

## Quick Installation (Automated)

For a quick automated installation on Debian 13, Ubuntu, Red Hat, CentOS, Rocky Linux, or AlmaLinux, run:

```bash
chmod +x install.sh
sudo ./install.sh
```

The script will automatically:
- Install ClamAV packages
- Configure the systemd socket for network listening on 127.0.0.1:3310
- Disable PUA detection (focus on real malware only)
- Update virus definitions
- Test the installation

## Manual Installation

### Package Installation

Install ClamAV daemon and the core ClamAV package:

**Debian/Ubuntu:**
```bash
apt-get install -y clamav-daemon clamav
```

**Red Hat/CentOS/Rocky/AlmaLinux:**
```bash
# Enable EPEL repository if needed
yum install -y epel-release
yum install -y clamav clamd clamav-update
```

This will install:
- `clamav-daemon` / `clamd`: The ClamAV daemon that provides network scanning capabilities
- `clamav`: Core ClamAV package with virus definitions

### Configuration

To enable ClamAV to listen on `127.0.0.1:3310`, you need to configure the systemd socket.

**Note:** Paths differ by distribution:
- Debian/Ubuntu: `/lib/systemd/system/clamav-daemon.socket` and `/etc/clamav/clamd.conf`
- Red Hat/CentOS: `/usr/lib/systemd/system/clamd@scan.socket` and `/etc/clamd.d/scan.conf`

#### Debian/Ubuntu Configuration

Edit `/lib/systemd/system/clamav-daemon.socket`:

```bash
# Check if ListenStream is already configured
grep -q "^ListenStream=127.0.0.1:3310" /lib/systemd/system/clamav-daemon.socket || \
  sed -i '/\[Socket\]/a ListenStream=127.0.0.1:3310' /lib/systemd/system/clamav-daemon.socket
```

The socket file should contain:

```ini
[Unit]
Description=Socket for Clam AntiVirus userspace daemon
Documentation=man:clamd(8) man:clamd.conf(5) https://docs.clamav.net/
ConditionPathExistsGlob=/var/lib/clamav/main.{c[vl]d,inc}
ConditionPathExistsGlob=/var/lib/clamav/daily.{c[vl]d,inc}

[Socket]
ListenStream=/run/clamav/clamd.ctl
ListenStream=127.0.0.1:3310
SocketUser=clamav
SocketGroup=clamav
RemoveOnStop=True

[Install]
WantedBy=sockets.target
```

After modifying the socket file, reload systemd and restart the service:

```bash
systemctl daemon-reload
systemctl restart clamav-daemon
```

#### Red Hat/CentOS Configuration

For Red Hat/CentOS systems, edit `/etc/clamd.d/scan.conf`:

```bash
# Comment out the Example line if present
sed -i 's/^Example/#Example/' /etc/clamd.d/scan.conf

# Add TCP socket configuration
grep -q "^TCPSocket" /etc/clamd.d/scan.conf || echo "TCPSocket 3310" >> /etc/clamd.d/scan.conf
grep -q "^TCPAddr" /etc/clamd.d/scan.conf || echo "TCPAddr 127.0.0.1" >> /etc/clamd.d/scan.conf
```

Configure the systemd socket at `/usr/lib/systemd/system/clamd@scan.socket`:

```bash
# Check if ListenStream is already configured
grep -q "^ListenStream=127.0.0.1:3310" /usr/lib/systemd/system/clamd@scan.socket || \
  sed -i '/\[Socket\]/a ListenStream=127.0.0.1:3310' /usr/lib/systemd/system/clamd@scan.socket
```

After modifying the configuration, reload systemd and restart the service:

```bash
systemctl daemon-reload
systemctl restart clamd@scan
```

### Disable PUA Detection (Recommended)

By default, ClamAV may detect PUA (Potentially Unwanted Applications). For malware scanning purposes, it's recommended to disable PUA detection to focus only on real malware threats.

**Important**: Sharing examples and threat intelligence should only be done for real malware, not for PUA. PUA can include legitimate software that users may intentionally want to use, and flagging these could lead to false positives and unnecessary blocking. By disabling PUA detection, you ensure that only actual malicious threats are detected and reported.

Check if PUA detection is enabled:

**Debian/Ubuntu:**
```bash
grep "^DetectPUA" /etc/clamav/clamd.conf
```

**Red Hat/CentOS:**
```bash
grep "^DetectPUA" /etc/clamd.d/scan.conf
```

If `DetectPUA` is set to `yes`, disable it:

**Debian/Ubuntu:**
```bash
# Disable PUA detection if enabled
sed -i 's/^DetectPUA yes/DetectPUA no/' /etc/clamav/clamd.conf

# Or ensure it's explicitly disabled if the line doesn't exist
grep -q "^DetectPUA" /etc/clamav/clamd.conf || echo "DetectPUA no" >> /etc/clamav/clamd.conf
```

**Red Hat/CentOS:**
```bash
# Disable PUA detection if enabled
sed -i 's/^DetectPUA yes/DetectPUA no/' /etc/clamd.d/scan.conf

# Or ensure it's explicitly disabled if the line doesn't exist
grep -q "^DetectPUA" /etc/clamd.d/scan.conf || echo "DetectPUA no" >> /etc/clamd.d/scan.conf
```

Verify your configuration:

```bash
clamconf | grep "DetectPUA"
```

Expected output:
```
DetectPUA disabled
```

After changing this setting, restart the daemon:

**Debian/Ubuntu:**
```bash
systemctl restart clamav-daemon
```

**Red Hat/CentOS:**
```bash
systemctl restart clamd@scan
```

## BunkerWeb Plugin Configuration

After ClamAV is installed and running, configure the BunkerWeb plugin by adding these variables to `/etc/bunkerweb/variables.env`:

### Basic Configuration (Copy-Paste Ready)

```bash
# Core Settings
MALWARE_SCAN_ENABLED=yes
MALWARE_SCAN_DEBUG=yes  # Enable until plugin is stable, then set to 'no'
MALWARE_SCAN_EXCLUDED_EXTENSIONS=jpg,jpeg,png,gif,bmp,ico,webp,mp3,mp4,avi,mov,wmv,flv,webm,ogg,wav,flac

# ClamAV Settings
MALWARE_SCAN_CLAMAV_HOST=127.0.0.1
MALWARE_SCAN_CLAMAV_PORT=3310
MALWARE_SCAN_CLAMAV_TIMEOUT=10000
MALWARE_SCAN_CLAMAV_MAX_SIZE=26214400        # 25MB
MALWARE_SCAN_HASH_MAX_SIZE=67108864          # 64MB

# File Handling
MALWARE_SCAN_BLOCK_MEMORY_UPLOADS=no
MALWARE_SCAN_CLEANUP_FILES=yes
MALWARE_SCAN_CLEANUP_ORPHANED=no
MALWARE_SCAN_CLEANUP_AGE=3600

# Caching
MALWARE_SCAN_CACHE_TTL=3600  # 1 hour

# VirusTotal Integration (Optional)
MALWARE_SCAN_USE_VIRUSTOTAL=no
MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT=yes    # Fast mode: skip cloud checks if ClamAV detects
MALWARE_SCAN_VIRUSTOTAL_API_KEY=your_api_key             # Required if enabled
MALWARE_SCAN_VIRUSTOTAL_SUSPICIOUS=5
MALWARE_SCAN_VIRUSTOTAL_MALICIOUS=3
MALWARE_SCAN_VT_UPLOAD_UNKNOWN=no
MALWARE_SCAN_VT_AUTO_VOTE=no
MALWARE_SCAN_VT_MAX_UPLOAD_SIZE=33554432     # 32MB
MALWARE_SCAN_SHARE_FILES=no                  # Share detected malware with threat intelligence

# ThreatFox Integration (Optional)
MALWARE_SCAN_USE_THREATFOX=no
MALWARE_SCAN_THREATFOX_API_KEY=your_api_key              # Required if enabled

# SentinelOne Integration (Optional)
MALWARE_SCAN_USE_SENTINELONE=no
MALWARE_SCAN_SENTINELONE_MANAGEMENT_URL=https://your-console.example.com     # Required if enabled
MALWARE_SCAN_SENTINELONE_API_TOKEN=your_api_key          # Required if enabled
```

### Configuration Notes

**Important Settings:**
- `MALWARE_SCAN_DEBUG=yes` - Keep enabled during initial testing. Generates verbose logs for troubleshooting. Set to `no` once stable.
- `MALWARE_SCAN_CLAMAV_MAX_SIZE=26214400` - Must match or be less than ClamAV's `StreamMaxLength` setting
- `MALWARE_SCAN_HASH_MAX_SIZE=67108864` - Prevents performance issues with large files (ISOs, VMs)

**Cloud Scanner Setup:**
- **VirusTotal**: Get free API key from https://www.virustotal.com/gui/join-us (4 req/min, 500 req/day)
- **ThreatFox**: Get free API key from https://auth.abuse.ch/ (community IOC database)
- **SentinelOne**: Requires SentinelOne license and management console access

**Performance Modes:**
- Fast Mode: `MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT=yes` (default) - Skip cloud checks if ClamAV detects
- Full Analysis: `MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT=no` - Always run all scanners for complete threat intelligence

**Threat Intelligence Sharing:**
- `MALWARE_SCAN_SHARE_FILES=yes` - Share malware detected by any scanner (ThreatFox, SentinelOne) with VirusTotal if the file is unknown to VT
- Helps improve global threat intelligence by contributing new malware samples
- Requires VirusTotal integration to be enabled
- Only real malware is shared, not PUA (Potentially Unwanted Applications)
- Files are automatically voted as malicious if `MALWARE_SCAN_VT_AUTO_VOTE=yes`

After updating variables, restart BunkerWeb:
```bash
systemctl restart bunkerweb
```

## Testing the Installation

### Basic Connectivity Test

Verify that ClamAV is listening on the correct port by sending a PING command:

```bash
echo "PING" | nc 127.0.0.1 3310
```

Expected response:
```
PONG
```

If you receive `PONG`, ClamAV is correctly installed and listening on the network socket.

### Malware Detection Test (EICAR)

To verify that ClamAV can detect malware, use the EICAR test file - a harmless test string recognized by all antivirus software.

**Download EICAR test files:**

Official source: https://www.eicar.org/download-anti-malware-testfile/

```bash
# Download EICAR test file (plain text)
wget https://secure.eicar.org/eicar.com -O eicar.com

# Or download the ZIP version
wget https://secure.eicar.org/eicar_com.zip -O eicar_com.zip
```

**Test with ClamAV:**

```bash
# Scan the EICAR test file
clamdscan eicar.com
```

Expected output:
```
/path/to/eicar.com: Eicar-Test-Signature FOUND

----------- SCAN SUMMARY -----------
Infected files: 1
Time: 0.001 sec (0 m 0 s)
```

**Important Notes:**
- EICAR is NOT malware - it's a safe test string designed for AV testing
- Modern browsers may block the download (this is normal security behavior)
- If your browser blocks it, use `wget` or `curl` from the command line
- The EICAR signature: `X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*`

**Alternative - Create EICAR manually:**

```bash
# Create EICAR test file manually (if download is blocked)
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > eicar.com

# Test the file
clamdscan eicar.com
```

If ClamAV detects the EICAR file correctly, your malware scanning setup is working properly.

### Testing Socket Connection with INSTREAM

Test uploading a file directly to ClamAV's TCP socket using the INSTREAM protocol (this is how the BunkerWeb plugin communicates with ClamAV):

**1. Create EICAR test file:**

```bash
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > /tmp/eicar.com
```

**2. Send file via INSTREAM protocol:**

```bash
# Using a simple bash script to test INSTREAM
(
  echo -n "zINSTREAM"
  echo -ne "\x00\x00\x00\x44"  # 68 bytes in big-endian
  cat /tmp/eicar.com
  echo -ne "\x00\x00\x00\x00"  # End marker
) | nc 127.0.0.1 3310
```

**Expected response:**
```
stream: Eicar-Test-Signature FOUND
```

**Alternative using a Python script:**

```bash
# Create a test script
cat > test_instream.py << 'EOF'
#!/usr/bin/env python3
import socket
import struct

def scan_file(filepath):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect(("127.0.0.1", 3310))

    # Send INSTREAM command
    sock.sendall(b"zINSTREAM\0")

    # Read and send file in chunks
    with open(filepath, 'rb') as f:
        while True:
            chunk = f.read(2048)
            if not chunk:
                break
            # Send chunk size (4 bytes, big-endian) followed by chunk
            sock.sendall(struct.pack(b'>L', len(chunk)))
            sock.sendall(chunk)

    # Send zero-length chunk to signal end
    sock.sendall(struct.pack(b'>L', 0))

    # Receive response
    response = sock.recv(4096).decode('utf-8')
    sock.close()

    print(f"ClamAV response: {response.strip()}")
    return response

if __name__ == "__main__":
    scan_file("/tmp/eicar.com")
EOF

# Make it executable and run
chmod +x test_instream.py
python3 test_instream.py
```

**Expected output:**
```
ClamAV response: stream: Eicar-Test-Signature FOUND
```

**3. Test with a clean file:**

```bash
echo "This is a clean file" > /tmp/clean.txt
python3 test_instream.py  # (modify filepath to /tmp/clean.txt)
```

**Expected output:**
```
ClamAV response: stream: OK
```

This confirms that:
- ClamAV's TCP socket is working correctly
- The INSTREAM protocol is functioning
- Malware detection works over the network socket
- The plugin's communication method with ClamAV is validated

### Testing BunkerWeb Plugin Integration

After configuring the BunkerWeb plugin, test the complete malware scanning workflow:

**1. Prepare EICAR test file:**

```bash
# Create EICAR test file
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > /tmp/eicar.com

# Or download it
wget https://secure.eicar.org/eicar.com -O /tmp/eicar.com
```

**2. Test file upload via HTTP:**

```bash
# Upload EICAR to your BunkerWeb-protected application
curl -X POST -F "file=@/tmp/eicar.com" http://your-app.com/upload
```

**Expected behavior:**
- Request should be blocked with HTTP 403
- BunkerWeb logs should show malware detection:
  ```
  [MALWARE-SCAN] MALWARE DETECTED BY CLAMAV
  [MALWARE-SCAN] ClamAV signature: Eicar-Test-Signature
  [MALWARE-SCAN] BLOCKING REQUEST
  ```

**3. Check BunkerWeb logs:**

```bash
# View recent logs
journalctl -u bunkerweb -n 100 | grep MALWARE-SCAN

# Or if using Docker
docker logs bunkerweb | grep MALWARE-SCAN
```

**4. Test clean file upload:**

```bash
# Create a clean test file
echo "This is a clean test file" > /tmp/clean.txt

# Upload clean file
curl -X POST -F "file=@/tmp/clean.txt" http://your-app.com/upload
```

**Expected behavior:**
- Request should be allowed (HTTP 200 or normal response)
- Logs should show clean scan result

**5. Cleanup:**

```bash
# Remove test files
rm /tmp/eicar.com /tmp/clean.txt
```

## Updating Virus Definitions

To ensure ClamAV has the latest virus definitions, run:

```bash
freshclam
```

You can also enable automatic updates by ensuring the `clamav-freshclam` service is running:

```bash
systemctl enable clamav-freshclam
systemctl start clamav-freshclam
```

## Troubleshooting

If the service is not responding:

1. Check the service status:

   **Debian/Ubuntu:**
   ```bash
   systemctl status clamav-daemon
   ```

   **Red Hat/CentOS:**
   ```bash
   systemctl status clamd@scan
   ```

2. Check if the port is listening:
   ```bash
   netstat -tlnp | grep 3310
   # or
   ss -tlnp | grep 3310
   ```

3. Review logs for errors:

   **Debian/Ubuntu:**
   ```bash
   journalctl -u clamav-daemon -n 50
   ```

   **Red Hat/CentOS:**
   ```bash
   journalctl -u clamd@scan -n 50
   ```

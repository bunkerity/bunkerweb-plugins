#!/bin/bash
set -e

# ClamAV Installation Script for Malware Scanning
# Supports: Debian 13, Ubuntu, Red Hat, CentOS, Rocky Linux, AlmaLinux

echo "=========================================="
echo "ClamAV Network Scanner Installation"
echo "=========================================="
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "Error: This script must be run as root"
    exit 1
fi

# Detect OS
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        VER=$VERSION_ID
    elif [ -f /etc/redhat-release ]; then
        OS="rhel"
    else
        echo "Error: Unable to detect operating system"
        exit 1
    fi
}

# Install ClamAV based on OS
install_clamav() {
    detect_os
    echo "Detected OS: $OS $VER"
    echo ""

    case "$OS" in
        debian|ubuntu)
            echo "Installing ClamAV on Debian/Ubuntu..."
            apt-get update
            apt-get install -y clamav-daemon clamav netcat-openbsd
            SOCKET_FILE="/lib/systemd/system/clamav-daemon.socket"
            CONFIG_FILE="/etc/clamav/clamd.conf"
            SERVICE_NAME="clamav-daemon"
            ;;
        rhel|centos|rocky|almalinux|fedora)
            echo "Installing ClamAV on Red Hat/CentOS..."
            # Enable EPEL repository if needed
            if ! rpm -q epel-release &>/dev/null; then
                if [ "$OS" = "rhel" ] || [ "$OS" = "centos" ]; then
                    yum install -y epel-release
                fi
            fi
            yum install -y clamav clamd clamav-update nc
            SOCKET_FILE="/usr/lib/systemd/system/clamd@scan.socket"
            CONFIG_FILE="/etc/clamd.d/scan.conf"
            SERVICE_NAME="clamd@scan"
            ;;
        *)
            echo "Error: Unsupported operating system: $OS"
            exit 1
            ;;
    esac

    echo "✓ ClamAV packages installed"
    echo ""
}

# Configure systemd socket for network listening
configure_socket() {
    echo "Configuring systemd socket to listen on 127.0.0.1:3310..."

    if [ ! -f "$SOCKET_FILE" ]; then
        echo "Error: Socket file not found: $SOCKET_FILE"
        exit 1
    fi

    # Check if ListenStream is already configured
    if grep -q "^ListenStream=127.0.0.1:3310" "$SOCKET_FILE"; then
        echo "✓ Socket already configured for 127.0.0.1:3310"
    else
        # Add ListenStream after [Socket] section
        sed -i '/\[Socket\]/a ListenStream=127.0.0.1:3310' "$SOCKET_FILE"
        echo "✓ Added ListenStream=127.0.0.1:3310 to socket configuration"
    fi
    echo ""
}

# Configure clamd.conf
configure_clamd() {
    echo "Configuring ClamAV daemon..."

    if [ ! -f "$CONFIG_FILE" ]; then
        echo "Error: Configuration file not found: $CONFIG_FILE"
        exit 1
    fi

    # For Red Hat/CentOS, comment out Example line if present
    if [ "$OS" = "rhel" ] || [ "$OS" = "centos" ] || [ "$OS" = "rocky" ] || [ "$OS" = "almalinux" ]; then
        if grep -q "^Example" "$CONFIG_FILE"; then
            sed -i 's/^Example/#Example/' "$CONFIG_FILE"
            echo "✓ Disabled Example directive"
        fi
    fi

    # Ensure TCP socket settings are present
    if ! grep -q "^TCPSocket" "$CONFIG_FILE"; then
        echo "TCPSocket 3310" >> "$CONFIG_FILE"
        echo "✓ Added TCPSocket 3310"
    fi

    if ! grep -q "^TCPAddr" "$CONFIG_FILE"; then
        echo "TCPAddr 127.0.0.1" >> "$CONFIG_FILE"
        echo "✓ Added TCPAddr 127.0.0.1"
    fi

    # Disable PUA detection
    if grep -q "^DetectPUA yes" "$CONFIG_FILE"; then
        sed -i 's/^DetectPUA yes/DetectPUA no/' "$CONFIG_FILE"
        echo "✓ Disabled PUA detection (was enabled)"
    elif ! grep -q "^DetectPUA" "$CONFIG_FILE"; then
        echo "DetectPUA no" >> "$CONFIG_FILE"
        echo "✓ Disabled PUA detection (added configuration)"
    else
        echo "✓ PUA detection already disabled"
    fi

    echo ""
}

# Update virus definitions
update_definitions() {
    echo "Updating virus definitions..."
    if command -v freshclam &> /dev/null; then
        # Stop freshclam service if running to avoid conflicts
        systemctl stop clamav-freshclam 2>/dev/null || systemctl stop clamav-freshclam.service 2>/dev/null || true

        freshclam || {
            echo "Warning: freshclam update failed. Will retry after service start."
        }
        echo "✓ Virus definitions updated"
    else
        echo "Warning: freshclam not found, skipping virus definition update"
    fi
    echo ""
}

# Reload and restart services
restart_services() {
    echo "Reloading systemd and restarting ClamAV daemon..."
    systemctl daemon-reload
    systemctl enable "$SERVICE_NAME" 2>/dev/null || true
    systemctl restart "$SERVICE_NAME"

    # Give the service a moment to start
    sleep 2

    if systemctl is-active --quiet "$SERVICE_NAME"; then
        echo "✓ ClamAV daemon is running"
    else
        echo "Warning: ClamAV daemon may not be running properly"
        systemctl status "$SERVICE_NAME" --no-pager
    fi

    # Enable and start freshclam for automatic updates
    if [ "$OS" = "debian" ] || [ "$OS" = "ubuntu" ]; then
        systemctl enable clamav-freshclam 2>/dev/null || true
        systemctl start clamav-freshclam 2>/dev/null || true
        echo "✓ Enabled automatic virus definition updates"
    fi

    echo ""
}

# Test the installation
test_installation() {
    echo "Testing ClamAV network scanner..."

    # Check if port is listening
    if ss -tlnp 2>/dev/null | grep -q ":3310" || netstat -tlnp 2>/dev/null | grep -q ":3310"; then
        echo "✓ Port 3310 is listening"
    else
        echo "Warning: Port 3310 does not appear to be listening"
    fi

    # Send PING command
    echo "Sending PING command to 127.0.0.1:3310..."
    RESPONSE=$(echo "PING" | nc 127.0.0.1 3310 2>/dev/null || echo "FAILED")

    if echo "$RESPONSE" | grep -q "PONG"; then
        echo "✓ Received PONG response"
        echo ""
        echo "=========================================="
        echo "Installation completed successfully!"
        echo "=========================================="
        echo ""
        echo "ClamAV is now listening on 127.0.0.1:3310"

        # Show configuration summary
        echo ""
        echo "Configuration Summary:"
        echo "  - DetectPUA: disabled (real malware only)"
        echo "  - TCP Socket: 127.0.0.1:3310"
        if command -v clamconf &> /dev/null; then
            VIRUS_COUNT=$(clamconf 2>/dev/null | grep "Total number of signatures:" | awk '{print $NF}')
            if [ -n "$VIRUS_COUNT" ]; then
                echo "  - Virus Signatures: $VIRUS_COUNT"
            fi
        fi

        return 0
    else
        echo "✗ Failed to receive PONG response"
        echo "Response: $RESPONSE"
        echo ""
        echo "Installation completed but service may not be responding correctly."
        echo "Please check the logs: journalctl -u $SERVICE_NAME -n 50"
        return 1
    fi
}

# Main installation flow
main() {
    install_clamav
    configure_socket
    configure_clamd
    update_definitions
    restart_services
    test_installation
}

# Run main installation
main

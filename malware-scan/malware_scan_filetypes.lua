-- BunkerWeb Malware Scan - File Type Categories
-- Categorizes MIME types returned by `file --mime-type` command
-- Used for risk assessment, GDPR compliance, and filtering logic

-- Module table
local filetypes = {}

-- Module version
filetypes.VERSION = "0.8.0"

-- ============================================================================
-- EXECUTABLE FILES (High Risk - Should Always Be Scanned)
-- ============================================================================

-- Files that can execute code directly or contain executable content.
-- These are the primary vectors for malware delivery.
-- MIME types returned by `file --mime-type` command.

filetypes.EXECUTABLE_TYPES = {
	-- Windows Executables (Modern)
	"application/x-dosexec",           -- PE executables (.exe, .dll, .scr, .sys, .com)
	"application/x-msdownload",        -- Windows downloads
	"application/x-ms-dos-executable", -- DOS executables
	"application/vnd.microsoft.portable-executable", -- PE format

	-- Windows Executables (Legacy - Still Seen in the Wild)
	"application/x-ms-ne-executable",  -- 16-bit Windows (NE format)
	"application/x-ms-w3-executable",  -- Win32s executables
	"application/x-ms-w4-executable",  -- Windows 95 executables
	"application/x-coff-executable",   -- COFF format

	-- Linux/Unix Executables
	"application/x-executable",        -- ELF executables
	"application/x-sharedlib",         -- Shared libraries (.so)
	"application/x-object",            -- Object files
	"application/x-pie-executable",    -- Position Independent Executables

	-- macOS Executables
	"application/x-mach-binary",       -- Mach-O binaries
	"application/x-mach-executable",   -- Mach-O executables

	-- Scripts (Interpreted but Executable)
	"text/x-shellscript",              -- Shell scripts (#!/bin/bash, #!/bin/sh)
	"text/x-python",                   -- Python scripts
	"text/x-perl",                     -- Perl scripts
	"text/x-ruby",                     -- Ruby scripts
	"text/x-php",                      -- PHP scripts
	"text/x-lua",                      -- Lua scripts
	"text/x-tcl",                      -- TCL scripts
	"text/x-awk",                      -- AWK scripts
	"application/x-javascript",        -- JavaScript files
	"application/javascript",          -- JavaScript
	"application/x-node",              -- Node.js scripts

	-- Bytecode and Compiled Scripts
	"application/java-vm",             -- Java class files
	"application/x-bytecode.python",   -- Python bytecode (.pyc)
	"application/x-java-applet",       -- Java applets

	-- Modern Web Threats
	"application/wasm",                -- WebAssembly binaries (can execute code)
	"application/x-chrome-extension",  -- Chrome extensions (.crx)

	-- Archives (Often Contain Executables)
	"application/zip",                 -- ZIP archives
	"application/x-rar",               -- RAR archives
	"application/x-7z-compressed",     -- 7-Zip archives
	"application/x-ace-compressed",    -- ACE archives
	"application/x-arj",               -- ARJ archives
	"application/x-arc",               -- ARC archives
	"application/x-zoo",               -- ZOO archives
	"application/x-stuffit",           -- StuffIt archives (Mac)
	"application/x-cpio",              -- CPIO archives
	"application/x-lzh-compressed",    -- LZH archives
	"application/gzip",                -- Gzip compressed
	"application/x-bzip",              -- Bzip compressed
	"application/x-bzip2",             -- Bzip2 compressed
	"application/x-xz",                -- XZ compressed
	"application/x-lzip",              -- LZIP compressed
	"application/x-lzma",              -- LZMA compressed
	"application/x-lzop",              -- LZOP compressed
	"application/x-tar",               -- TAR archives
	"application/x-compress",          -- Unix compress

	-- Disk Images (Common Malware Delivery Method)
	"application/x-iso9660-image",     -- ISO disk images
	"application/x-raw-disk-image",    -- Raw disk images
	"application/x-compressed-iso",    -- Compressed ISO images
	"application/x-qemu-disk",         -- QEMU disk images
	"application/x-virtualbox-vhd",    -- VirtualBox VHD
	"application/x-virtualbox-ova",    -- VirtualBox OVA

	-- Windows Installers and Packages
	"application/x-msi",               -- MSI installers
	"application/x-ms-wim",            -- Windows Imaging Format
	"application/x-installshield",     -- InstallShield installers
	"application/vnd.ms-cab-compressed", -- CAB archives

	-- Mobile Applications
	"application/vnd.android.package-archive", -- Android APK
	"application/x-apple-diskimage",   -- macOS DMG
	"application/x-ios-app",           -- iOS applications

	-- Java Archives
	"application/java-archive",        -- JAR files
	"application/x-java-archive",      -- JAR files (alternate)

	-- Windows Shortcuts (Can Execute Commands)
	"application/x-ms-shortcut",       -- .lnk files

	-- Batch Files
	"application/x-bat",               -- Windows batch files
	"text/x-msdos-batch",              -- DOS batch files
}

-- ============================================================================
-- USER DATA FILES (May Contain Personal Information - GDPR Relevant)
-- ============================================================================

-- Files that commonly contain user-generated content or personal data.
-- Important for GDPR compliance when uploading to public databases.
-- MIME types returned by `file --mime-type` command.

filetypes.USER_DATA_TYPES = {
	-- Plain Text Documents
	"text/plain",                      -- Plain text files
	"text/csv",                        -- CSV data files
	"text/tab-separated-values",       -- TSV files
	"text/rtf",                        -- Rich Text Format
	"text/x-log",                      -- Log files (may contain user data)

	-- Microsoft Office Documents (Legacy)
	"application/msword",              -- Word documents (.doc)
	"application/vnd.ms-excel",        -- Excel spreadsheets (.xls)
	"application/vnd.ms-powerpoint",   -- PowerPoint presentations (.ppt)
	"application/vnd.ms-access",       -- Access databases
	"application/vnd.ms-outlook",      -- Outlook PST/OST files

	-- Microsoft Office Documents (Modern - Office 2007+)
	"application/vnd.openxmlformats-officedocument.wordprocessingml.document",     -- .docx
	"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",           -- .xlsx
	"application/vnd.openxmlformats-officedocument.presentationml.presentation",   -- .pptx

	-- OpenDocument Formats (LibreOffice/OpenOffice)
	"application/vnd.oasis.opendocument.text",         -- .odt (text documents)
	"application/vnd.oasis.opendocument.spreadsheet",  -- .ods (spreadsheets)
	"application/vnd.oasis.opendocument.presentation", -- .odp (presentations)

	-- PDF Documents
	"application/pdf",                 -- PDF files (often contain personal data)

	-- Images (May Contain Faces, Locations, Metadata)
	"image/jpeg",                      -- JPEG images
	"image/jpg",                       -- JPG images
	"image/png",                       -- PNG images
	"image/gif",                       -- GIF images
	"image/bmp",                       -- Bitmap images
	"image/tiff",                      -- TIFF images
	"image/webp",                      -- WebP images
	"image/heic",                      -- HEIC (iPhone photos)
	"image/heif",                      -- HEIF format
	"image/svg+xml",                   -- SVG vector graphics
	"image/avif",                      -- AVIF (modern format)
	"image/jxl",                       -- JPEG XL (modern format)
	"image/jxr",                       -- JPEG XR (Microsoft)
	"image/vnd.adobe.photoshop",       -- PSD files (Adobe Photoshop)

	-- Camera RAW Formats (Photos = Personal Data)
	"image/x-canon-cr2",               -- Canon RAW photos
	"image/x-canon-crw",               -- Canon RAW photos (older)
	"image/x-fuji-raf",                -- Fuji RAW photos
	"image/x-olympus-orf",             -- Olympus RAW photos

	-- Audio Files (Voice Recordings, etc.)
	"audio/mpeg",                      -- MP3 audio
	"audio/mp3",                       -- MP3 (alternate)
	"audio/mp4",                       -- M4A audio
	"audio/wav",                       -- WAV audio
	"audio/x-wav",                     -- WAV (alternate)
	"audio/flac",                      -- FLAC audio
	"audio/ogg",                       -- OGG audio
	"audio/aac",                       -- AAC audio

	-- Video Files (May Contain Faces, Locations)
	"video/mp4",                       -- MP4 video
	"video/mpeg",                      -- MPEG video
	"video/quicktime",                 -- QuickTime/MOV
	"video/x-msvideo",                 -- AVI video
	"video/x-matroska",                -- MKV video
	"video/webm",                      -- WebM video
	"video/3gpp",                      -- 3GP mobile video
	"video/3gpp2",                     -- 3GPP2 mobile video
	"video/x-flv",                     -- Flash Video
	"video/x-ms-asf",                  -- Windows Media (ASF)

	-- Email Files
	"message/rfc822",                  -- Email messages (.eml)
	"application/mbox",                -- Unix mailbox format

	-- **CRITICAL** Database Files (Almost Always Contain Personal Data)
	"application/vnd.sqlite3",         -- SQLite databases
	"application/x-sqlite3",           -- SQLite databases (alternate)
	"application/x-sqlite2",           -- SQLite v2 databases
	"application/vnd.geopackage+sqlite3", -- GeoPackage databases (geospatial data)
	"application/x-dbf",               -- dBase database files
	"application/msaccess",            -- Microsoft Access databases
	"application/x-msaccess",          -- Microsoft Access (alternate)

	-- **CRITICAL** Medical and Health Data (HIPAA/GDPR)
	"application/dicom",               -- Medical imaging (DICOM format)

	-- Financial Data
	"application/x-gnucash",           -- GnuCash financial data

	-- eBooks (May Contain Personal Notes/Highlights)
	"application/epub+zip",            -- EPUB ebooks
	"application/x-mobipocket-ebook",  -- MOBI ebooks

	-- Scientific Data Files
	"application/x-hdf",               -- HDF scientific data
	"application/x-hdf5",              -- HDF5 scientific data

	-- Archives (May Contain Personal Data - Documents, Photos, Databases, etc.)
	-- NOTE: Archives are in BOTH executable and user data lists
	-- - EXECUTABLE_TYPES: Can contain malware
	-- - USER_DATA_TYPES: Can contain personal documents/photos/data
	"application/zip",                 -- ZIP archives
	"application/x-rar",               -- RAR archives
	"application/x-7z-compressed",     -- 7-Zip archives
	"application/x-ace-compressed",    -- ACE archives
	"application/x-arj",               -- ARJ archives
	"application/x-arc",               -- ARC archives
	"application/x-zoo",               -- ZOO archives
	"application/x-stuffit",           -- StuffIt archives (Mac)
	"application/x-cpio",              -- CPIO archives
	"application/x-lzh-compressed",    -- LZH archives
	"application/gzip",                -- Gzip compressed
	"application/x-bzip",              -- Bzip compressed
	"application/x-bzip2",             -- Bzip2 compressed
	"application/x-xz",                -- XZ compressed
	"application/x-lzip",              -- LZIP compressed
	"application/x-lzma",              -- LZMA compressed
	"application/x-lzop",              -- LZOP compressed
	"application/x-tar",               -- TAR archives
	"application/x-compress",          -- Unix compress
	"application/vnd.ms-cab-compressed", -- CAB archives

	-- Disk Images (May Contain Personal Data - Backups, File Systems)
	-- NOTE: Disk images are in BOTH executable and user data lists
	-- - EXECUTABLE_TYPES: Can contain bootable malware
	-- - USER_DATA_TYPES: Can contain personal files/backups
	"application/x-iso9660-image",     -- ISO disk images
	"application/x-raw-disk-image",    -- Raw disk images
	"application/x-compressed-iso",    -- Compressed ISO images
	"application/x-qemu-disk",         -- QEMU disk images
	"application/x-virtualbox-vhd",    -- VirtualBox VHD
	"application/x-virtualbox-ova",    -- VirtualBox OVA
	"application/x-apple-diskimage",   -- macOS DMG (disk images)

	-- Markup and Data Formats
	"text/html",                       -- HTML documents
	"application/xhtml+xml",           -- XHTML documents
	"text/xml",                        -- XML files
	"application/xml",                 -- XML (alternate)
	"application/json",                -- JSON data files

	-- Contact and Calendar Data
	"text/vcard",                      -- vCard contact files
	"text/calendar",                   -- iCalendar files
}

-- ============================================================================
-- HELPER FUNCTIONS
-- ============================================================================

-- Check if a MIME type is an executable file type.
--- @param mime_type MIME type string from file --mime-type
--- @return boolean is_executable True if executable type
function filetypes.is_executable(mime_type)
	if not mime_type then
		return false
	end

	-- Normalize MIME type (lowercase, strip charset if present)
	local normalized = mime_type:lower():match("^([^;]+)")

	for _, exec_type in ipairs(filetypes.EXECUTABLE_TYPES) do
		if normalized == exec_type then
			return true
		end
	end

	return false
end

-- Check if a MIME type commonly contains user data.
-- Important for GDPR compliance when considering file uploads to public databases.
--- @param mime_type MIME type string from file --mime-type
--- @return boolean contains_user_data True if likely contains user data
function filetypes.contains_user_data(mime_type)
	if not mime_type then
		return false
	end

	-- Normalize MIME type (lowercase, strip charset if present)
	local normalized = mime_type:lower():match("^([^;]+)")

	for _, data_type in ipairs(filetypes.USER_DATA_TYPES) do
		if normalized == data_type then
			return true
		end
	end

	return false
end

-- Get risk category for a MIME type.
-- Returns one of: "executable", "user_data", "archive", "unknown"
--- @param mime_type MIME type string from file --mime-type
--- @return string category Risk category (one of: "executable", "user_data", "archive", "unknown")
function filetypes.get_risk_category(mime_type)
	if not mime_type then
		return "unknown"
	end

	-- Check executable first (highest risk)
	if filetypes.is_executable(mime_type) then
		-- Check if it's specifically an archive
		local normalized = mime_type:lower():match("^([^;]+)")
		if normalized:match("archive") or normalized:match("zip") or
		   normalized:match("rar") or normalized:match("7z") or
		   normalized:match("tar") or normalized:match("compress") then
			return "archive"
		end
		return "executable"
	end

	-- Check user data
	if filetypes.contains_user_data(mime_type) then
		return "user_data"
	end

	return "unknown"
end

-- Return module
return filetypes

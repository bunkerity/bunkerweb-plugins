-- BunkerWeb Malware Scan - Utilities Module
-- General-purpose utility functions used across multiple modules
-- Provides sanitization, validation, and helper functions

local ngx = ngx

-- Module table
local utils = {}

-- ============================================================================
-- STRING SANITIZATION
-- ============================================================================

-- Sanitize string for safe logging (prevents log injection attacks).
-- Replaces control characters, newlines, and non-printable characters with escaped representation.
-- Returns sanitized string safe for logging.
--
-- This function protects against log injection attacks where attackers include:
-- - Newlines (\n, \r) to forge log entries
-- - Control characters (\t, \0, etc.) to manipulate log parsing
-- - Non-printable characters that could exploit log viewers
--
-- Example:
--   utils.sanitize_for_logging("file.exe\n[ADMIN] Logged in\n")
--   Returns: "file.exe\x0a[ADMIN] Logged in\x0a"
--
-- @param str The string to sanitize (can be nil)
-- @return Sanitized string safe for logging
function utils.sanitize_for_logging(str)
	if not str then
		return "[nil]"
	end

	-- Replace control characters and special chars with escaped representation
	-- Pattern matches: \r, \n, \t, null byte (%z), and control chars (bytes 1-31)
	local sanitized = str:gsub("[\r\n\t%z\1-\31]", function(c)
		return string.format("\\x%02x", string.byte(c))
	end)

	-- Limit length for logging (prevent log flooding)
	if #sanitized > 200 then
		sanitized = sanitized:sub(1, 197) .. "..."
	end

	return sanitized
end

-- ============================================================================
-- FILENAME VALIDATION
-- ============================================================================

-- Validate filename for security (defense-in-depth).
-- Checks for path traversal, null bytes, and excessive length.
--
-- This function protects against:
-- - Directory traversal: .. (parent directory)
-- - Current directory references: ./ and .\
-- - Path separators: / (Unix) and \ (Windows)
-- - Null byte injection: \0 (C string truncation)
-- - Excessive length: >255 characters
--
-- Example attacks blocked:
--   "../../etc/passwd" → Directory traversal
--   "./malware.exe" → Current directory reference
--   "C:\Windows\System32\evil.dll" → Windows path
--   "file\0.txt" → Null byte injection
--
-- @param filename The filename to validate
-- @return true on success, or false and error message on failure
function utils.validate_filename(filename)
	if not filename or filename == "" then
		return false, "empty filename"
	end

	-- Reject path traversal attempts (split into separate checks for clear error messages)
	if filename:match("%.%.") then
		return false, "invalid filename (directory traversal attempt: ..)"
	end

	if filename:match("%./") then
		return false, "invalid filename (Unix current directory reference: ./)"
	end

	if filename:match("%.\\") then
		return false, "invalid filename (Windows current directory reference: .\\)"
	end

	if filename:match("/") then
		return false, "invalid filename (Unix path separator detected: /)"
	end

	if filename:match("\\") then
		return false, "invalid filename (Windows path separator detected: \\)"
	end

	-- Reject null bytes (C string truncation attacks)
	if filename:match("\0") then
		return false, "invalid filename (null byte)"
	end

	-- Limit filename length (prevent buffer issues in logs)
	if #filename > 255 then
		return false, "filename too long (max 255 characters)"
	end

	return true
end

-- Return module
return utils

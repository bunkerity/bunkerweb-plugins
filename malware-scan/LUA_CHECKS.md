# Lua Code Quality Checks

**Version**: 0.7.2 | **Last Updated**: 2026-01-19

This document describes the automated Lua code quality checks for the malware-scan plugin.

## Automated Checks

### GitHub Actions Workflow

The repository includes automated Lua checking via GitHub Actions (`.github/workflows/lua-check.yml`):

**Triggers**:
- Push to `dev` or `main` branches (when Lua files change)
- Pull requests to `dev` or `main` branches (when Lua files change)

**Jobs**:

1. **Lua Syntax Check** (`lua-syntax`)
   - Uses `luac -p` to validate Lua syntax
   - Fails the build if syntax errors are found
   - Checks all `*.lua` files in `malware-scan/`

2. **Lua Static Analysis** (`lua-static-analysis`)
   - Uses `luacheck` for static code analysis
   - Identifies potential issues (unused variables, line length, etc.)
   - Does NOT fail the build (warnings only)
   - Configured via `.luacheckrc`

## Local Testing

### Syntax Check (Required)

```bash
cd malware-scan

# Check all Lua files for syntax errors
for file in *.lua; do
    echo "Checking $file..."
    luac -p "$file"
done
```

**Expected output**:
```
Checking malware-scan.lua...
Checking malware_scan_cache.lua...
...
(no output = success)
```

### Static Analysis (Optional)

Install luacheck:
```bash
# macOS
brew install luarocks
luarocks install luacheck

# Ubuntu/Debian
sudo apt install luarocks
sudo luarocks install luacheck

# Red Hat/CentOS
sudo yum install luarocks
sudo luarocks install luacheck
```

Run luacheck:
```bash
cd malware-scan
luacheck *.lua
```

## Luacheck Configuration

The `.luacheckrc` file configures luacheck behavior:

**Ignored warnings**:
- `211` - Unused local variable (common in module patterns)
- `212` - Unused argument (BunkerWeb API requirements)
- `213` - Unused loop variable
- `311` - Value assigned to variable is unused (module returns)
- `314` - Value of field is unused

**Settings**:
- Max line length: 200 characters (250 for main plugin file)
- Standard: Lua 5.4
- Global variables: OpenResty/nginx Lua, standard Lua libraries

## Common False Positives

### 1. Unused Arguments (212)
```lua
function module.function_name(plugin, param1, param2)
    -- BunkerWeb API requires 'plugin' even if unused in this function
    return do_something(param1)
end
```
**Why ignored**: BunkerWeb plugin API requires specific function signatures.

### 2. Unused Local Variables (211)
```lua
local ok, result = pcall(function() return require("module") end)
-- 'ok' might not be used if we only care about 'result'
```
**Why ignored**: Common in error handling patterns.

### 3. Line Length
```lua
-- Long help text or configuration strings
help = "Enable full multipart body scan (in addition to individual file extraction). WARNING: Full body SHA256 changes..."
```
**Why ignored**: Configuration strings and help text can be long.

## Integration with Development Workflow

### Pre-commit Hook (Optional)

Create `.git/hooks/pre-commit`:
```bash
#!/bin/bash
# Pre-commit hook for Lua syntax checking

echo "Running Lua syntax check..."
cd malware-scan

FAILED=0
for file in *.lua; do
    if ! luac -p "$file" 2>/dev/null; then
        echo "❌ Syntax error in $file"
        FAILED=1
    fi
done

if [ $FAILED -eq 1 ]; then
    echo "❌ Commit rejected: Fix Lua syntax errors"
    exit 1
fi

echo "✅ Lua syntax check passed"
```

Make executable:
```bash
chmod +x .git/hooks/pre-commit
```

### VS Code Integration

Install the Lua extension for VS Code:

1. Install [sumneko.lua](https://marketplace.visualstudio.com/items?itemName=sumneko.lua)
2. Add to `.vscode/settings.json`:

```json
{
  "Lua.diagnostics.globals": ["ngx", "package", "require"],
  "Lua.runtime.version": "Lua 5.4",
  "Lua.workspace.library": [
    "/usr/local/openresty/lualib"
  ],
  "Lua.diagnostics.disable": [
    "unused-local",
    "unused-vararg",
    "trailing-space"
  ]
}
```

## CI/CD Status

Check workflow status:
- GitHub: **Actions** tab → **Lua Checks** workflow
- Badge: Add to README.md:
  ```markdown
  ![Lua Checks](https://github.com/bunkerity/bunkerweb-plugins/workflows/Lua%20Checks/badge.svg)
  ```

## Troubleshooting

### Workflow Not Running

**Problem**: Workflow doesn't trigger on push

**Solution**: Check path filter - workflow only runs when `malware-scan/**/*.lua` files change

### Syntax Check Fails

**Problem**: `luac: command not found`

**Solution**: Install Lua:
```bash
# macOS
brew install lua

# Ubuntu/Debian
sudo apt install lua5.4

# Red Hat/CentOS
sudo yum install lua
```

### Luacheck Fails

**Problem**: Too many false positives

**Solution**: Update `.luacheckrc` to add more ignored warnings:
```lua
ignore = {
    "211",  -- Unused local variable
    "212",  -- Unused argument
    -- Add more as needed
}
```

## References

- **Luacheck Documentation**: https://luacheck.readthedocs.io/
- **Lua 5.4 Manual**: https://www.lua.org/manual/5.4/
- **OpenResty Lua**: https://github.com/openresty/lua-nginx-module
- **BunkerWeb Plugin API**: https://docs.bunkerweb.io/latest/plugins/

---

**Last Updated**: 2026-01-19
**Plugin Version**: 0.7.2
**Lua Version**: 5.4

# GDPR Compliance Guide for Malware-Scan Plugin

**Version**: 0.8.0
**Last Updated**: 2026-01-27
**Scope**: European Union General Data Protection Regulation (GDPR) compliance

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Data Processing Overview](#data-processing-overview)
3. [Legal Basis](#legal-basis)
4. [Data Collected](#data-collected)
5. [GDPR Compliance Measures](#gdpr-compliance-measures)
6. [Administrator Responsibilities](#administrator-responsibilities)
7. [Data Subject Rights](#data-subject-rights)
8. [Recommended Privacy Policy](#recommended-privacy-policy)
9. [Compliance Checklist](#compliance-checklist)

---

## Executive Summary

The malware-scan plugin processes personal data (IP addresses) as part of its security functionality. This document outlines the GDPR compliance measures implemented in the plugin and the responsibilities of administrators who deploy it.

### Key Points

- **Legal Basis**: Legitimate Interest (Article 6(1)(f)) - Security monitoring and infrastructure protection
- **Data Controller**: The administrator deploying BunkerWeb, not the plugin itself
- **Personal Data**: Client IP addresses, upload timestamps, file hashes
- **Retention**: 90 days (cache), up to 90 days (logs)
- **Data Minimization**: IP anonymization in webhooks (default: enabled)
- **Rights**: Access and erasure requests handled by administrators

### Compliance Status

‚úÖ **Implemented**:
- IP anonymization in webhooks (Article 5(1)(c) - Data Minimization)
- Configurable retention periods (Article 5(1)(e) - Storage Limitation)
- Legitimate interest legal basis (Article 6(1)(f))
- Security measures for data protection (Article 32)
- **File uploads to public databases DISABLED by default** (VirusTotal, MalwareBazaar) - GDPR-safe configuration

‚ö†Ô∏è **Administrator Action Required**:
- Privacy policy documentation (Article 13-14 - Transparency)
- Data subject rights implementation (Articles 15-17)
- Log retention policy enforcement (Article 5(1)(e))

üö® **CRITICAL - File Uploads to Public Databases**:
- **Default**: DISABLED for both services
  - `MALWARE_SCAN_API_VIRUSTOTAL_UPLOAD_UNKNOWN=no`
  - `MALWARE_SCAN_API_MALWAREBAZAAR_UPLOAD_UNKNOWN=no`
- **If enabling**: Uploaded malware files become **publicly accessible** in VirusTotal and/or MalwareBazaar databases
- **GDPR Risk**: Files may contain personal data (documents, emails, images)
- **Required Action**: Consult legal counsel, document legal basis, add explicit privacy notice
- **Recommendation**: Keep DISABLED unless you have strong legal justification

---

## Data Processing Overview

### What is Personal Data?

Under GDPR Article 4(1), **personal data** means:
> "any information relating to an identified or identifiable natural person"

**IP addresses are personal data** per CJEU Case C-582/14 (Breyer v Germany).

### Purpose of Data Processing

The plugin processes personal data for:
1. **Malware detection** - Scanning uploaded files for threats
2. **Security monitoring** - Tracking repeat malware upload attempts
3. **Incident response** - Alerting administrators of attacks
4. **Infrastructure protection** - Blocking malicious uploads

---

## Legal Basis

### Article 6(1)(f) - Legitimate Interest

The plugin relies on **legitimate interest** as the legal basis for processing IP addresses:

**Purpose**: Security monitoring - tracking attackers and distributed malware to fulfill security expectations

**Necessity**: Full IP addresses (not anonymized) are needed for:
- Forensic evidence of malicious intent
- Proving attacks in legal proceedings (Article 17(3)(e) exception)
- Protecting servers, data, and users from malware

**Balancing Test**:
- **Controller's Interest**: Protecting infrastructure from malware attacks (high priority)
- **Data Subject's Interest**: Privacy expectations when uploading malware (low expectation of privacy for malicious activity)
- **Result**: Security interest outweighs attacker's privacy expectations

### Why Not Consent?

Consent (Article 6(1)(a)) is **not appropriate** for security monitoring because:
- Attackers would not provide consent
- Security measures must be effective regardless of consent
- Consent can be withdrawn, undermining security
- Legitimate interest is the proper legal basis for security purposes

---

## Data Collected

### 1. Attacker Tracking Data

**Enabled when**: `MALWARE_SCAN_TRACK_ATTACKERS=yes` (default)

| Data Element | Example | Purpose | Retention |
|--------------|---------|---------|-----------|
| IP Address | `192.168.1.123` | Identify repeat offenders | 90 days (configurable) |
| First Upload | `2026-01-19 10:30:00 UTC` | Track attack timeline | 90 days (configurable) |
| Last Upload | `2026-01-19 14:22:15 UTC` | Track attack timeline | 90 days (configurable) |
| Upload Count | `5` | Identify repeat offenders | 90 days (configurable) |
| Checksums | `["abc123...", "def456..."]` | Link malware samples | 90 days (configurable) |

**Storage Location**: Redis cache
**Cache Key Format**: `plugin_malware_scan_attacker_[ipv4|ipv6]_[IP_ADDRESS]`
**TTL**: Configurable via `MALWARE_SCAN_TRACK_ATTACKER_TTL` (default: 7776000 seconds / 90 days)
**TTL Behavior**: TTL resets on each new malware upload from the same IP. The 90-day window is always from the LAST upload, not the first.
**Rationale**: Extended 90-day retention allows sufficient time to gather evidence for law enforcement and legal proceedings

### 2. Scan Results Cache

**Purpose**: Performance optimization - avoid re-scanning known files

| Data Element | Example | Purpose | Retention |
|--------------|---------|---------|-----------|
| File Hash (SHA256) | `abc123def456...` | Identify file | 5 min (clean) / 90 days (malicious) |
| Detection Results | `Win.Trojan.Zusy-9935890-0` | Cache scanner responses | 5 min (clean) / 90 days (malicious) |
| Scanner Names | `ClamAV, VirusTotal` | Cache scanner responses | 5 min (clean) / 90 days (malicious) |

**Storage Location**: Redis cache
**Cache Key Format**: `plugin_malware_scan_result_[SHA256]`
**TTL**: 300 seconds (clean files), 7776000 seconds (malicious files)
**Rationale**: Long retention for malicious hashes reduces API calls, improves performance for repeat attacks, and maintains detection history

**Note**: File hashes alone are **not personal data**, but combined with IP address tracking may constitute personal data through linkability.

### 3. Application Logs

**Purpose**: Security monitoring, debugging, incident investigation

| Data Element | Example | Storage | Retention |
|--------------|---------|---------|-----------|
| IP Addresses | `192.168.1.123` | BunkerWeb logs | Administrator controlled (recommend ‚â§90 days) |
| Timestamps | `2026-01-19 10:30:00` | BunkerWeb logs | Administrator controlled (recommend ‚â§90 days) |
| Detection Results | `ClamAV: Win.Trojan.Zusy` | BunkerWeb logs | Administrator controlled (recommend ‚â§90 days) |
| File Checksums | `abc123def456...` | BunkerWeb logs | Administrator controlled (recommend ‚â§90 days) |
| Server Names | `www.example.com` | BunkerWeb logs | Administrator controlled (recommend ‚â§90 days) |
| Request URIs | `/upload.php` | BunkerWeb logs | Administrator controlled (recommend ‚â§90 days) |

**Storage Location**: `/var/log/bunkerweb/` (default) or custom log path
**Retention**: Not automatically managed - administrator responsibility
**Recommendation**: Implement log rotation with maximum 90-day retention

### 4. Webhook Notifications (Optional)

**Enabled when**: `MALWARE_SCAN_TEAMS_WEBHOOK_URL` or `MALWARE_SCAN_DISCORD_WEBHOOK_URL` configured

**Data Minimization**: IP addresses in webhooks are **anonymized by default** (GDPR Article 5(1)(c))

| Data Element | Original | Anonymized (default) | Purpose |
|--------------|----------|----------------------|---------|
| IPv4 Address | `192.168.1.123` | `192.168.1.x` | Alert security team |
| IPv6 Address | `2001:db8::1234:5678` | `2001:db8::1234:x` | Alert security team |
| Server Name | `www.example.com` | `www.example.com` | Identify affected service |
| Detection Results | `ClamAV: Win.Trojan` | `ClamAV: Win.Trojan` | Understand threat |
| File Checksum | `abc123def456...` | `abc123def456...` | Identify malware sample |

**Configuration**: `MALWARE_SCAN_ANONYMIZE_WEBHOOK_IPS=yes` (default: yes)
**Third Parties**: Microsoft Teams, Discord (US companies - international data transfer)
**Retention by Third Parties**: Potentially indefinite (no control)

### 5. File Uploads to Third Parties (Optional but HIGH IMPACT)

**‚ö†Ô∏è CRITICAL GDPR CONCERN**: When enabled, malware files (which may contain personal data) are uploaded to third-party threat intelligence services.

**Enabled when**:
- `MALWARE_SCAN_API_VIRUSTOTAL_UPLOAD_UNKNOWN=yes`
- `MALWARE_SCAN_API_MALWAREBAZAAR_UPLOAD_UNKNOWN=yes`

**What Gets Uploaded**:
- **Complete file contents** - The entire malware file detected by ClamAV is uploaded
- **Files may contain personal data** - Documents, emails, images, or other files with embedded personal information
- **Trigger condition (VirusTotal)**: ClamAV detects malware AND VirusTotal doesn't have the file in their database
- **Trigger condition (MalwareBazaar)**: ClamAV detects malware AND MalwareBazaar doesn't have the file in their database

**Third-Party Data Sharing**:

| Recipient | Data Shared | Purpose | Retention | Public Access |
|-----------|-------------|---------|-----------|---------------|
| **VirusTotal** (Google LLC, USA) | Complete file contents, SHA256 hash, file metadata | Malware analysis and threat intelligence | Indefinite | **YES** - Files become part of VirusTotal's public database accessible to security researchers |
| **MalwareBazaar** (abuse.ch, Switzerland) | Complete file contents, SHA256 hash, file metadata, tags | Malware sample sharing and threat intelligence | Indefinite | **YES** - Files become part of MalwareBazaar's public database accessible to security researchers worldwide |

**GDPR Implications**:
- **Article 5(1)(c) - Data Minimization**: Uploading entire files (vs. hashes) is extensive data sharing
- **Article 6 - Legal Basis**: Legitimate interest may not cover sharing files containing personal data with public databases
- **Article 44-50 - International Transfer**: Transfer to USA (Google) without adequate protections
- **Article 9 - Special Categories**: If files contain health data, biometric data, etc., this may violate GDPR
- **Transparency**: Users may not expect uploaded malware files to become publicly accessible

**Recommendation**:
- **File uploads are DISABLED by default**:
  - `MALWARE_SCAN_API_VIRUSTOTAL_UPLOAD_UNKNOWN=no` (default)
  - `MALWARE_SCAN_API_MALWAREBAZAAR_UPLOAD_UNKNOWN=no` (default)
- **Only enable** if you understand the legal implications and have documented justification
- **Add explicit notice** in privacy policy about file sharing with VirusTotal and/or MalwareBazaar
- **Consider consent requirement** if files might contain personal data

**‚úÖ Automatic GDPR Protection (Built-In File Type Filtering)**:

Even if file upload is enabled, the plugin **automatically protects user data** with file type filtering:

- **Only uploads**: Executables (PE, ELF, Mach-O), scripts (Python, PHP, shell, JavaScript), bytecode (Java, Python .pyc), WebAssembly binaries
- **NEVER uploads**: Documents (PDF, Word, Excel), images (JPEG, PNG, GIF, RAW), databases (SQLite, Access), archives (ZIP, RAR, 7z, TAR), disk images (ISO, DMG), emails, audio, video, or any file that may contain personal data

**How It Works**:
1. Plugin detects file type using Unix `file` command (magic byte analysis) at scan start
2. Checks file type against user data categories (129 MIME types) before ANY upload
3. If file may contain personal data ‚Üí BLOCKED from upload with log message
4. If file is executable malware ‚Üí Allowed to upload (shares malware with community)
5. **Protection applies to ALL scanners**: ClamAV direct uploads AND SentinelOne/MalwareBazaar sharing via `detection_share()`

**Example Log Messages**:
- Blocked (ClamAV): `"ClamAV detected malware but file may contain user data (type: application/pdf) - GDPR protection: NOT uploading to VirusTotal"`
- Blocked (Unknown): `"[SHARE] MalwareBazaar detected malware but file type unknown - GDPR protection: NOT uploading to VirusTotal (cannot verify if file contains personal data)"`
- Allowed (Executable): `"ClamAV detected malware but VT doesn't have file (type: application/x-dosexec) - uploading to VirusTotal"`
- Allowed (Share): `"[SHARE] File unknown to VirusTotal and safe to share (type: text/x-php) - uploading for threat intelligence (detected by SentinelOne)"`

**File Type Categories Protected**:
- Documents: PDF, DOC/DOCX, XLS/XLSX, PPT/PPTX, ODT, ODS, ODP
- Images: JPEG, PNG, GIF, BMP, TIFF, WebP, HEIC, AVIF, PSD, Camera RAW (CR2, RAF, ORF)
- Databases: SQLite, Microsoft Access, GeoPackage, dBase
- Medical: DICOM medical imaging (HIPAA/GDPR Article 9 special category data)
- Financial: GnuCash financial data
- Archives: ZIP, RAR, 7z, TAR, GZIP, BZIP2, XZ (may contain personal documents)
- Disk Images: ISO, DMG, VHD, OVA (may contain personal file systems)
- Emails: .eml, MBOX mailbox files
- Audio: MP3, WAV, FLAC, OGG, AAC (voice recordings)
- Video: MP4, AVI, MKV, MOV, WebM (may contain faces, locations)

**Result**: This automated protection significantly reduces GDPR risk even if upload is enabled. Only true executable malware is shared with threat intelligence services.

**Hash-Only Sharing (Lower Risk)**:

Unlike file uploads, hash-only operations do not transfer personal data:

**VirusTotal Voting**:
- **Enabled when**: `MALWARE_SCAN_API_VIRUSTOTAL_VOTE_MALICIOUS=yes` or `MALWARE_SCAN_API_VIRUSTOTAL_VOTE_HARMLESS=yes`
- **Data Shared**: Only SHA256 hash + verdict (malicious/harmless) - **No file contents**
- **Risk Level**: Low - Hash voting does not transfer personal data

**Hash Lookups** (VirusTotal, SentinelOne, MalwareBazaar):
- **Data Shared**: Only SHA256 hash - **No file contents**
- **Risk Level**: Low - Hashes alone are not personal data

---

## GDPR Compliance Measures

### 1. Data Minimization (Article 5(1)(c))

**Issue**: Sharing full IP addresses with third parties (Microsoft Teams/Discord) excessive for security alerting.

**Solution**: Implemented IP anonymization in webhooks (v0.7.2)
- IPv4: `192.168.1.123` ‚Üí `192.168.1.x`
- IPv6: `2001:db8:1234:5678:90ab:cdef:1234:5678` ‚Üí `2001:db8:1234:5678:90ab:cdef:1234:x`
- Enabled by default: `MALWARE_SCAN_ANONYMIZE_WEBHOOK_IPS=yes`
- Network-level information sufficient for security teams

**Code**: [malware_scan_webhook.lua:133-161](malware_scan_webhook.lua#L133-L161)

### 2. Storage Limitation (Article 5(1)(e))

**Requirement**: Personal data must be kept only as long as necessary for the purpose.

**Implementation**:
- Attacker tracking: 90 days default (configurable: `MALWARE_SCAN_TRACK_ATTACKER_TTL`)
- Scan results: 5 minutes (clean) / 90 days (malicious)
- Logs: Administrator controlled (recommend maximum 90 days)

**Rationale**:
- 90 days provides adequate time for law enforcement and legal proceedings
- Allows gathering comprehensive evidence of attack patterns
- Malicious file hashes rarely change, making long-term caching beneficial
- Balances security needs with privacy rights

### 3. Security of Processing (Article 32)

**Measures Implemented** (v0.7.14):
- ‚úÖ **Input validation** - Prevents command injection, path traversal (malware_scan_utils.lua)
- ‚úÖ **Data sanitization** - Prevents log injection attacks (malware_scan_utils.lua)
- ‚úÖ **Credential masking** - Automatic API key/token masking in logs (malware_scan_logger.lua)
- ‚úÖ **Filename sanitization** - Path traversal protection with validation (malware_scan_file.lua)
- ‚úÖ **Download integrity** - SHA256 checksum verification for all downloads (jobs/malware-scan-update.py)
- ‚úÖ **Access control** - Restrictive file system permissions
- ‚úÖ **Encryption in transit** - HTTPS webhooks and API calls
- ‚úÖ **Pseudonymization** - IP anonymization in webhooks (default: enabled)
- ‚úÖ **DoS protection** - File size limits and rate limiting
- ‚úÖ **Secure temporary files** - mktemp with Redis tracking for cleanup
- ‚úÖ **Email anonymization** - Automatic email redaction in logs (GDPR Article 5(1)(c))

**Enhanced Security Features** (v0.7.14):
- **Automatic Credential Masking**: All log messages automatically mask:
  - API keys (64 hex chars) ‚Üí `[APIKEY:abcd****9876]`
  - Long tokens (32+ chars) ‚Üí `[TOKEN:abc1****6789]`
  - Bearer tokens ‚Üí `Bearer [MASKED]`
  - Webhook URLs ‚Üí `https://hooks.***/[MASKED]`
  - Email addresses ‚Üí `***@***.***`
  - Password/key parameters in URLs ‚Üí `[MASKED]`

- **Download Integrity Verification**:
  - SHA256 checksum calculated for all downloaded files
  - **Published checksum verification** - Compares against official `.sha256` files from MalwareBazaar
  - Corrupted downloads detected and removed automatically
  - **Tampering detection** - Rejects files that don't match published checksums
  - Cached file tampering detection with checksum comparison
  - State persistence includes checksums for audit trail
  - **Double verification layer**: Calculated checksum + published checksum comparison

**Code References**:
- Input validation: [malware_scan_utils.lua:246-376](malware_scan_utils.lua#L246-L376)
- Credential masking: [malware_scan_logger.lua:52-100](malware_scan_logger.lua#L52-L100)
- Download verification: [jobs/malware-scan-update.py:313-385](jobs/malware-scan-update.py#L313-L385)
- Filename validation: [malware_scan_file.lua:156-163](malware_scan_file.lua#L156-L163)

### 4. Data Retention Policy (Article 5(1)(e))

**Automatic Data Expiry Implementation**:

The plugin implements automatic data expiry using TTL (Time To Live) mechanisms to ensure personal data is not retained longer than necessary:

#### Cache-Based Data (Redis TTL)
All cache entries automatically expire without manual intervention:

| Data Type | TTL | Auto-Deletion | Configuration |
|-----------|-----|---------------|---------------|
| Attacker tracking | 90 days | ‚úÖ Automatic | `MALWARE_SCAN_TRACK_ATTACKER_TTL` |
| Malicious file results | 90 days | ‚úÖ Automatic | `MALWARE_SCAN_CACHE_VIRUS_TTL` |
| Clean file results | 5 minutes | ‚úÖ Automatic | `MALWARE_SCAN_CACHE_CLEAN_TTL` |
| Shared database cache | 300 seconds | ‚úÖ Automatic | `MALWARE_SCAN_CACHE_SHARED_TTL` |

**Important TTL Behavior**:
- Attacker tracking TTL **resets on each new upload** from the same IP
- 90-day retention window is always measured from the **LAST upload**, not the first
- This extended retention for persistent attackers is justified by legitimate interest in gathering comprehensive evidence for law enforcement

#### Log-Based Data (Administrator Managed)
Application logs require administrator configuration:

| Data Type | Recommended Retention | Implementation | Responsibility |
|-----------|----------------------|----------------|----------------|
| Application logs | ‚â§90 days | logrotate or equivalent | Administrator |
| Audit logs (GDPR requests) | Longer (accountability) | Manual configuration | Administrator |
| Backup archives | Backup rotation period | Backup system | Administrator |

**Logrotate Example Configuration**:
```bash
/var/log/bunkerweb/*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
    create 0640 nginx adm
}
```

#### Automatic Cleanup on Restart
The plugin supports cache cleanup on restart for enhanced privacy:

| Configuration Variable | Effect |
|------------------------|--------|
| `MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ALL=yes` | Clear all cache on restart |
| `MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_CLAMAV=yes` | Clear ClamAV cache only |
| `MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_VIRUSTOTAL=yes` | Clear VirusTotal cache only |
| `MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_SENTINELONE=yes` | Clear SentinelOne cache only |
| `MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_MALWAREBAZAAR=yes` | Clear MalwareBazaar cache only |
| `MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ATTACKER_IPV4=yes` | Clear attacker tracking (IPv4) |
| `MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ATTACKER_IPV6=yes` | Clear attacker tracking (IPv6) |

**GDPR Erasure Compliance**:
- Manual deletion **not required** for cache data (TTL handles expiry automatically)
- Administrators should log erasure requests for audit trail per Article 5(2)
- Maximum retention period: 90 days from last upload (automatic expiry)

### 5. Transparency (Articles 13-14)

**Requirement**: Data subjects must be informed about data processing.

**Administrator Action Required**: Add privacy policy notice (see [Recommended Privacy Policy](#recommended-privacy-policy))

**Minimum Information to Provide**:
- Identity and contact details of data controller
- Purpose of processing (malware detection and security)
- Legal basis (legitimate interest)
- Legitimate interests pursued (infrastructure protection)
- Retention period (90 days cache, 90 days logs)
- Data subject rights (access, erasure, object)
- Right to lodge complaint with supervisory authority

---

## Administrator Responsibilities

### You Are the Data Controller

As a BunkerWeb administrator deploying the malware-scan plugin, **you** are the **data controller** under GDPR Article 4(7):

> "the natural or legal person [...] which, alone or jointly with others, determines the purposes and means of the processing of personal data"

The plugin is a tool/processor - you determine how it's used and are responsible for GDPR compliance.

### Your Obligations

#### 1. Privacy Policy (Articles 13-14)

**Required**: Yes
**Deadline**: Before collecting personal data
**Action**: Add malware scanning section to your website's privacy policy (see template below)

#### 2. Log Retention Policy (Article 5(1)(e))

**Required**: Yes
**Recommendation**: Maximum 90 days for malware-related logs
**Action**: Configure log rotation

```bash
# Example: logrotate configuration
/var/log/bunkerweb/*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
    create 0640 nginx adm
}
```

#### 3. Data Subject Rights (Articles 15-17, 20)

**Required**: Yes
**Action**: Implement process for handling access and erasure requests (see [Data Subject Rights](#data-subject-rights))

#### 4. Records of Processing Activities (Article 30)

**Required**: If your organization has 250+ employees OR processes special categories of personal data OR processing poses high risk
**Recommendation**: Document processing activities even if not required
**Action**: Maintain internal documentation of:
- What data is collected (IP addresses, timestamps, hashes)
- Why it's collected (security monitoring)
- Legal basis (legitimate interest)
- Retention period (90 days cache, 90 days logs)
- Security measures (encryption, access control)

#### 5. Data Protection Impact Assessment (Article 35)

**Required**: Only if processing is "likely to result in a high risk" (not typical for security monitoring)
**Action**: Not usually required for malware scanning

#### 6. International Data Transfer (Articles 44-50)

**Applies If**: Using webhooks to US-based services (Microsoft Teams, Discord)
**Issue**: US does not have adequate data protection per GDPR
**Mitigation**:
- Plugin anonymizes IPs by default (reduces risk)
- Consider EU-based webhook alternatives
- Document reliance on legitimate interest
- Add data transfer notice in privacy policy

---

## Data Subject Rights

### Overview

Data subjects (including attackers) have rights under GDPR even when legitimate interest applies:

| Right | Article | Your Obligation |
|-------|---------|-----------------|
| **Access** | 15 | Provide copy of data you hold |
| **Rectification** | 16 | Correct inaccurate data |
| **Erasure** | 17 | Delete data (with exceptions) |
| **Restriction** | 18 | Limit processing |
| **Portability** | 20 | Provide machine-readable format |
| **Object** | 21 | Stop processing unless compelling grounds |

### Important Exception: Article 17(3)(e)

You may **refuse erasure requests** if the data is needed:
> "for the establishment, exercise or defence of legal claims"

**This includes**: Evidence of malware attacks for potential legal proceedings.

---

## Handling Data Subject Access Requests (Article 15)

### Request Format

Data subjects must prove their identity. Common approaches:
- Request from the same IP address tracked
- Email with verification
- Formal written request with ID proof

### Steps to Process Access Request

#### 1. Verify Identity
Ensure requester is the data subject or authorized representative.

#### 2. Query Redis Cache

Check attacker tracking data:

```bash
# For IPv4
redis-cli GET "plugin_malware_scan_attacker_ipv4_192.168.1.123"

# For IPv6
redis-cli GET "plugin_malware_scan_attacker_ipv6_2001:db8:1234:5678:90ab:cdef:1234:5678"
```

**Output Example**:
```json
{
  "upload_count": 3,
  "first_upload": 1737277800,
  "last_upload": 1737291720,
  "checksums": ["abc123def456...", "789xyz012..."]
}
```

#### 3. Search Application Logs

Search for all log entries containing the IP address:

```bash
# Search logs
grep "192.168.1.123" /var/log/bunkerweb/*.log

# Search with date filter
find /var/log/bunkerweb/ -name "*.log" -mtime -90 -exec grep "192.168.1.123" {} +
```

#### 4. Prepare Response

Compile information into structured format:

```json
{
  "data_subject_ip": "192.168.1.123",
  "data_controller": "Your Organization Name",
  "request_date": "2026-01-19",
  "data_collected": {
    "attacker_tracking": {
      "upload_count": 3,
      "first_upload": "2026-01-19 10:30:00 UTC",
      "last_upload": "2026-01-19 14:22:15 UTC",
      "malware_hashes": ["abc123...", "789xyz..."]
    },
    "log_entries": [
      {
        "timestamp": "2026-01-19 10:30:00",
        "server": "www.example.com",
        "detection": "ClamAV: Win.Trojan.Zusy-9935890-0",
        "hash": "abc123def456..."
      }
    ]
  },
  "processing_details": {
    "purpose": "Malware detection and infrastructure protection",
    "legal_basis": "Legitimate interest (GDPR Article 6(1)(f))",
    "retention_period": "90 days (cache), up to 90 days (logs)",
    "recipients": "Microsoft Teams / Discord (if webhooks enabled, anonymized)",
    "rights": "Access, erasure (with exceptions), restriction, object"
  }
}
```

#### 5. Deliver Response

- **Deadline**: Within 1 month (Article 12(3))
- **Format**: Free of charge, electronic format preferred
- **Language**: Same language as request

---

## Handling Erasure Requests (Article 17)

### Evaluation Process

#### Step 1: Assess Legal Grounds for Refusal

You may refuse erasure if data is needed for **legal claims** (Article 17(3)(e)):

**Refuse if**:
- Evidence of ongoing attack
- Potential legal proceedings anticipated
- Required for law enforcement cooperation
- Needed to defend against lawsuits

**Grant if**:
- Single, isolated detection months ago
- No ongoing security concern
- No legal proceedings anticipated

#### Step 2: If Granting Erasure

**Automatic Data Expiry**:

The plugin uses TTL (Time To Live) for automatic data expiry:
- **Attacker tracking cache**: Expires automatically after 90 days (default, configurable via `MALWARE_SCAN_TRACK_ATTACKER_TTL`)
  - **Important**: TTL resets on each new malware upload from the same IP. For continuous attackers, the 90-day window is from the LAST upload.
- **Scan result cache**: Expires automatically after 5 minutes (clean files) or 90 days (malicious files)

**No manual deletion required** - the cache system handles expiry automatically.

**Action Required**: Log the erasure request for audit trail

```bash
# Log the erasure request (IMPORTANT: for audit trail)
echo "[$(date)] GDPR_ERASURE: Request from 192.168.1.123 - Status: GRANTED - Data expires via TTL (90 days)" >> /var/log/gdpr_requests.log
```

**Important Notes**:
- Data will be automatically deleted when TTL expires (maximum 90 days)
- Do NOT delete from application logs if needed for audit/legal purposes
- Keep erasure request log for accountability (Article 5(2))
- Inform data subject that cache data expires within 90 days automatically

#### Step 3: If Refusing Erasure

Document the refusal:

```bash
# Log the erasure request and reason for refusal
echo "[$(date)] GDPR_ERASURE: Request from 192.168.1.123 - Status: REFUSED - Reason: Evidence needed for legal claims (Art 17(3)(e))" >> /var/log/gdpr_requests.log
```

#### Step 4: Respond to Data Subject

**If granted**:
```
Your erasure request has been granted as of [DATE].

Data Retention Details:
- Cached data (Redis): Will expire automatically within 90 days via TTL (Time To Live)
- Application logs: May be retained for audit purposes per Article 17(3)(e)
- Backups: May contain data until backup rotation completes
- Erasure request: Logged for accountability per Article 5(2)

Your cached data will be automatically removed from our systems when the retention period
expires (maximum 90 days from last upload attempt).

Important: If you continue uploading malware, the 90-day window resets with each new upload,
extending the retention period. This extended period allows us to maintain evidence for
potential law enforcement cooperation and legal proceedings.
```

**If refused**:
```
Your erasure request has been evaluated and refused pursuant to GDPR Article 17(3)(e).

Reason: The data is necessary for the establishment, exercise, or defence of legal claims.
Specifically, the malware upload attempts from your IP address constitute evidence that may be
required in potential legal proceedings.

Your rights:
- You may object to processing under Article 21
- You may lodge a complaint with the supervisory authority: [Your DPA contact info]
- You may re-submit this request when legal proceedings are no longer anticipated
```

---

## Recommended Privacy Policy

Add this section to your website's privacy policy:

```markdown
## Malware Scanning and File Upload Security

### Overview

We use automated malware scanning to protect our infrastructure, services, and users from malicious uploads. This processing involves collecting and analyzing certain personal data as described below.

### What Data We Collect

When you upload files to our services, we collect and process:

- **IP address**: Your network address
- **Timestamp**: Date and time of upload attempt
- **File hash**: Cryptographic fingerprint (SHA256) of uploaded files
- **Detection results**: Malware scanner findings (if malicious content detected)
- **Upload history**: Number of malware upload attempts (if multiple detections)

### Why We Collect This Data

**Legal Basis**: Legitimate interest (GDPR Article 6(1)(f))

We have a legitimate interest in protecting our infrastructure and users from malware attacks. This interest includes:
- Detecting and blocking malware uploads
- Identifying repeat attackers
- Investigating security incidents
- Maintaining evidence for potential legal proceedings
- Alerting our security team to threats

**Balancing Test**: Our security interest in protecting infrastructure outweighs the privacy expectations of individuals attempting to upload malware.

### How Long We Keep Your Data

| Data Type | Retention Period | Reason |
|-----------|------------------|--------|
| Attacker tracking (cache) | 90 days | Evidence for law enforcement and legal proceedings |
| Scan results (cache) | 5 minutes to 90 days | Performance optimization and detection history |
| Application logs | Up to 90 days | Security monitoring and incident investigation |
| Audit logs | [Your retention period] | Legal compliance and accountability |

**Important**: The 90-day retention period for attacker tracking resets with each new malware upload from the same IP address. For continuous attackers, the retention window is always from the last upload attempt.

Data is automatically deleted when retention periods expire.

### Who We Share Your Data With

**Security Notifications** (Optional):

If malware is detected, we may send anonymized alerts to:
- **Microsoft Teams** (Microsoft Corporation, USA) - Security team notifications
- **Discord** (Discord Inc., USA) - Security team notifications

**Data Minimization**: IP addresses shared with third parties are anonymized (e.g., `192.168.1.123` becomes `192.168.1.x`) to minimize data exposure while maintaining network-level visibility for security purposes.

**‚ö†Ô∏è Malware File Uploads** (Optional but HIGH IMPACT):

**IMPORTANT**: If file upload sharing is enabled, detected malware files are uploaded to:

- **VirusTotal** (Google LLC, USA) - When `MALWARE_SCAN_API_VIRUSTOTAL_UPLOAD_UNKNOWN=yes`
- **MalwareBazaar** (abuse.ch, Switzerland) - When `MALWARE_SCAN_API_MALWAREBAZAAR_UPLOAD_UNKNOWN=yes`

**What This Means**:
- **Complete file contents** are transferred to third-party threat intelligence services
- **Files become part of public databases** accessible to security researchers worldwide
- **Files may contain personal data** (documents, emails, images, etc.)
- **Retention is indefinite** - Files remain in these databases permanently
- **You cannot request deletion** from VirusTotal or MalwareBazaar after upload

**Legal Basis**: This extensive data sharing may **not** be covered by legitimate interest alone. If you enable this feature:
- **Consult legal counsel** about appropriate legal basis
- **Consider obtaining explicit consent** from file uploaders
- **Add prominent notice** before file upload forms
- **Document justification** for this processing

**Configuration**: File uploads are **DISABLED by default** for GDPR compliance. Only enable if you have proper legal basis and user notification in place.

**International Transfer**: Microsoft, Discord, and Google (VirusTotal) are US-based companies. abuse.ch (MalwareBazaar) is based in Switzerland but makes files publicly accessible worldwide. The EU does not consider the USA to have adequate data protection. We rely on legitimate interest for security purposes and apply data minimization measures where possible.

### Your Rights

Under GDPR, you have the following rights:

#### Right to Access (Article 15)
You may request a copy of the data we hold about you by contacting: [Your contact email]

#### Right to Erasure (Article 17)
You may request deletion of your data by contacting: [Your contact email]

**Important**: We may refuse erasure requests if the data is necessary for establishing, exercising, or defending legal claims (e.g., evidence of malware attacks). This is permitted under Article 17(3)(e).

#### Right to Object (Article 21)
You may object to processing based on legitimate interest. We will cease processing unless we demonstrate compelling legitimate grounds that override your interests.

#### Right to Lodge a Complaint
If you believe we have violated GDPR, you may lodge a complaint with your national data protection authority:
- **EU Data Protection Authorities**: https://edpb.europa.eu/about-edpb/board/members_en
- **Your Local DPA**: [Insert local DPA contact information]

### Data Controller

The data controller responsible for this processing is:

**[Your Organization Name]**
[Your Address]
[Your Email]
[Your Phone]

### Data Protection Officer (if applicable)

If you have questions about data protection, you may contact our Data Protection Officer:

**[DPO Name]** (if required)
[DPO Email]

### Changes to This Policy

This privacy notice was last updated on [DATE]. We may update it periodically to reflect changes in our processing activities or legal requirements.

---

*Last updated: 2026-01-19*
```

---

## Compliance Checklist

Use this checklist to verify GDPR compliance before deploying in the EU:

### Configuration

- [ ] **IP Anonymization**: Verify `MALWARE_SCAN_ANONYMIZE_WEBHOOK_IPS=yes` (default)
- [ ] **Retention Period**: Set `MALWARE_SCAN_TRACK_ATTACKER_TTL` appropriately (default: 7776000 = 90 days)
- [ ] **Attacker Tracking**: Confirm `MALWARE_SCAN_TRACK_ATTACKERS` setting matches your needs
- [ ] **Webhooks**: If using Teams/Discord, understand international transfer implications
- [ ] **‚ö†Ô∏è VirusTotal File Uploads**: Verify `MALWARE_SCAN_API_VIRUSTOTAL_UPLOAD_UNKNOWN=no` (default: disabled)
  - [ ] If enabled: Documented legal basis (legitimate interest may be insufficient)
  - [ ] If enabled: Added prominent notice about public file sharing to privacy policy
  - [ ] If enabled: Considered consent requirement for file uploads
  - [ ] If enabled: Consulted legal counsel about GDPR Article 9 implications (special categories of data)
- [ ] **‚ö†Ô∏è MalwareBazaar File Uploads**: Verify `MALWARE_SCAN_API_MALWAREBAZAAR_UPLOAD_UNKNOWN=no` (default: disabled)
  - [ ] If enabled: Documented legal basis (legitimate interest may be insufficient)
  - [ ] If enabled: Added prominent notice about public file sharing to privacy policy
  - [ ] If enabled: Considered consent requirement for file uploads
  - [ ] If enabled: Consulted legal counsel about GDPR Article 9 implications (special categories of data)

### Documentation

- [ ] **Privacy Policy**: Added malware scanning section (see template above)
- [ ] **Legal Basis**: Documented legitimate interest justification
- [ ] **Retention Policy**: Defined and documented data retention periods
- [ ] **Records of Processing**: Created internal documentation per Article 30 (if required)
- [ ] **Contact Information**: Provided data controller contact details in privacy policy

### Operational

- [ ] **Log Rotation**: Configured log rotation with maximum retention (recommend 90 days)
- [ ] **Access Request Process**: Established procedure for handling data subject access requests
- [ ] **Erasure Request Process**: Established procedure for evaluating and processing erasure requests
- [ ] **Audit Logging**: Implemented logging for GDPR-related requests (access, erasure)
- [ ] **Staff Training**: Trained relevant staff on GDPR compliance and data subject rights

### Technical

- [ ] **Security Measures**: Verified Article 32 security measures in place (see section above)
- [ ] **Access Control**: Restricted file system permissions for logs and cache
- [ ] **Backup Policy**: Understood that backups may retain data beyond retention period

### Supervisory Authority

- [ ] **Identified Your DPA**: Know which data protection authority has jurisdiction
- [ ] **DPA Contact Info**: Added to privacy policy for complaint lodging

---

## Legal Disclaimer

This document provides guidance on GDPR compliance for the malware-scan plugin. It does not constitute legal advice. Each organization's GDPR obligations depend on specific circumstances, including:
- Jurisdiction and applicable regulations
- Organization size and structure
- Nature and scope of processing
- Supervisory authority interpretations

**Recommendation**: Consult with a qualified data protection lawyer or Data Protection Officer before deploying in production, especially for:
- High-risk processing activities
- Large-scale processing
- International data transfers
- Sensitive or special categories of personal data

---

## Additional Resources

### GDPR Official Sources

- **GDPR Full Text**: https://eur-lex.europa.eu/eli/reg/2016/679/oj
- **European Data Protection Board**: https://edpb.europa.eu/
- **Article 29 Working Party Guidelines**: https://ec.europa.eu/justice/article-29/documentation/opinion-recommendation/index_en.htm

### Key GDPR Concepts

- **Article 5**: Principles (lawfulness, fairness, transparency, purpose limitation, data minimization, storage limitation, accuracy, integrity, confidentiality, accountability)
- **Article 6**: Lawfulness of processing (consent, contract, legal obligation, vital interests, public task, legitimate interests)
- **Article 32**: Security of processing
- **Articles 15-22**: Data subject rights

### Case Law

- **CJEU Case C-582/14 (Breyer v Germany)**: IP addresses are personal data
- **CJEU Case C-311/18 (Schrems II)**: Invalidated Privacy Shield for EU-US data transfers

---

## Document History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-19 | Initial GDPR compliance documentation |
| 1.1 | 2026-01-25 | Added v0.7.13 security enhancements: automatic credential masking in logs, SHA256 download verification, enhanced data retention policy documentation, email anonymization |
| 1.2 | 2026-01-27 | Updated for v0.8.0: Enhanced architecture documentation for 21 modular components, improved security features, optional lfs dependency handling

---

## Contact

For questions about GDPR compliance in the malware-scan plugin, please:
- Open an issue: https://github.com/bunkerity/bunkerweb-plugins/issues


---

**Note to Administrators**: This document is maintained as part of the malware-scan plugin. As the data controller, you are responsible for adapting this guidance to your specific deployment and legal requirements.

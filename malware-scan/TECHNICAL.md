# Technical Documentation - Malware Scan Plugin

**Version**: 0.8.0 | **Last Updated**: 2026-01-27

This document provides technical details for developers working on the malware-scan plugin.

## Table of Contents

- [Architecture](#architecture)
- [How It Works](#how-it-works)
- [Security Features](#security-features)
- [Caching](#caching-strategy)
- [Error Handling](#error-handling)
- [Adding Features](#development)

## Architecture

### Plugin Structure

The plugin consists of 21 specialized modules that work together:

- **Core scanning** - ClamAV (local) + VirusTotal/SentinelOne (cloud)
- **Caching layer** - Fast result storage for repeated scans
- **File operations** - Safe file handling and hashing
- **Notifications** - Discord and Teams webhook alerts
- **Logging** - Secure logging with sensitive data masking
- **Configuration and monitoring** - Settings management and metrics

For complete module details, see the source code comments.

### Design Principles

The plugin is designed to be:

- **Modular** - Each component handles one specific task
- **Reliable** - If one scanner fails, others continue working
- **Cluster-aware** - Works correctly with BunkerWeb manager and worker nodes
- **Maintainable** - Clear separation between scanning, caching, APIs, and logging

## How It Works

### File Scanning Process

The plugin scans individual files extracted from uploads rather than the entire request. This is faster because:

- Each file has a consistent hash that can be cached
- Full request scans have random boundaries that change every upload (breaking caching)
- Individual file scanning is 75% faster on repeat uploads due to effective caching

The plugin only scans the full request body if you explicitly enable it, which is only needed in rare cases where malware might be split across file boundaries.

### Request Processing

When a file upload is detected:

1. Check if it's a file upload (multipart content type)
2. Extract uploaded files from request
3. Calculate file hash (SHA256)
4. Check if file is in allowlist
5. Check local ClamAV cache - if malware found, block immediately
6. Check cloud scanner caches - if malware found, block immediately
7. Run ClamAV scan if not cached
8. Run cloud scanners (VirusTotal, SentinelOne) if enabled
9. Block file if any scanner detects malware
10. Cache the result for faster future scans
11. Send webhook alert to Discord/Teams if blocked

## Security Features

The plugin protects against malware through:

- **Multiple scanning layers** - ClamAV (local) + VirusTotal + SentinelOne (cloud)
- **File type validation** - Checks file contents, not just extension
- **Filename safety** - Validates against path traversal and injection attacks
- **File size limits** - Prevents resource exhaustion (25MB for ClamAV, 64MB for hashing)
- **Caching** - Known malware blocked instantly without rescanning
- **Safe temporary files** - Uses secure temp storage, cleaned up after scanning

## Caching Strategy

Files are cached after scanning to speed up detection:

- **Clean files** are cached for 5 minutes (shorter cache in case new threats emerge)
- **Malicious files** are cached for 90 days (longer cache since threats rarely change)
- **Cache lookup** takes ~1 second vs ~4 seconds for full scan
- **Result**: 75% faster on repeat uploads

In typical production:
- Legitimate files: ~60% cache hit (same attachments uploaded repeatedly)
- Malware: ~95% cache hit (attackers reuse same payloads)

## Error Handling

If a scanner fails or becomes unavailable, the plugin:

- Logs the error for troubleshooting
- Continues with other available scanners
- Allows the file through if all scanners fail (better to allow than block legitimate uploads)
- Uses cached results when APIs hit rate limits

This "graceful degradation" means the plugin keeps working even if one component fails.

## Adding Features

To add a new scanner:

1. Create a new module file for the scanner
2. Implement cache check and storage functions
3. Register it in the plugin configuration
4. Add it to the scanning flow
5. Update webhook notifications to include results

Testing should verify that:

- First file upload takes ~4 seconds (full scan)
- Repeated uploads take ~1 second (cache hit)
- Files are properly cached and retrieved
- Errors in one scanner don't crash the plugin


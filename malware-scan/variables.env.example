# BunkerWeb Malware Scan Plugin - Configuration Variables
# Version: 0.8.0
# Copy to /etc/bunkerweb/variables.env and customize

# ============================================================================
# CORE SETTINGS
# ============================================================================

USE_MALWARE_SCANNER=yes                                    # Enable malware scanning
MALWARE_SCAN_DEBUG=no                                      # Enable debug logging (disable in production)

# ============================================================================
# CLAMAV SETTINGS
# ============================================================================

MALWARE_SCAN_CLAMAV_HOST=127.0.0.1                        # ClamAV daemon host
MALWARE_SCAN_CLAMAV_PORT=3310                             # ClamAV daemon port
MALWARE_SCAN_CLAMAV_TIMEOUT=10000                         # ClamAV connection timeout (ms)
MALWARE_SCAN_CLAMAV_MAX_SIZE=26214400                     # Max file size for ClamAV (25MB)
MALWARE_SCAN_CLAMAV_SOCKET=                               # ClamAV socket path (alternative to host:port, e.g., /var/run/clamav/clamd.ctl)
MALWARE_SCAN_HASH_MAX_SIZE=67108864                       # Max file size for hash scanners (64MB)

# ============================================================================
# ALLOW LIST (FALSE POSITIVE HANDLING) - v0.4.1+
# ============================================================================

MALWARE_SCAN_ALLOWLIST_HASHES=                            # Comma-separated SHA256 hashes to skip scanning
MALWARE_SCAN_ALLOWLIST_FILE=                              # Path to file with SHA256 hashes (one per line)

# ============================================================================
# MULTI-LAYER SCANNING
# ============================================================================

MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT=yes             # Skip cloud scanners if ClamAV detects (faster response)
MALWARE_SCAN_RESUME_SCAN_ON_FIRST_HIT=no                  # WARNING: DOS risk! Continue scanning after detection
MALWARE_SCAN_BLOCK_ON_FILENAME_INJECTION_ATTACK=yes       # Block on filename injection (path traversal, null bytes)
MALWARE_SCAN_SCAN_FULL_MULTIPART_BODY=no                  # Scan full multipart body (not recommended - random boundaries prevent caching)
MALWARE_SCAN_MAX_FILES_PER_REQUEST=100                    # Maximum number of files per multipart request (DoS protection)

# ============================================================================
# VIRUSTOTAL (70+ AV ENGINES + ML)
# ============================================================================

MALWARE_SCAN_API_USE_VIRUSTOTAL=no                        # Enable VirusTotal scanning
MALWARE_SCAN_API_VIRUSTOTAL_KEY=                          # VirusTotal API key (REQUIRED)
MALWARE_SCAN_API_VIRUSTOTAL_SUSPICIOUS=5                  # Suspicious if N+ engines flag
MALWARE_SCAN_API_VIRUSTOTAL_MALICIOUS=3                   # Malicious if N+ engines flag
MALWARE_SCAN_API_VIRUSTOTAL_UPLOAD_UNKNOWN=no             # Upload unknown malware to VirusTotal
MALWARE_SCAN_API_VIRUSTOTAL_AUTO_VOTE=yes                 # Auto-vote on uploaded files
MALWARE_SCAN_API_VIRUSTOTAL_MAX_UPLOAD_SIZE=33554432      # Max file size for VT upload (32MB)

# ============================================================================
# SENTINELONE (ENTERPRISE THREAT INTELLIGENCE)
# ============================================================================

MALWARE_SCAN_API_USE_SENTINELONE=no                       # Enable SentinelOne scanning
MALWARE_SCAN_API_SENTINELONE_URL=                         # SentinelOne console URL (REQUIRED)
MALWARE_SCAN_API_SENTINELONE_TOKEN=                       # SentinelOne API token (REQUIRED)

# ============================================================================
# THREAT INTELLIGENCE SHARING
# ============================================================================

MALWARE_SCAN_SHARE_FILES=no                               # Share detected files with VirusTotal (privacy/legal implications)

# ============================================================================
# WEBHOOK NOTIFICATIONS
# ============================================================================

MALWARE_SCAN_TEAMS_WEBHOOK_URL=                           # Microsoft Teams webhook URL
MALWARE_SCAN_TEAMS_WEBHOOK_RATE_LIMIT=3                   # Teams notifications per minute (max: 200)
MALWARE_SCAN_DISCORD_WEBHOOK_URL=                         # Discord webhook URL
MALWARE_SCAN_DISCORD_WEBHOOK_RATE_LIMIT=3                 # Discord notifications per minute (max: 30)
MALWARE_SCAN_ANONYMIZE_WEBHOOK_IPS=yes                    # Anonymize client IPs in webhook notifications (GDPR compliance)
# MALWARE_SCAN_UNMASK_KEYS=I_WANT_TO_LEAK_MY_SECRETS_TO_LOG  # Show full URLs in logs (SECURITY RISK - debugging only)

# ============================================================================
# ATTACKER TRACKING
# ============================================================================

MALWARE_SCAN_TRACK_ATTACKERS=yes                          # Track IPs that upload malware
MALWARE_SCAN_TRACK_ATTACKER_TTL=7776000                   # Track duration (90 days)

# ============================================================================
# CACHING
# ============================================================================

MALWARE_SCAN_USE_SHARED_DATABASE=yes                      # Enable Redis shared cache for clusters
MALWARE_SCAN_CACHE_VIRUS_TTL=7776000                      # Local cache TTL for malicious results (90 days)
MALWARE_SCAN_CACHE_CLEAN_TTL=300                          # Local cache TTL for clean results (5 minutes)
MALWARE_SCAN_CACHE_SHARED_TTL=21600                       # Redis cache TTL (6 hours)
MALWARE_SCAN_REDIS_CIRCUIT_BREAKER_MAX_BACKOFF=8          # Redis circuit breaker max backoff (seconds)

# Advanced cache configuration (most users don't need to change these)
MALWARE_SCAN_CACHE_ERROR_TTL=60                           # TTL for API error caching (seconds)
MALWARE_SCAN_CACHE_LOCK_TTL=60                            # Lock TTL for concurrent scan protection (seconds)
MALWARE_SCAN_CACHE_WAIT_TIMEOUT=30000                     # Wait timeout for lock release (milliseconds)
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ALL=no              # Clear ALL caches on restart (master switch)
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_CLAMAV=no           # Clear ClamAV cache (useful after signature updates)
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_VIRUSTOTAL=no       # Clear VirusTotal cache
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_SENTINELONE=no      # Clear SentinelOne cache
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ATTACKER_IPV4=no    # Clear IPv4 attacker tracking cache on restart
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_ATTACKER_IPV6=no    # Clear IPv6 attacker tracking cache on restart
MALWARE_SCAN_CACHE_CLEANUP_ON_RESTART_MALWAREBAZAAR=no    # Clear MalwareBazaar hash database on restart

# ============================================================================
# MALWAREBAZAAR HASH DATABASE
# ============================================================================

MALWARE_SCAN_MALWAREBAZAAR_HASH_LOOKUP=yes                # Enable MalwareBazaar hash lookup (1M+ known malware hashes)
MALWARE_SCAN_MALWAREBAZAAR_AUTO_UPDATE=yes                # Auto-update MalwareBazaar hash database from URL
MALWARE_SCAN_MALWAREBAZAAR_UPDATE_INTERVAL=86400          # Update interval in seconds (86400 = 24 hours)
MALWARE_SCAN_MALWAREBAZAAR_CSV_PATH=/var/lib/bunkerweb/malwarebazaar_hashes.csv  # Local path for MalwareBazaar hash database

# Advanced: Most users don't need to customize these URLs (used by scheduler jobs)
MALWARE_SCAN_MALWAREBAZAAR_UPDATE_URL_FULL=https://bazaar.sysangels.ai/bunkerweb/malwarebazaar_full_split.zip
MALWARE_SCAN_MALWAREBAZAAR_UPDATE_URL_RECENT=https://bazaar.sysangels.ai/bunkerweb/malwarebazaar_recent_split.zip

# ============================================================================
# CUSTOM HASHES (ADVANCED)
# ============================================================================

MALWARE_SCAN_CUSTOM_HASHES_ENABLED=no                     # Enable custom hash database
MALWARE_SCAN_CUSTOM_HASHES_AUTO_UPDATE=no                 # Auto-update custom hashes from URL
MALWARE_SCAN_CUSTOM_HASHES_UPDATE_URL=                    # URL to download custom hashes CSV
MALWARE_SCAN_CUSTOM_HASHES_CSV_PATH=/etc/bunkerweb/plugins/malware-scan/custom_hashes.csv  # Local CSV path

# ============================================================================
# FILE CLEANUP
# ============================================================================

MALWARE_SCAN_CLEANUP_FILES=yes                            # Auto-cleanup detected malware files
MALWARE_SCAN_CLEANUP_ORPHANED=yes                         # Cleanup orphaned temp files (workers only)
MALWARE_SCAN_CLEANUP_AGE=3600                             # Cleanup files older than N seconds (1 hour)

# ============================================================================
# MEMORY UPLOADS
# ============================================================================

MALWARE_SCAN_BLOCK_MEMORY_UPLOADS=yes                     # Block uploads buffered in memory (can't be scanned)

# ============================================================================
# FORENSICS & SAMPLE COLLECTION
# ============================================================================

MALWARE_SCAN_VIRUSFILE_LOCAL_EXPORT_PATH=                 # Path to export detected malware samples (for forensic analysis)

# ============================================================================
# NOTES
# ============================================================================

# - Replace empty values with actual API keys/URLs before use
# - For clusters: Deploy plugin files to ALL nodes (manager + workers)
# - SECURITY: Store this file as /etc/bunkerweb/variables.env with chmod 600
# - Allow list (v0.4.1+): Use in-memory caching for 50-200x faster lookups
# - Cleanup runs on workers only (they handle file uploads)
# - See all-features-enabled.md for detailed documentation

-- BunkerWeb Malware Scan - VirusTotal Scanner Module
-- Handles all VirusTotal API integration for file hash lookups, uploads, and voting

local cjson = require("cjson")
local http = require("resty.http")

local ngx = ngx
local ERR = ngx.ERR
local NOTICE = ngx.NOTICE
local WARN = ngx.WARN
local decode = cjson.decode
local encode = cjson.encode
local http_new = http.new
local tonumber = tonumber
local tostring = tostring

-- Module table
local virustotal = {}

-- Cache module reference (will be set when module is loaded)
local cache = nil

-- File operations module reference (will be set when module is loaded)
local file_ops = nil

-- Plugin version for User-Agent identification
local VERSION = "0.3.0"
local USER_AGENT = "bunkerweb - https://github.com/bunkerity/bunkerweb - malware-scan module v" .. VERSION

-- Set cache module reference (called during initialization)
function virustotal.set_cache_module(cache_module)
	cache = cache_module
end

-- Set file operations module reference (called during initialization)
function virustotal.set_file_ops_module(file_ops_module)
	file_ops = file_ops_module
end

-- ============================================================================
-- VIRUSTOTAL FILE LOOKUP
-- ============================================================================

-- Check file hash against VirusTotal database.
-- Takes file path and SHA256 checksum, returns success boolean, result, and found boolean.
-- Returns ("clean", false) if file not found on VT, or (verdict, true) if found.
function virustotal.check_virustotal(plugin, file_path, checksum)
	-- Check if VirusTotal is enabled
	if plugin.variables["MALWARE_SCAN_API_USE_VIRUSTOTAL"] ~= "yes" then
		return true, "clean", false
	end

	-- Check if API key is configured and not a default value
	local api_key = plugin.variables["MALWARE_SCAN_API_VIRUSTOTAL_KEY"]
	if not api_key or api_key == "" or api_key == "your_api_key" or api_key == "your_token" then
		plugin.logger:log(ERR, "VirusTotal enabled but API key not configured or using default value")
		return true, "clean", false
	end

	-- Get file size for cache verification
	local file_size = file_ops and file_ops.get_file_size(plugin, file_path) or nil

	-- Check cache if cache module is available
	if cache then
		local ok, cached, cached_size = cache.is_in_vt_cache(plugin, checksum, file_size)
		if ok and cached then
			plugin.logger:log(ERR, "file checksum " .. checksum .. " found in VT cache: " .. cached)
			-- Assume if it's in cache, it was found before
			return true, cached, true
		end
	end

	-- Request from VirusTotal API
	plugin.logger:log(ERR, "sending request to VirusTotal API for checksum: " .. checksum)
	local found, response
	local ok, found, response = virustotal.virustotal_request(plugin, "/files/" .. checksum)
	if not ok then
		plugin.logger:log(ERR, "VirusTotal API request failed: " .. found)
		return true, "clean", false
	end

	local result = "clean"
	if found then
		plugin.logger:log(ERR, "file found on VirusTotal, analyzing results")
		result = virustotal.get_virustotal_result(plugin, response)
		plugin.logger:log(ERR, "VirusTotal result: " .. result)
	else
		plugin.logger:log(ERR, "file checksum " .. checksum .. " not found on VirusTotal (new file)")
	end

	-- Add to cache if cache module is available
	if cache then
		local ok, err = cache.add_to_vt_cache(plugin, checksum, result, file_size)
		if not ok then
			plugin.logger:log(ERR, "can't cache VT result: " .. err)
		end
	end

	-- Track new result for composite Redis write
	if plugin.ctx.bw.new_scan_results then
		plugin.ctx.bw.new_scan_results.vt = result
	end

	return true, result, found
end

-- ============================================================================
-- VIRUSTOTAL API REQUEST
-- ============================================================================

-- Make HTTP request to VirusTotal API.
-- Takes API endpoint URL, returns success boolean, found boolean, and response data.
function virustotal.virustotal_request(plugin, url)
	-- Get HTTP client
	local httpc, err = http_new()
	if not httpc then
		return false, err
	end

	-- Send request
	local res
	res, err = httpc:request_uri("https://www.virustotal.com/api/v3" .. url, {
		headers = {
			["x-apikey"] = plugin.variables["MALWARE_SCAN_API_VIRUSTOTAL_KEY"],
			["accept"] = "application/json",
			["User-Agent"] = USER_AGENT,
		},
	})
	if not res then
		return false, err
	end

	-- Check status
	if res.status == 404 then
		return true, false
	end
	if res.status ~= 200 then
		err = "received status " .. tostring(res.status) .. " from VirusTotal API"
		local ok, data = pcall(decode, res.body)
		if ok and data then
			err = err .. " with data " .. encode(data)
		end
		return false, err
	end

	-- Parse JSON response
	local ok, data = pcall(decode, res.body)
	if not ok then
		return false, "failed to decode JSON: " .. data
	end
	if not data.data or not data.data.attributes or not data.data.attributes.last_analysis_stats then
		return false, "malformed JSON response from VirusTotal"
	end

	return true, true, data.data.attributes.last_analysis_stats
end

-- ============================================================================
-- VIRUSTOTAL RESULT PROCESSING
-- ============================================================================

-- Process VirusTotal analysis stats and determine if file is malicious.
-- Takes response stats, returns result string ("clean" or description of detections).
function virustotal.get_virustotal_result(plugin, response)
	local suspicious = response["suspicious"] or 0
	local malicious = response["malicious"] or 0

	local suspicious_threshold = tonumber(plugin.variables["MALWARE_SCAN_API_VIRUSTOTAL_SUSPICIOUS"]) or 5
	local malicious_threshold = tonumber(plugin.variables["MALWARE_SCAN_API_VIRUSTOTAL_MALICIOUS"]) or 3

	if suspicious > suspicious_threshold or malicious > malicious_threshold then
		return tostring(suspicious) .. " suspicious and " .. tostring(malicious) .. " malicious"
	end

	return "clean"
end

-- ============================================================================
-- VIRUSTOTAL FILE UPLOAD
-- ============================================================================

-- Upload file to VirusTotal for analysis.
-- Takes file path, returns success boolean, analysis ID or error message, and file size.
-- Only uploads files smaller than the configured max size (default 32MB).
function virustotal.virustotal_upload_file(plugin, file_path)
	plugin.logger:log(ERR, "preparing to upload file to VirusTotal")

	-- Extract file content from multipart body
	if not file_ops then
		return false, "file_ops module not loaded - cannot upload file"
	end

	local ok, file_content = file_ops.extract_file_content(plugin, file_path)
	if not ok then
		return false, "failed to extract file content: " .. file_content
	end

	local file_size = #file_content
	plugin:log_debug("extracted file size: " .. file_size .. " bytes")

	-- Check file size against max upload size
	local max_size = tonumber(plugin.variables["MALWARE_SCAN_API_VIRUSTOTAL_MAX_UPLOAD_SIZE"]) or 33554432
	if file_size > max_size then
		plugin.logger:log(ERR, "file too large for VirusTotal upload: " .. file_size .. " bytes (max: " .. max_size .. " bytes)")
		return false, "file too large for upload (max " .. max_size .. " bytes)"
	end

	plugin.logger:log(ERR, "uploading file to VirusTotal (" .. file_size .. " bytes)")

	-- Get HTTP client
	local httpc, err = http_new()
	if not httpc then
		return false, err
	end

	-- Create multipart/form-data boundary
	local boundary = "----WebKitFormBoundary" .. ngx.time()

	-- Build multipart body
	local body_parts = {}
	table.insert(body_parts, "--" .. boundary .. "\r\n")
	table.insert(body_parts, 'Content-Disposition: form-data; name="file"; filename="upload"\r\n')
	table.insert(body_parts, "Content-Type: application/octet-stream\r\n\r\n")
	table.insert(body_parts, file_content)
	table.insert(body_parts, "\r\n--" .. boundary .. "--\r\n")

	local upload_body = table.concat(body_parts)

	-- Send upload request
	local res
	res, err = httpc:request_uri("https://www.virustotal.com/api/v3/files", {
		method = "POST",
		headers = {
			["x-apikey"] = plugin.variables["MALWARE_SCAN_API_VIRUSTOTAL_KEY"],
			["accept"] = "application/json",
			["Content-Type"] = "multipart/form-data; boundary=" .. boundary,
			["Content-Length"] = tostring(#upload_body),
			["User-Agent"] = USER_AGENT,
		},
		body = upload_body,
	})

	if not res then
		return false, err
	end

	-- Check status
	if res.status ~= 200 then
		err = "received status " .. tostring(res.status) .. " from VirusTotal upload API"
		local decode_ok, data = pcall(decode, res.body)
		if decode_ok and data then
			err = err .. " with data " .. encode(data)
		end
		return false, err
	end

	-- Parse JSON response
	local decode_ok, data = pcall(decode, res.body)
	if not decode_ok then
		return false, "failed to decode JSON: " .. data
	end

	-- Extract analysis ID from response
	local analysis_id = nil
	if data.data and data.data.id then
		analysis_id = data.data.id
		plugin.logger:log(ERR, "file uploaded to VirusTotal successfully, analysis ID: " .. analysis_id)
	else
		plugin.logger:log(ERR, "file uploaded but no analysis ID returned")
	end

	return true, analysis_id, file_size
end

-- ============================================================================
-- VIRUSTOTAL VOTING
-- ============================================================================

-- Vote on a file in VirusTotal.
-- Takes SHA256 checksum and verdict ("harmless" or "malicious").
-- Returns success boolean and error message if failed.
function virustotal.virustotal_vote(plugin, checksum, verdict)
	plugin.logger:log(ERR, "voting on VirusTotal file " .. checksum .. " as " .. verdict)

	-- Validate verdict
	if verdict ~= "harmless" and verdict ~= "malicious" then
		return false, "invalid verdict: " .. verdict .. " (must be 'harmless' or 'malicious')"
	end

	-- Get HTTP client
	local httpc, err = http_new()
	if not httpc then
		return false, err
	end

	-- Build vote request body
	local vote_data = {
		data = {
			type = "vote",
			attributes = {
				verdict = verdict
			}
		}
	}

	local body = encode(vote_data)

	-- Send vote request
	local res
	res, err = httpc:request_uri("https://www.virustotal.com/api/v3/files/" .. checksum .. "/votes", {
		method = "POST",
		headers = {
			["x-apikey"] = plugin.variables["MALWARE_SCAN_API_VIRUSTOTAL_KEY"],
			["accept"] = "application/json",
			["Content-Type"] = "application/json",
			["Content-Length"] = tostring(#body),
			["User-Agent"] = USER_AGENT,
		},
		body = body,
	})

	if not res then
		return false, err
	end

	-- Check status (200 or 201 are success)
	if res.status ~= 200 and res.status ~= 201 then
		err = "received status " .. tostring(res.status) .. " from VirusTotal vote API"
		local decode_ok, data = pcall(decode, res.body)
		if decode_ok and data then
			err = err .. " with data " .. encode(data)
		end
		return false, err
	end

	plugin.logger:log(ERR, "vote submitted successfully to VirusTotal")
	return true
end

-- Return module
return virustotal

#!/bin/bash
# Verify which files need deployment to fix Redis issue

echo "========================================="
echo "Deployment Verification"
echo "========================================="
echo ""
echo "Checking files that need deployment..."
echo ""

LOCAL_DIR="/Users/mkf/Documents/GitHub/bunkerweb-plugins/malware-scan"
REMOTE_HOST="waf-mgr"  # or waf01/waf02
REMOTE_DIR="/etc/bunkerweb/plugins/malware-scan"

echo "1. plugin.json - CRITICAL (adds 'requires: [\"redis\"]')"
echo "   Local file:"
grep -A1 '"stream"' "$LOCAL_DIR/plugin.json" | grep requires
if [ $? -eq 0 ]; then
    echo "   ✅ Local file has 'requires' field"
else
    echo "   ❌ Local file missing 'requires' field"
fi
echo ""

echo "2. malware_scan_init.lua - REQUIRED (removes cache setup call)"
grep -n "MalwareBazaar uses Redis directly" "$LOCAL_DIR/malware_scan_init.lua" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "   ✅ Local file has fix (lines 236-237)"
else
    echo "   ❌ Local file missing fix"
fi
echo ""

echo "3. malware_scan_orchestrator.lua - REQUIRED (MalwareBazaar integration)"
grep -n "MALWAREBAZAAR HASH LOOKUP" "$LOCAL_DIR/malware_scan_orchestrator.lua" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "   ✅ Local file has MalwareBazaar integration"
else
    echo "   ❌ Local file missing integration"
fi
echo ""

echo "4. malware_scan_malwarebazaar.lua - REQUIRED (Redis hash lookup)"
grep -n "get_hash_bucket" "$LOCAL_DIR/malware_scan_malwarebazaar.lua" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "   ✅ Local file has Redis bucketing"
else
    echo "   ❌ Local file missing Redis implementation"
fi
echo ""

echo "========================================="
echo "Deployment Commands"
echo "========================================="
echo ""
echo "To deploy these files to production, run:"
echo ""
echo "# Method 1: SCP to waf-mgr (recommended)"
echo "cd $LOCAL_DIR"
echo "scp plugin.json root@$REMOTE_HOST:$REMOTE_DIR/"
echo "scp malware_scan_init.lua root@$REMOTE_HOST:$REMOTE_DIR/"
echo "scp malware_scan_orchestrator.lua root@$REMOTE_HOST:$REMOTE_DIR/"
echo "scp malware_scan_malwarebazaar.lua root@$REMOTE_HOST:$REMOTE_DIR/"
echo "ssh root@$REMOTE_HOST 'systemctl restart bunkerweb*'"
echo ""
echo "# Method 2: Use deployment script"
echo "ssh root@$REMOTE_HOST 'cd $REMOTE_DIR && ./deploy-fix.sh'"
echo ""
echo "========================================="
echo "Expected Result After Deployment"
echo "========================================="
echo ""
echo "After deployment and restart, you should see:"
echo "  ✅ No 'Redis not available' errors"
echo "  ✅ [MALWAREBAZAAR] ✓ HASH MATCH: 15f5bedc... = Mirai"
echo "  ✅ HTTP 403 (blocked) for Mirai sample"
echo ""

-- BunkerWeb Malware Scan - ThreatFox Scanner Module
-- Handles all ThreatFox API integration for IOC hash lookups

local cjson = require("cjson")
local http = require("resty.http")

local ngx = ngx
local ERR = ngx.ERR
local decode = cjson.decode
local encode = cjson.encode
local http_new = http.new
local tostring = tostring
local string = string

-- Module table
local threatfox = {}

-- Cache module reference (will be set when module is loaded)
local cache = nil

-- Plugin version for User-Agent identification
local VERSION = "0.3.0"
local USER_AGENT = "bunkerweb - https://github.com/bunkerity/bunkerweb - malware-scan module v" .. VERSION

-- Set cache module reference (called during initialization)
function threatfox.set_cache_module(cache_module)
	cache = cache_module
end

-- ============================================================================
-- THREATFOX IOC LOOKUP
-- ============================================================================

-- Check file hash against ThreatFox IOC database.
-- Takes SHA256 checksum and optional file_size, returns success boolean and result.
-- Returns "clean" if not found, or malware info string if found.
function threatfox.check_threatfox(plugin, checksum, file_size)
	-- Check if ThreatFox is enabled
	if plugin.variables["MALWARE_SCAN_API_USE_THREATFOX"] ~= "yes" then
		return true, "clean"
	end

	-- Check cache first if cache module is available
	if cache then
		local ok, cached, cached_size = cache.is_in_threatfox_cache(plugin, checksum, file_size)
		if ok and cached then
			plugin.logger:log(ERR, "file checksum " .. checksum .. " found in ThreatFox cache: " .. cached)
			return true, cached
		end
	end

	-- Request from ThreatFox API
	plugin.logger:log(ERR, "sending request to ThreatFox API for checksum: " .. checksum)
	local found, malware_info
	local ok, found, malware_info = threatfox.threatfox_request(plugin, checksum)
	if not ok then
		plugin.logger:log(ERR, "ThreatFox API request failed: " .. found)
		return true, "clean"
	end

	local result = "clean"
	if found then
		plugin.logger:log(ERR, "file hash found in ThreatFox IOC database")
		result = malware_info
		plugin.logger:log(ERR, "ThreatFox result: " .. result)
	else
		plugin.logger:log(ERR, "file checksum " .. checksum .. " not found in ThreatFox")
	end

	-- Add to cache if cache module is available
	if cache then
		local ok, err = cache.add_to_threatfox_cache(plugin, checksum, result, file_size)
		if not ok then
			plugin.logger:log(ERR, "can't cache ThreatFox result: " .. err)
		end
	end

	-- Track new result for composite Redis write
	if plugin.ctx.bw.new_scan_results then
		plugin.ctx.bw.new_scan_results.threatfox = result
	end

	return true, result
end

-- ============================================================================
-- THREATFOX API REQUEST
-- ============================================================================

-- Make HTTP request to ThreatFox API.
-- Takes hash (SHA256 or MD5), returns success boolean, found boolean, and malware info.
function threatfox.threatfox_request(plugin, hash)
	-- Get HTTP client
	local httpc, err = http_new()
	if not httpc then
		return false, err
	end

	-- Get API key (required for ThreatFox) and check for default values
	local api_key = plugin.variables["MALWARE_SCAN_API_THREATFOX_KEY"]
	if not api_key or api_key == "" or api_key == "your_api_key" or api_key == "your_token" then
		return false, "ThreatFox API key is required but not configured or using default value"
	end

	-- Build request body
	local request_data = {
		query = "search_hash",
		hash = hash
	}

	local body = encode(request_data)

	-- Send request with Auth-Key in HTTP header
	local res
	res, err = httpc:request_uri("https://threatfox-api.abuse.ch/api/v1/", {
		method = "POST",
		headers = {
			["Auth-Key"] = api_key,
			["Content-Type"] = "application/json",
			["accept"] = "application/json",
			["Content-Length"] = tostring(#body),
			["User-Agent"] = USER_AGENT,
		},
		body = body,
	})

	if not res then
		return false, err
	end

	-- Check status
	if res.status ~= 200 then
		err = "received status " .. tostring(res.status) .. " from ThreatFox API"
		local decode_ok, data = pcall(decode, res.body)
		if decode_ok and data then
			err = err .. " with data " .. encode(data)
		end
		return false, err
	end

	-- Parse JSON response
	local decode_ok, data = pcall(decode, res.body)
	if not decode_ok then
		return false, "failed to decode JSON: " .. data
	end

	-- Check query status
	if not data.query_status then
		return false, "malformed JSON response from ThreatFox"
	end

	if data.query_status == "no_result" then
		-- Hash not found in ThreatFox
		return true, false
	end

	if data.query_status ~= "ok" then
		return false, "ThreatFox query failed: " .. data.query_status
	end

	-- Extract malware information
	if not data.data or #data.data == 0 then
		return true, false
	end

	-- Build malware info string from first IOC
	local ioc = data.data[1]
	local malware_name = ioc.malware_printable or ioc.malware or "unknown"
	local threat_type = ioc.threat_type_desc or ioc.threat_type or "unknown"
	local confidence = ioc.confidence_level or 0
	local ioc_count = #data.data

	local malware_info = string.format(
		"%s (%s, confidence: %d%%, %d IOCs)",
		malware_name,
		threat_type,
		confidence,
		ioc_count
	)

	return true, true, malware_info
end

-- Return module
return threatfox

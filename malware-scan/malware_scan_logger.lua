-- BunkerWeb Malware Scan - Centralized Logger Module
-- Logs to BunkerWeb default logs via errlog.raw_log()
--
-- Features:
-- - Sanitizes sensitive data (API keys, tokens, webhooks, emails)
-- - Version-tagged log messages
-- - Standard nginx log levels (ERR, WARN, NOTICE, INFO)
-- - Uses BunkerWeb's logging pipeline with [MALWARE-SCAN] prefix
--
-- Version: 0.8.0
-- Date: 2026-01-27

local logger = {}

-- Module version
logger.VERSION = "0.8.0"

-- ============================================================================
-- SHARED TYPE ALIASES (for Lua Language Server)
-- ============================================================================
-- Plugin class is defined in malware_scan_scheduler.lua

---@alias Optional table|nil Optional value (nil or typed)
---@alias Dependencies table Module dependencies and configuration
---@alias Path string File or directory path
---@alias Remote string Remote URL or resource identifier
---@alias Download string Downloaded file content or metadata
---@alias Local string Local file or cache reference
---@alias Temporary string Temporary storage reference
---@alias Base string Base URL or directory
---@alias Update table Update operation metadata
---@alias Timeout number Connection or operation timeout value
---@alias Configuration table Configuration settings and variables
---@alias Directory string Directory path
---@alias SHA256 string SHA256 hash string
---@alias Name string Name or identifier
---@alias Detection string Malware detection signature or result
---@alias MIME string MIME type string
---@alias Table table Lua table (generic)
---@alias Log table Logger instance
---@alias File table File operations or file path
---@alias UI table User interface module
---@alias Webhook table Webhook notification module
---@alias Function function Lua function
---@alias Cache table Cache storage module
---@alias The table Generic table (for descriptions)

local errlog = require("ngx.errlog")
local ngx = ngx
local ERR = ngx.ERR
local WARN = ngx.WARN
local NOTICE = ngx.NOTICE
local INFO = ngx.INFO
local raw_log = errlog.raw_log

-- ============================================================================
-- LOG MESSAGE SANITIZATION
-- ============================================================================

-- Sanitize log messages to mask sensitive data (API keys, tokens, webhook URLs).
-- Automatically detects and masks common sensitive patterns to prevent credential leakage.
--
-- Patterns masked:
-- - API keys (64 hex chars) -> [APIKEY:****]
-- - Tokens (32+ alphanumeric) -> [TOKEN:****]
-- - Bearer tokens -> Bearer [MASKED]
-- - Webhook URLs -> https://hooks.***[MASKED]
-- - Email addresses -> ***@***.*** (for GDPR compliance)
--
--- @param message string log message to sanitize
--- @return string sanitized_message Sanitized message with sensitive data masked
local function logger_sanitize_log_message(message)
	if not message or type(message) ~= "string" then
		return tostring(message)
	end

	local sanitized = message

	-- Mask VirusTotal-style API keys (64 hex characters)
	-- Example: abcd1234...9876 -> [APIKEY:abcd****9876]
	sanitized = sanitized:gsub("([a-fA-F0-9]{64})", function(key)
		return "[APIKEY:" .. key:sub(1, 4) .. "****" .. key:sub(-4) .. "]"
	end)

	-- Mask long alphanumeric tokens (32+ characters, likely auth tokens)
	-- Example: abc123xyz456... -> [TOKEN:abc1****6789]
	sanitized = sanitized:gsub("([a-zA-Z0-9_-]{32,})", function(token)
		-- Skip if it looks like a hash checksum in valid context
		if token:match("^[a-fA-F0-9]+$") and (
			message:match("checksum") or
			message:match("hash") or
			message:match("SHA256") or
			message:match("MD5")
		) then
			return token
		end
		return "[TOKEN:" .. token:sub(1, 4) .. "****" .. token:sub(-4) .. "]"
	end)

	-- Mask Bearer tokens in Authorization headers
	sanitized = sanitized:gsub("Bearer%s+([a-zA-Z0-9_-]+)", "Bearer [MASKED]")

	-- Mask webhook URLs (Teams, Discord, Slack, etc.)
	-- Example: https://hooks.slack.com/services/T00/B00/XXXX -> https://hooks.***/[MASKED]
	sanitized = sanitized:gsub("(https?://[^%s]*webhook[^%s]*)", function(url)
		local host = url:match("^(https?://[^/]+)")
		if host then
			return host:gsub("([^/]+//[^/]+)", "%1") .. "/***[MASKED]"
		end
		return "https://***[MASKED]"
	end)
	sanitized = sanitized:gsub("(https?://hooks%.[^%s]+)", "https://hooks.***/[MASKED]")

	-- Mask email addresses for GDPR compliance
	-- Example: user@example.com -> ***@***.***
	sanitized = sanitized:gsub("([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+%.[a-zA-Z]{2,})", "***@***.***")

	-- Mask common password/key patterns in URLs or config
	sanitized = sanitized:gsub("([?&])password=([^&%s]+)", "%1password=[MASKED]")
	sanitized = sanitized:gsub("([?&])token=([^&%s]+)", "%1token=[MASKED]")
	sanitized = sanitized:gsub("([?&])key=([^&%s]+)", "%1key=[MASKED]")

	return sanitized
end

-- ============================================================================
-- CORE LOGGING FUNCTIONS
-- ============================================================================

-- Simple logging function - writes to BunkerWeb default logs via errlog.raw_log()
-- Uses same mechanism as BunkerWeb's core logger for consistent log routing
--- @param level Log level (ERR, WARN, NOTICE, INFO)
--- @param message string Log message
local function logger_log_simple(level, message)
	-- Sanitize message to mask sensitive data (API keys, tokens, emails, webhooks)
	local sanitized_message = logger_sanitize_log_message(message)

	-- Add MALWARE-SCAN prefix (like BunkerWeb's logger) + version tag
	local prefixed_message = "[MALWARE-SCAN] [v" .. logger.VERSION .. "] " .. sanitized_message

	-- Write to BunkerWeb logs using errlog.raw_log (same as BunkerWeb's logger)
	raw_log(level, prefixed_message)
end

-- ============================================================================
-- PUBLIC API - Convenience Wrappers
-- ============================================================================

-- Log at ERROR level
--- @param message string Log message
function logger.log_error(message)
	logger_log_simple(ERR, message)
end

-- Log at WARN level
--- @param message string Log message
function logger.log_warn(message)
	logger_log_simple(WARN, message)
end

-- Log at NOTICE level
--- @param message string Log message
function logger.log_notice(message)
	logger_log_simple(NOTICE, message)
end

-- Log at INFO level
--- @param message string Log message
function logger.log_info(message)
	logger_log_simple(INFO, message)
end

-- Generic log function with level parameter
--- @param level Log level (ERR, WARN, NOTICE, INFO)
--- @param message string Log message
function logger.log(level, message)
	logger_log_simple(level, message)
end

return logger

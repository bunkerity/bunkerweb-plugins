# Security Policy

## Vulnerability Reporting

If you discover a security vulnerability in the BunkerWeb malware-scan plugin, please report it responsibly:

1. **Do NOT** open a public GitHub issue
2. Email security details to both: 
 security [@] bunkerity.com (BunkerWeb)
 mkf [@] sysangels.ai (the main dev of this module)
3. Include:
   - Description of the vulnerability
   - Steps to reproduce
   - Potential impact
   - Suggested fix (if available)

We will respond within 48 hours and work with you to address the issue.

## Software Bill of Materials (SBOM)

This plugin includes a CycloneDX SBOM ([sbom.json](sbom.json)) that tracks all bundled code dependencies:

### Dependencies Tracked

**OpenResty Libraries** (bundled with OpenResty/Nginx):
- `lua-resty-string@0.15` - String utilities and SHA256 hashing
- `lua-resty-core@0.1.28` - OpenResty FFI-based Lua API
- `lua-cjson@2.1.0` - JSON encoding/parsing
- `lua-resty-http@0.17.1` - HTTP client for API calls

**External Runtime Requirements** (NOT tracked in SBOM):

Users are responsible for installing and maintaining these external components:
- **ClamAV** - Antivirus engine (required)
- **BunkerWeb** - WAF platform (required)
- **Redis** - Cluster cache (optional)

The SBOM only tracks actual code dependencies bundled with the plugin, not external infrastructure that users manage independently.

### GitHub Security Alerts

The SBOM is automatically submitted to GitHub's dependency graph via GitHub Actions for the OpenResty libraries. This enables:

- **Automated vulnerability scanning**: GitHub scans OpenResty library dependencies for known CVEs
- **Dependabot security alerts**: Automatic notifications when vulnerabilities are discovered in tracked libraries
- **Security advisory dashboard**: View library security issues in the repository Security tab
- **Dependency insights**: Track OpenResty library versions and update recommendations

**Note**: External components (ClamAV, BunkerWeb, Redis) are NOT tracked in the SBOM. Users must monitor security updates for these independently.

### Viewing Security Alerts

1. Navigate to repository **Security** tab
2. Click **Dependabot alerts** to see vulnerable dependencies
3. Review recommended updates and patches
4. Check **Security advisories** for disclosed vulnerabilities

### Updating Dependencies

**For OpenResty Libraries** (tracked in SBOM):

When security alerts are received for `lua-resty-*` libraries:
1. Review the vulnerability details and impact
2. Check if the vulnerability affects this plugin's usage
3. Update the dependency version in code (if using specific version)
4. Update `sbom.json` with new version
5. Test thoroughly
6. Commit and push (triggers automatic SBOM upload)

**For External Components** (NOT tracked in SBOM):

Users must monitor and update these independently:
- **ClamAV**: Subscribe to ClamAV security advisories at https://www.clamav.net/
  - Update: `sudo apt update && sudo apt upgrade clamav clamav-daemon`
- **BunkerWeb**: Monitor https://github.com/bunkerity/bunkerweb/security
  - Update: Follow BunkerWeb upgrade documentation
- **Redis**: Monitor https://redis.io/topics/security
  - Update: `sudo apt update && sudo apt upgrade redis-server`

After updating external components:
1. Restart services
2. Verify plugin functionality
3. Review logs for any compatibility issues

### Manual SBOM Generation

To regenerate the SBOM:

```bash
# Install CycloneDX CLI (optional)
npm install -g @cyclonedx/cyclonedx-cli

# Update sbom.json with current dependency versions
# Edit sbom.json manually or use tools like:
# - syft (Anchore)
# - trivy (Aqua Security)
# - cdxgen (CycloneDX Generator)
```

### Vulnerability Disclosure Timeline

- **Day 0**: Vulnerability reported
- **Day 2**: Initial response and assessment
- **Day 7**: Fix developed and tested (if valid vulnerability)
- **Day 14**: Security patch released
- **Day 30**: Public disclosure (after patch deployment)

## Security Best Practices

### Configuration Hardening

1. **API Keys**: Store in environment variables, never commit to git
2. **ClamAV**: Keep virus signatures updated (`freshclam`)
3. **File Validation**: Keep `BLOCK_ON_FILENAME_INJECTION_ATTACK=yes` (default)
4. **Resume Mode**: Only enable `RESUME_SCAN_ON_FIRST_HIT` for research (DOS risk)
5. **Webhooks**: Mask URLs in logs (leave `UNMASK_KEYS` empty)

### Network Security

- ClamAV should only listen on `127.0.0.1` (localhost)
- Redis should require authentication if exposed
- API calls use HTTPS for VirusTotal, ThreatFox, SentinelOne
- Webhook URLs should be kept confidential

### File System Security

- Temporary files use `os.tmpname()` with restrictive permissions
- Files cleaned up after scanning (`CLEANUP_FILES=yes`)
- Never trust attacker-provided filenames (validated by `utils.validate_filename()`)

### Log Injection Protection

All user-provided strings are sanitized before logging:
- Filenames: `utils.sanitize_for_logging()` escapes control characters
- Prevents newline injection, ANSI escape codes, null bytes
- Limits log message length to prevent flooding

### Input Validation

Multiple layers of validation:
1. **Filename validation**: Path traversal, null bytes, excessive length
2. **File size limits**: ClamAV max 25MB, hash scanning max 64MB
3. **Content-Type validation**: Boundary extraction from multipart uploads
4. **SHA256 verification**: Hash-based deduplication and cache lookups

## Security Features

### Defense in Depth

- **Multi-layer scanning**: Local (ClamAV) + Cloud (VT, ThreatFox, S1)
- **Dual scanning mode**: Whole-body + per-file scanning
- **Cache validation**: Differential TTL (clean: 5min, malicious: 24h)
- **Filename attack detection**: 8 separate validation checks

### Attack Surface Reduction

- No shell command execution (pure Lua)
- No file uploads to disk without validation
- No network sockets opened by plugin (uses OpenResty HTTP)
- All API calls include User-Agent with version

### Monitoring & Alerting

- Webhook notifications (Discord, Teams)
- Attacker IP tracking
- Per-file detection reports
- Cache hit/miss metrics

## Supported Versions

| Version | Supported          | Security Updates |
| ------- | ------------------ | ---------------- |
| 0.7.x   | ✅ Yes             | Active           |
| 0.6.x   | ⚠️ Limited         | Critical only    |
| 0.5.x   | ❌ No              | Upgrade required |
| < 0.5   | ❌ No              | Upgrade required |

## Security Contacts

- **General issues**: GitHub Issues
- **Security vulnerabilities**: [Insert security email]
- **BunkerWeb core**: https://github.com/bunkerity/bunkerweb/security

## Acknowledgments

We appreciate responsible disclosure and will acknowledge security researchers who report vulnerabilities:

- [Security Hall of Fame - TBD]

---

**Last Updated**: 2026-01-19

#!/bin/bash
# Version Update Script for BunkerWeb Malware Scan Plugin
# Updates version numbers across all plugin files
#
# Usage: ./version_update.sh NEW_VERSION
# Example: ./version_update.sh 0.7.23

set -e

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Check arguments
if [ $# -ne 1 ]; then
    echo -e "${RED}Usage: $0 NEW_VERSION${NC}"
    echo "Example: $0 0.7.23"
    exit 1
fi

NEW_VERSION="$1"

# Auto-detect current version from plugin.json
if [ ! -f "plugin.json" ]; then
    echo -e "${RED}Error: plugin.json not found${NC}"
    exit 1
fi

OLD_VERSION=$(grep '"version":' plugin.json | sed 's/.*"version": "\([^"]*\)".*/\1/')

if [ -z "$OLD_VERSION" ]; then
    echo -e "${RED}Error: Could not detect current version from plugin.json${NC}"
    exit 1
fi

echo -e "${GREEN}=== BunkerWeb Malware Scan Plugin Version Update ===${NC}"
echo "Old version: $OLD_VERSION"
echo "New version: $NEW_VERSION"
echo ""

# Validate version format
if ! [[ "$NEW_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo -e "${RED}Error: Version must be in format X.Y.Z (e.g., 0.7.22)${NC}"
    exit 1
fi

# Get current date
CURRENT_DATE=$(date +%Y-%m-%d)

echo -e "${YELLOW}Updating files...${NC}"

# Update plugin.json
echo "  - plugin.json"
sed -i '' "s/\"version\": \"$OLD_VERSION\"/\"version\": \"$NEW_VERSION\"/" plugin.json

# Update README.md
echo "  - README.md"
sed -i '' "s/Version: $OLD_VERSION/Version: $NEW_VERSION/g" README.md
sed -i '' "s/\*\*Version\*\*: $OLD_VERSION/**Version**: $NEW_VERSION/g" README.md
sed -i '' "s/Release: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/Release: $CURRENT_DATE/" README.md

# Update TECHNICAL.md
echo "  - TECHNICAL.md"
sed -i '' "s/Version: $OLD_VERSION/Version: $NEW_VERSION/g" TECHNICAL.md
sed -i '' "s/\*\*Version\*\*: $OLD_VERSION/**Version**: $NEW_VERSION/g" TECHNICAL.md
sed -i '' "s/Last Updated: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/Last Updated: $CURRENT_DATE/" TECHNICAL.md

# Update GDPR.md
echo "  - GDPR.md"
sed -i '' "s/Version: $OLD_VERSION/Version: $NEW_VERSION/g" GDPR.md
sed -i '' "s/\*\*Version\*\*: $OLD_VERSION/**Version**: $NEW_VERSION/g" GDPR.md

# Update CACHE_KEYS.md
if [ -f "CACHE_KEYS.md" ]; then
    echo "  - CACHE_KEYS.md"
    sed -i '' "s/Version: $OLD_VERSION/Version: $NEW_VERSION/g" CACHE_KEYS.md
    sed -i '' "s/\*\*Version\*\*: $OLD_VERSION/**Version**: $NEW_VERSION/g" CACHE_KEYS.md
else
    echo -e "  ${YELLOW}⚠ CACHE_KEYS.md not found (skipping)${NC}"
fi

# Update variables.env.example
echo "  - variables.env.example"
sed -i '' "s/# Version: $OLD_VERSION/# Version: $NEW_VERSION/" variables.env.example

# Update all Lua modules
echo "  - Lua modules:"
LUA_FILES=(
    "malware-scan.lua"
    "malware_scan_api.lua"
    "malware_scan_cache.lua"
    "malware_scan_clamav.lua"
    "malware_scan_config.lua"
    "malware_scan_custom_hashes.lua"
    "malware_scan_database.lua"
    "malware_scan_file.lua"
    "malware_scan_filetypes.lua"
    "malware_scan_init.lua"
    "malware_scan_logger.lua"
    "malware_scan_malwarebazaar.lua"
    "malware_scan_metrics.lua"
    "malware_scan_multipart_full_scan.lua"
    "malware_scan_orchestrator.lua"
    "malware_scan_scheduler.lua"
    "malware_scan_sentinelone.lua"
    "malware_scan_ui_metrics.lua"
    "malware_scan_utils.lua"
    "malware_scan_virustotal.lua"
    "malware_scan_webhook.lua"
)

for lua_file in "${LUA_FILES[@]}"; do
    if [ -f "$lua_file" ]; then
        echo "    - $lua_file"
        sed -i '' "s/VERSION = \"$OLD_VERSION\"/VERSION = \"$NEW_VERSION\"/" "$lua_file"
    else
        echo -e "    ${YELLOW}⚠ $lua_file not found${NC}"
    fi
done

# Update job files (Python and Lua)
echo "  - Job files:"
JOB_FILES=(
    "jobs/malware-scan-update.py"
    "jobs/malware-scan-cache-cleanup.py"
    "jobs/malware-scan-update.lua"
)

for job_file in "${JOB_FILES[@]}"; do
    if [ -f "$job_file" ]; then
        echo "    - $job_file"
        sed -i '' "s/VERSION = \"$OLD_VERSION\"/VERSION = \"$NEW_VERSION\"/" "$job_file"
        sed -i '' "s/-- Version: $OLD_VERSION/-- Version: $NEW_VERSION/" "$job_file"
    else
        echo -e "    ${YELLOW}⚠ $job_file not found${NC}"
    fi
done

# Update UI files
echo "  - UI files:"
UI_FILES=(
    "ui/actions.py"
    "ui/blueprints/malware_scan.py"
    "ui/template.html"
)

for ui_file in "${UI_FILES[@]}"; do
    if [ -f "$ui_file" ]; then
        echo "    - $ui_file"
        sed -i '' "s/VERSION = \"$OLD_VERSION\"/VERSION = \"$NEW_VERSION\"/" "$ui_file"
        sed -i '' "s/version = \"$OLD_VERSION\"/version = \"$NEW_VERSION\"/" "$ui_file"
        sed -i '' "s/# Version: $OLD_VERSION/# Version: $NEW_VERSION/" "$ui_file"
    else
        echo -e "    ${YELLOW}⚠ $ui_file not found${NC}"
    fi
done

echo ""
echo -e "${GREEN}✅ Version update complete!${NC}"
echo ""
echo -e "${YELLOW}Summary:${NC}"
echo "  Detected version: $OLD_VERSION"
echo "  Updated to:       $NEW_VERSION"
echo "  Date:             $CURRENT_DATE"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "  1. Review changes: git diff"
echo "  2. Test the plugin"
echo "  3. Commit changes: git add . && git commit -m 'Update version to $NEW_VERSION'"
echo "  4. Deploy to server"

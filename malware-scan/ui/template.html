<input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}" />
<div class="row">
  <!-- Statistics Cards -->
  {% if pre_render.get('data') %}
  <!-- Webhook Test Buttons Row -->
  <div class="col-12 mb-3">
    <div class="card">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">
          <i class="bi bi-bell me-2"></i>
          Webhook Testing
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-2 mb-md-0">
            <button class="btn btn-outline-primary w-100 test-webhook-btn"
                    id="test-discord-btn"
                    data-webhook-type="discord"
                    type="button">
              <i class="bi bi-discord me-2"></i>Test Discord Webhook
            </button>
          </div>
          <div class="col-md-6">
            <button class="btn btn-outline-primary w-100 test-webhook-btn"
                    id="test-teams-btn"
                    data-webhook-type="teams"
                    type="button">
              <i class="bi bi-microsoft-teams me-2"></i>Test Microsoft Teams Webhook
            </button>
          </div>
        </div>
        <div id="webhook-test-result" class="mt-3" style="display: none;">
          <div class="alert mb-0" role="alert" id="webhook-test-message"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MalwareBazaar Total Hashes -->
  <div class="col-md-4 mb-4">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">
          <i class="bi bi-database me-2"></i>
          MalwareBazaar Hashes
        </h5>
      </div>
      <div class="card-body">
        {% if pre_render['data']['malwarebazaar_stats']['status'] == 'success' %}
          <div class="stat-value">{{ "{:,}".format(pre_render['data']['malwarebazaar_stats']['total_hashes']) }}</div>
          <div class="stat-label">Known Malware Hashes</div>
          <div class="text-muted small mt-3">
            <i class="bi bi-hdd-stack me-1"></i>
            {{ pre_render['data']['malwarebazaar_stats']['buckets'] }} Redis buckets
            {% if pre_render['data']['malwarebazaar_stats'].get('import_status') == 'running' %}
              <br><i class="bi bi-hourglass-split me-1"></i>
              <span class="text-primary">Import in progress</span>
            {% endif %}
          </div>
        {% else %}
          <div class="text-muted">Hash lookup not enabled or Redis unavailable</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- MalwareBazaar Full DB Status -->
  <div class="col-md-4 mb-4">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">
          <i class="bi bi-database me-2"></i>
          Full Database
        </h5>
      </div>
      <div class="card-body">
        {% if pre_render['data']['malwarebazaar_stats'].get('import_status') == 'running' %}
          <div class="stat-value">⏳ Import in progress</div>
          <div class="stat-label">Full DB Status</div>
          <div class="text-muted small mt-3">
            <i class="bi bi-hourglass-split me-1"></i>
            Database import is running on manager
            <br><i class="bi bi-pie-chart me-1"></i>
            Progress: <span id="import-progress-full"
              data-total="{{ pre_render['data']['malwarebazaar_stats']['import_progress']['full']['total'] }}"
              data-processed="{{ pre_render['data']['malwarebazaar_stats']['import_progress']['full']['processed'] }}">
              {% if pre_render['data']['malwarebazaar_stats']['import_progress']['full']['total'] > 0 %}
                {{ "{:,}".format(pre_render['data']['malwarebazaar_stats']['import_progress']['full']['processed']) }} of {{ "{:,}".format(pre_render['data']['malwarebazaar_stats']['import_progress']['full']['total']) }}
                ({{ "%.1f"|format(pre_render['data']['malwarebazaar_stats']['import_progress']['full']['processed'] / pre_render['data']['malwarebazaar_stats']['import_progress']['full']['total'] * 100) }}%)
              {% else %}
                0 of 0 (0%)
              {% endif %}
            </span>
            {% if pre_render['data']['malwarebazaar_stats'].get('full_import_start_time') %}
              <br><i class="bi bi-clock me-1"></i>
              Duration: <span id="import-duration-full" data-start-time="{{ pre_render['data']['malwarebazaar_stats']['full_import_start_time'] }}">Calculating...</span>
            {% endif %}
          </div>
        {% elif pre_render['data']['malwarebazaar_stats']['status'] == 'success' and pre_render['data']['malwarebazaar_stats'].get('full_db_status') %}
          {% set full_status = pre_render['data']['malwarebazaar_stats']['full_db_status'] %}
          {% if full_status == '1' %}
            <div class="stat-value">✓ Completed</div>
          {% elif full_status == 'never' %}
            <div class="stat-value">Never</div>
          {% else %}
            <div class="stat-value">{{ full_status }}</div>
          {% endif %}
          <div class="stat-label">Full DB Status</div>
          <div class="text-muted small mt-3">
            <i class="bi bi-download me-1"></i>
            Complete database download
            {% if pre_render['data']['malwarebazaar_stats'].get('full_import_start_time') and pre_render['data']['malwarebazaar_stats'].get('full_import_end_time') %}
              <br><i class="bi bi-clock-history me-1"></i>
              Last import: <span id="last-import-duration-full" data-start-time="{{ pre_render['data']['malwarebazaar_stats']['full_import_start_time'] }}" data-end-time="{{ pre_render['data']['malwarebazaar_stats']['full_import_end_time'] }}">Calculating...</span>
              <br><i class="bi bi-calendar-check me-1"></i>
              Completed: <span id="last-import-age-full" data-end-time="{{ pre_render['data']['malwarebazaar_stats']['full_import_end_time'] }}">Calculating...</span>
            {% endif %}
            <div class="mt-3">
              <button class="btn btn-sm btn-outline-primary download-db-btn" data-db-type="full" type="button">
                <i class="bi bi-file-earmark-zip me-1"></i>Download Full ZIP
              </button>
            </div>
          </div>
        {% else %}
          <div class="text-muted">Status unavailable</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- MalwareBazaar Recent DB Status -->
  <div class="col-md-4 mb-4">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">
          <i class="bi bi-clock-history me-2"></i>
          Recent Updates
        </h5>
      </div>
      <div class="card-body">
        {% if pre_render['data']['malwarebazaar_stats'].get('import_status') == 'running' %}
          <div class="stat-value">⏳ Import in progress</div>
          <div class="stat-label">Recent DB Status</div>
          <div class="text-muted small mt-3">
            <i class="bi bi-hourglass-split me-1"></i>
            Database import is running on manager
            <br><i class="bi bi-pie-chart me-1"></i>
            Progress: <span id="import-progress-recent"
              data-total="{{ pre_render['data']['malwarebazaar_stats']['import_progress']['recent']['total'] }}"
              data-processed="{{ pre_render['data']['malwarebazaar_stats']['import_progress']['recent']['processed'] }}">
              {% if pre_render['data']['malwarebazaar_stats']['import_progress']['recent']['total'] > 0 %}
                {{ "{:,}".format(pre_render['data']['malwarebazaar_stats']['import_progress']['recent']['processed']) }} of {{ "{:,}".format(pre_render['data']['malwarebazaar_stats']['import_progress']['recent']['total']) }}
                ({{ "%.1f"|format(pre_render['data']['malwarebazaar_stats']['import_progress']['recent']['processed'] / pre_render['data']['malwarebazaar_stats']['import_progress']['recent']['total'] * 100) }}%)
              {% else %}
                0 of 0 (0%)
              {% endif %}
            </span>
            {% if pre_render['data']['malwarebazaar_stats'].get('recent_import_start_time') %}
              <br><i class="bi bi-clock me-1"></i>
              Duration: <span id="import-duration-recent" data-start-time="{{ pre_render['data']['malwarebazaar_stats']['recent_import_start_time'] }}">Calculating...</span>
            {% endif %}
          </div>
        {% elif pre_render['data']['malwarebazaar_stats']['status'] == 'success' and pre_render['data']['malwarebazaar_stats'].get('recent_db_status') %}
          {% set recent_status = pre_render['data']['malwarebazaar_stats']['recent_db_status'] %}
          {% if recent_status == '1' %}
            <div class="stat-value">✓ Completed</div>
          {% elif recent_status == 'never' %}
            <div class="stat-value">Never</div>
          {% else %}
            <div class="stat-value">{{ recent_status }}</div>
          {% endif %}
          <div class="stat-label">Recent DB Status</div>
          <div class="text-muted small mt-3">
            <i class="bi bi-arrow-repeat me-1"></i>
            Incremental updates
            {% if pre_render['data']['malwarebazaar_stats'].get('recent_import_start_time') and pre_render['data']['malwarebazaar_stats'].get('recent_import_end_time') %}
              <br><i class="bi bi-clock-history me-1"></i>
              Last import: <span id="last-import-duration-recent" data-start-time="{{ pre_render['data']['malwarebazaar_stats']['recent_import_start_time'] }}" data-end-time="{{ pre_render['data']['malwarebazaar_stats']['recent_import_end_time'] }}">Calculating...</span>
              <br><i class="bi bi-calendar-check me-1"></i>
              Completed: <span id="last-import-age-recent" data-end-time="{{ pre_render['data']['malwarebazaar_stats']['recent_import_end_time'] }}">Calculating...</span>
            {% endif %}
            <div class="mt-3">
              <button class="btn btn-sm btn-outline-primary download-db-btn" data-db-type="recent" type="button">
                <i class="bi bi-file-earmark-zip me-1"></i>Download Recent ZIP
              </button>
            </div>
          </div>
        {% else %}
          <div class="text-muted">Status unavailable</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ClamAV Definitions -->
  <div class="col-md-12 mb-4">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">
          <i class="bi bi-shield-fill-check me-2"></i>
          ClamAV Definitions
        </h5>
      </div>
      <div class="card-body">
        {% if pre_render['data']['clamav_stats']['status'] == 'success' %}
          <div class="stat-value">{{ pre_render['data']['clamav_stats']['definition_version'] }}</div>
          <div class="stat-label">Definition Version</div>
          <div class="text-muted small mt-2">
            ClamAV {{ pre_render['data']['clamav_stats']['clamav_version'] }}<br>
            Updated: {{ pre_render['data']['clamav_stats']['definition_date'] }}
          </div>
        {% else %}
          <div class="text-muted">ClamAV information unavailable</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Worker ClamAV Status Table -->
  {% if pre_render.get('data') and pre_render['data'].get('worker_clamav_status') and pre_render['data']['worker_clamav_status'].get('workers') %}
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="bi bi-shield-check me-2"></i>
          Worker ClamAV Status
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col" style="width: 20%;">Worker Name</th>
                <th scope="col" style="width: 20%;">Hostname</th>
                <th scope="col" style="width: 15%;">Status</th>
                <th scope="col" style="width: 30%;">Message</th>
                <th scope="col" style="width: 15%;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for worker in pre_render['data']['worker_clamav_status']['workers'] %}
              <tr id="worker-{{ loop.index }}">
                <td class="fw-bold">{{ worker.name }}</td>
                <td class="text-muted">{{ worker.hostname }}</td>
                <td>
                  {% if worker.status == 'success' %}
                    <span class="badge bg-success">
                      <i class="bi bi-check-circle me-1"></i>Active
                    </span>
                  {% elif worker.status == 'warning' %}
                    <span class="badge bg-warning text-dark">
                      <i class="bi bi-exclamation-triangle me-1"></i>Warning
                    </span>
                  {% else %}
                    <span class="badge bg-danger">
                      <i class="bi bi-x-circle me-1"></i>Error
                    </span>
                  {% endif %}
                </td>
                <td class="text-muted small" id="worker-{{ loop.index }}-message">{{ worker.message }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary test-eicar-btn"
                          data-worker="{{ worker.hostname }}"
                          data-worker-id="{{ loop.index }}"
                          type="button">
                    <i class="bi bi-virus me-1"></i>Test EICAR
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="col-12 mb-4">
    <div class="alert alert-info mb-0" role="alert">
      <i class="bi bi-info-circle me-2"></i>
      No worker instances found or plugin metrics not available.
    </div>
  </div>
  {% endif %}
</div>

<style>
  .table th {
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .table td {
    vertical-align: middle;
  }

  .badge {
    font-weight: 500;
    padding: 0.375rem 0.75rem;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--bs-body-color, #212529);
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--bs-secondary-color, #6c757d);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 0.25rem;
  }

  .test-eicar-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }

  .test-eicar-btn:disabled {
    cursor: not-allowed;
  }

  .test-webhook-btn:disabled {
    cursor: not-allowed;
  }
</style>

<script nonce="{{ script_nonce }}">
// Attach event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, attaching event listeners');

  // Attach listeners to webhook test buttons
  document.querySelectorAll('.test-webhook-btn').forEach(function(button) {
    console.log('Attaching listener to button:', button.id);
    button.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Button clicked:', button.id);
      testWebhook(button);
    });
  });

  // Attach listeners to EICAR test buttons
  document.querySelectorAll('.test-eicar-btn').forEach(function(button) {
    console.log('Attaching listener to EICAR button');
    button.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('EICAR button clicked');
      testEicar(button);
    });
  });

  // Attach listeners to database download buttons
  document.querySelectorAll('.download-db-btn').forEach(function(button) {
    console.log('Attaching listener to download button');
    button.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Download button clicked');
      downloadDatabase(button);
    });
  });
});

async function testWebhook(button) {
  console.log('testWebhook called', button);
  const webhookType = button.dataset.webhookType;
  console.log('webhookType:', webhookType);

  const resultDiv = document.getElementById('webhook-test-result');
  const messageDiv = document.getElementById('webhook-test-message');
  const originalButtonHTML = button.innerHTML;

  if (!resultDiv || !messageDiv) {
    console.error('Result divs not found!');
    alert('Error: UI elements not found');
    return;
  }

  // Disable all webhook test buttons
  document.querySelectorAll('.test-webhook-btn').forEach(btn => btn.disabled = true);
  button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Testing...';

  // Show result area
  resultDiv.style.display = 'block';
  messageDiv.className = 'alert alert-info mb-0';
  messageDiv.textContent = 'Sending test message to ' + webhookType + '...';

  try {
    // Make POST request to UI backend endpoint (not worker endpoint)
    const endpoint = webhookType === 'discord' ? '/api/plugins/malware-scan/test_discord' : '/api/plugins/malware-scan/test_teams';
    console.log('Fetching endpoint:', endpoint);

    // Get CSRF token
    const csrfToken = document.getElementById('csrf_token').value;

    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      credentials: 'same-origin'
    });

    console.log('Response status:', response.status);
    const result = await response.json();
    console.log('Result:', result);

    // Update message with result
    if (result.status === 'success') {
      messageDiv.className = 'alert alert-success mb-0';
      messageDiv.textContent = '✓ ' + result.message + ' - Check your ' +
        (webhookType === 'discord' ? 'Discord channel' : 'Teams channel') + ' for the test message.';
    } else if (result.status === 'warning') {
      messageDiv.className = 'alert alert-warning mb-0';
      messageDiv.textContent = '⚠ ' + result.message;
    } else {
      messageDiv.className = 'alert alert-danger mb-0';
      messageDiv.textContent = '✗ ' + result.message;
    }
  } catch (error) {
    console.error('Webhook test error:', error);
    messageDiv.className = 'alert alert-danger mb-0';
    messageDiv.textContent = '✗ Test failed: ' + error.message;
  } finally {
    // Re-enable all webhook test buttons and restore original content
    document.querySelectorAll('.test-webhook-btn').forEach(btn => btn.disabled = false);
    button.innerHTML = originalButtonHTML;
  }
}

async function testEicar(button) {
  const workerId = button.dataset.workerId;
  const workerHostname = button.dataset.worker;
  const messageCell = document.getElementById('worker-' + workerId + '-message');
  const originalButtonText = button.textContent;

  // Disable button and show loading
  button.disabled = true;
  button.textContent = 'Testing...';
  messageCell.textContent = 'Running EICAR test...';
  messageCell.className = 'text-primary small';

  try {
    // Get CSRF token
    const csrfToken = document.getElementById('csrf_token').value;

    // Make POST request to UI backend endpoint (not worker endpoint)
    const response = await fetch('/api/plugins/malware-scan/test_eicar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      credentials: 'same-origin'
    });

    const result = await response.json();

    // Update message cell with result
    if (result.status === 'success') {
      messageCell.textContent = '✓ ' + result.message;
      messageCell.className = 'text-success small fw-bold';
    } else if (result.status === 'warning') {
      messageCell.textContent = '⚠ ' + result.message;
      messageCell.className = 'text-warning small';
    } else {
      messageCell.textContent = '✗ ' + result.message;
      messageCell.className = 'text-danger small';
    }
  } catch (error) {
    messageCell.textContent = '✗ Test failed: ' + error.message;
    messageCell.className = 'text-danger small';
  } finally {
    // Re-enable button
    button.disabled = false;
    button.textContent = originalButtonText;
  }
}

async function downloadDatabase(button) {
  const dbType = button.dataset.dbType;
  const originalButtonText = button.textContent;

  // Disable button and show loading
  button.disabled = true;
  button.textContent = 'Downloading...';

  try {
    // Get CSRF token
    const csrfToken = document.getElementById('csrf_token').value;

    // Construct endpoint URL
    const endpoint = dbType === 'full'
      ? '/api/plugins/malware-scan/download-full-db'
      : '/api/plugins/malware-scan/download-recent-db';

    // Make GET request to download endpoint
    const response = await fetch(endpoint, {
      method: 'GET',
      headers: {
        'X-CSRFToken': csrfToken
      },
      credentials: 'same-origin'
    });

    if (!response.ok) {
      // Check if response is JSON error message
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const result = await response.json();
        throw new Error(result.message || 'Download failed');
      } else {
        throw new Error(`Download failed with status ${response.status}`);
      }
    }

    // Get filename from Content-Disposition header or use default
    const contentDisposition = response.headers.get('Content-Disposition');
    let filename = `hashes_${dbType}.zip`;
    if (contentDisposition) {
      const filenameMatch = contentDisposition.match(/filename="?(.+)"?/i);
      if (filenameMatch) {
        filename = filenameMatch[1];
      }
    }

    // Get the blob and create download link
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);

    // Restore button text
    button.textContent = originalButtonText;
  } catch (error) {
    console.error('Download error:', error);
    button.textContent = originalButtonText;
    alert('Download failed: ' + error.message);
  } finally {
    // Re-enable button
    button.disabled = false;
  }
}

// Format duration as human-readable string
function formatDuration(seconds) {
  if (seconds < 60) {
    return Math.floor(seconds) + 's';
  } else if (seconds < 3600) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + 'm ' + secs + 's';
  } else {
    const hours = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    return hours + 'h ' + mins + 'm';
  }
}

// Format age (time since) as human-readable string
function formatAge(seconds) {
  if (seconds < 60) {
    return Math.floor(seconds) + 's ago';
  } else if (seconds < 3600) {
    const mins = Math.floor(seconds / 60);
    return mins + 'm ago';
  } else if (seconds < 86400) {
    const hours = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    if (mins > 0) {
      return hours + 'h ' + mins + 'm ago';
    }
    return hours + 'h ago';
  } else {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    if (days === 1) {
      return '1 day ago';
    } else if (hours > 0 && days < 7) {
      return days + 'd ' + hours + 'h ago';
    }
    return days + ' days ago';
  }
}

// Update import durations
function updateImportDurations() {
  // Update ongoing import durations (current time - start time)
  document.querySelectorAll('[id^="import-duration-"]').forEach(function(element) {
    const startTime = parseInt(element.dataset.startTime);
    if (startTime) {
      const currentTime = Math.floor(Date.now() / 1000);
      const duration = currentTime - startTime;
      element.textContent = 'Duration: ' + formatDuration(duration);
    }
  });

  // Update completed import durations (end time - start time)
  document.querySelectorAll('[id^="last-import-duration-"]').forEach(function(element) {
    const startTime = parseInt(element.dataset.startTime);
    const endTime = parseInt(element.dataset.endTime);
    if (startTime && endTime) {
      const duration = endTime - startTime;
      element.textContent = formatDuration(duration);
    }
  });

  // Update import age (how long ago the import completed)
  document.querySelectorAll('[id^="last-import-age-"]').forEach(function(element) {
    const endTime = parseInt(element.dataset.endTime);
    if (endTime) {
      const currentTime = Math.floor(Date.now() / 1000);
      const age = currentTime - endTime;
      element.textContent = formatAge(age);
    }
  });
}

// Update import progress from server every 2 seconds
async function updateImportProgress() {
  try {
    const response = await fetch('/api/plugins/malware-scan/get_import_progress', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    });

    const data = await response.json();

    if (data && data.import_progress) {
      // Update full database progress
      const fullProgress = data.import_progress.full;
      const fullProgressElement = document.getElementById('import-progress-full');
      if (fullProgressElement && fullProgress.total > 0) {
        const fullProcessed = fullProgress.processed;
        const fullTotal = fullProgress.total;
        const fullPercent = (fullProcessed / fullTotal * 100).toFixed(1);

        fullProgressElement.setAttribute('data-total', fullTotal);
        fullProgressElement.setAttribute('data-processed', fullProcessed);
        fullProgressElement.textContent = `${fullProcessed.toLocaleString()} of ${fullTotal.toLocaleString()} (${fullPercent}%)`;
      }

      // Update recent database progress
      const recentProgress = data.import_progress.recent;
      const recentProgressElement = document.getElementById('import-progress-recent');
      if (recentProgressElement && recentProgress.total > 0) {
        const recentProcessed = recentProgress.processed;
        const recentTotal = recentProgress.total;
        const recentPercent = (recentProcessed / recentTotal * 100).toFixed(1);

        recentProgressElement.setAttribute('data-total', recentTotal);
        recentProgressElement.setAttribute('data-processed', recentProcessed);
        recentProgressElement.textContent = `${recentProcessed.toLocaleString()} of ${recentTotal.toLocaleString()} (${recentPercent}%)`;
      }
    }
  } catch (error) {
    console.debug('Failed to update import progress:', error);
  }
}

// Update durations on page load and every second
document.addEventListener('DOMContentLoaded', function() {
  updateImportDurations();
  setInterval(updateImportDurations, 1000);

  // Update import progress every 5 seconds
  updateImportProgress();
  setInterval(updateImportProgress, 5000);
});
</script>

# Malware Scan Job Scripts

This directory contains job scripts for the malware-scan plugin's hash database update functionality.

---

## Overview

BunkerWeb uses a job system for scheduled tasks. The malware-scan plugin provides hash database updates through:

1. **Primary (Lua)**: `../malware_scan_scheduler.lua` - Core implementation
2. **Job Scripts** (this directory):
   - `malware-scan-update.lua` - Lua job reference
   - `malware-scan-update.py` - Python job (future use)

---

## Architecture

### Current (Lua-Based)

```
BunkerWeb Manager
    ↓
malware-scan.lua
    ↓
scheduler() hook
    ↓
malware_scan_scheduler.lua
    ├─ init_on_startup()
    └─ update_hashes()
    ↓
Redis (hash buckets)
```

### Future (Python Job)

```
BunkerWeb Job Scheduler
    ↓
jobs/malware-scan-update.py
    ├─ Download with retry
    ├─ Extract ZIP
    └─ Import to Redis
    ↓
Redis (hash buckets)
```

---

## Job Scripts

### malware-scan-update.lua

**Status**: Reference implementation

A Lua job script demonstrating how the hash update could be structured as a standalone job. Currently not used - the Lua scheduler module in the main plugin is the primary mechanism.

**Usage**: For future restructuring or alternative job frameworks.

### malware-scan-update.py

**Status**: Future-ready implementation

A Python job script following the BunkerWeb pattern (similar to blacklist-download.py). Provides:

- **Retry Logic**: 3 attempts with exponential backoff (3s, 6s, 9s)
- **Error Handling**: Graceful degradation on network failures
- **State Persistence**: ETag + file size for change detection
- **Redis Bucketing**: Distributes 1M+ hashes across 16 buckets
- **Logging**: Detailed progress and error reporting
- **Cleanup**: Automatic removal of temporary files

**When to Use**:
- Large-scale deployments (100+ instances)
- If you prefer Python over Lua
- When you need centralized job scheduling
- For environments where the Lua scheduler is inadequate

**Requirements**:
- Python 3.6+
- `requests` module
- `redis` module
- BunkerWeb utilities

**Configuration**: Uses same environment variables as Lua scheduler
```env
USE_MALWARE-SCAN=yes
MALWARE_SCAN_CUSTOM_HASHES_ENABLED=yes
MALWARE_SCAN_CUSTOM_HASHES_AUTO_UPDATE=yes
MALWARE_SCAN_CUSTOM_HASHES_UPDATE_URL=...
MALWARE_SCAN_CUSTOM_HASHES_CSV_PATH=...
```

**Exit Codes**:
- `0`: Success, no changes
- `1`: Success, hashes added
- `2`: Error occurred

---

## Migration Guide

### Current Setup (Recommended)

Uses Lua scheduler in main plugin:

```bash
# In malware-scan.lua
function malware_scan:scheduler()
    local init_ok = deps.modules.ms_scheduler.init_on_startup(self)
    local update_ok = deps.modules.ms_scheduler.update_hashes(self)
    return self:ret(true, "success")
end
```

**Pros**:
- Single Lua ecosystem
- No Python dependency
- No separate job configuration
- Integrated with plugin lifecycle

**Cons**:
- Less isolation from main plugin
- Scheduler runs in worker processes
- No centralized job management

### Future: Python Job (Optional)

For large deployments, you could switch to Python:

```lua
-- In malware-scan.lua scheduler()
-- Call Python job instead of Lua scheduler
os.execute("/path/to/jobs/malware-scan-update.py")
```

**Pros**:
- Better separation of concerns
- Can be run independently
- More debugging flexibility
- Matches BunkerWeb blacklist pattern

**Cons**:
- Adds Python dependency
- Separate job configuration
- Less integrated

---

## Testing the Python Job

### Dry Run

```bash
# Test without actually importing
cd /opt/bunkerweb/plugins/malware-scan
python3 jobs/malware-scan-update.py
```

### Debug Mode

```bash
# Enable debug logging
DEBUG=yes python3 jobs/malware-scan-update.py
```

### With Custom Config

```bash
# Override environment variables
USE_MALWARE-SCAN=yes \
MALWARE_SCAN_CUSTOM_HASHES_ENABLED=yes \
MALWARE_SCAN_CUSTOM_HASHES_AUTO_UPDATE=yes \
REDIS_HOST=localhost \
REDIS_PORT=6379 \
python3 jobs/malware-scan-update.py
```

### Verify Results

```bash
# Check hashes imported
redis-cli hlen malware_scan:hashes:0
redis-cli hlen malware_scan:hashes:A
redis-cli hlen malware_scan:hashes:F

# Check state file
cat /var/cache/bunkerweb/malware-scan/hashes.state
```

---

## Performance Comparison

### Lua Scheduler (Current)

```
| Metric | Value |
|--------|-------|
| Startup | ~1ms (compiled in) |
| Download | 10-30s (depends on network) |
| Extract + Import | 10-20s |
| Total | 20-50s |
| Memory | ~200MB (temporary) |
| CPU | Single thread |
```

### Python Job (Future)

```
| Metric | Value |
|--------|-------|
| Startup | ~100ms (interpreter) |
| Download | 10-30s (same network) |
| Extract + Import | 10-20s (same algorithm) |
| Total | 20-50s (same) |
| Memory | ~200MB (temporary) |
| CPU | Single thread |
```

**Conclusion**: Same performance, different approach.

---

## BunkerWeb Pattern

This structure follows the BunkerWeb convention:

```
plugin-name/
  plugin-name.lua          ← Main plugin logic
  helper_modules.lua       ← Shared functions
  jobs/                    ← Job scripts directory
    plugin-name-job.py     ← Python job (if used)
    plugin-name-job.lua    ← Lua job (reference)
```

**Examples in BunkerWeb**:
```
core_plugins/
  blacklist/
    blacklist.lua
    jobs/
      blacklist-download.py

  bans/
    bans.lua
    jobs/
      bans-save.py
```

---

## Future Enhancements

### 1. Centralized Job Scheduler

Instead of scheduler hook in plugin, use BunkerWeb Jobs system:

```python
# jobs/malware-scan-update.py
class MalwareScanUpdateJob(Job):
    def execute(self):
        # Update logic
        return status
```

### 2. Multiple Source Support

Download from multiple mirrors and merge:

```python
SOURCES = [
    "https://bazaar.mirror.sysangels.ai/...",
    "https://bazaar.abuse.ch/...",
    "file:///local/hashes.csv",
]

for source in SOURCES:
    download_and_import(source)
```

### 3. Partial Import Recovery

Resume import if interrupted:

```python
if state.get("import_progress"):
    # Skip already imported lines
    start_line = int(state["import_progress"])
else:
    start_line = 0
```

### 4. Rollback Support

Keep previous version for rollback:

```python
# Before import
backup_hashes()

# On import failure
restore_hashes()
```

---

## References

- **BunkerWeb Blacklist**: `/core_plugins/blacklist/jobs/blacklist-download.py`
- **BunkerWeb Jobs**: `/src/scheduler/jobs.py`
- **Malware-Scan Scheduler**: `../malware_scan_scheduler.lua`

---

## Support

For issues with the job scripts:

1. Check logs: `/var/log/bunkerweb/access.log`
2. Verify Redis: `redis-cli ping`
3. Verify network: `curl -I https://bazaar.mirror.sysangels.ai/...`
4. Check hashes: `redis-cli hlen malware_scan:hashes:0`

---

**Version**: 0.7.44
**Date**: 2026-01-27
**Status**: Production Ready (Lua), Future-Ready (Python)

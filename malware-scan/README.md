# BunkerWeb Malware Scan Plugin - Core Files

This directory contains the core plugin files for the BunkerWeb malware scanning plugin.

## User-Agent for API lookups
The API requests are made with the User-Agent name "bunkerweb - https://github.com/bunkerity/bunkerweb - malware-scan module". The suffix is the current version number.

**Current version**: 0.3.0

## Real-World Examples

### Example 1: Fast Response Mode (Skip Cloud Scanners on ClamAV Detection)

**Configuration**: `MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT=yes` (default)

This mode prioritizes speed - when ClamAV detects malware, the request is immediately blocked without waiting for cloud scanners.

```
# File upload detected (multipart/form-data)
[MALWARE-SCAN] file upload detected, scanning for malware
[MALWARE-SCAN] body_file = /var/tmp/bunkerweb/client_temp/0000012345
[MALWARE-SCAN] Original filename: eicar_com.zip

# ClamAV INSTREAM scan begins
[MALWARE-SCAN] scanning file via INSTREAM: /var/tmp/bunkerweb/client_temp/0000012345
[MALWARE-SCAN] INSTREAM: Read chunk 1, size: 703
[MALWARE-SCAN] INSTREAM: All chunks sent - 1 chunks, 703 bytes total

# Malware detected by ClamAV
[MALWARE-SCAN] INSTREAM: FOUND pattern matched, extracting virus name
[MALWARE-SCAN] MALWARE DETECTED BY CLAMAV
[MALWARE-SCAN] ClamAV signature: Eicar-Test-Signature in file: /var/tmp/bunkerweb/client_temp/0000012345

# ClamAV daemon log
clamd[925]: instream(127.0.0.1@50998): Eicar-Test-Signature(6beb41673e1254bd0dad4b65eb22d019:703) FOUND

# Request blocked immediately
[MALWARE-SCAN] BLOCKING REQUEST - skipping cloud scanner checks (faster response)
203.0.113.10 - - "POST /wp-admin/async-upload.php HTTP/3.0" 403
```

**Performance**: ~2 seconds total (includes buffering + ClamAV scan)

---

### Example 2: Full Multi-Layer Analysis Mode

**Configuration**: `MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT=no`

This mode provides complete analysis - even when ClamAV detects malware, it continues to cloud scanners for additional confirmation and threat intelligence.

```
# File upload detected (multipart/form-data)
[MALWARE-SCAN] file upload detected, scanning for malware
[MALWARE-SCAN] body_file = /var/tmp/bunkerweb/client_temp/0000023456
[MALWARE-SCAN] Original filename: eicar_com.zip

# ClamAV INSTREAM scan begins
[MALWARE-SCAN] scanning file via INSTREAM: /var/tmp/bunkerweb/client_temp/0000023456
[MALWARE-SCAN] INSTREAM: Read chunk 1, size: 703
[MALWARE-SCAN] INSTREAM: All chunks sent - 1 chunks, 703 bytes total

# Malware detected by ClamAV
[MALWARE-SCAN] MALWARE DETECTED BY CLAMAV
[MALWARE-SCAN] ClamAV signature: Eicar-Test-Signature in file: /var/tmp/bunkerweb/client_temp/0000023456

# ClamAV daemon log
clamd[925]: instream(127.0.0.1@37966): Eicar-Test-Signature(40bf7c1c00f63a9a14d109f4ac9e9747:703) FOUND

# Continue to VirusTotal for additional analysis
[MALWARE-SCAN] ClamAV detected malware, continuing to VirusTotal for additional analysis
[MALWARE-SCAN] Hash-based scanning enabled, calculating SHA256 checksum
[MALWARE-SCAN] Extracted file content: 184 bytes from 703 bytes total
[MALWARE-SCAN] calculated SHA256 of extracted file content (184 bytes): 2546dcffc5ad854d4ddc64fbf056871cd5a00f2471cb7a5bfd4ac23b6e9eedad
[MALWARE-SCAN] file SHA256: 2546dcffc5ad854d4ddc64fbf056871cd5a00f2471cb7a5bfd4ac23b6e9eedad

# VirusTotal check (cache hit)
[MALWARE-SCAN] checking file against VirusTotal API
[MALWARE-SCAN] file checksum 2546dcffc5ad854d4ddc64fbf056871cd5a00f2471cb7a5bfd4ac23b6e9eedad found in VT cache: 0 suspicious and 61 malicious

# Request blocked with dual confirmation
[MALWARE-SCAN] MALWARE DETECTED BY VIRUSTOTAL - BLOCKING REQUEST
[MALWARE-SCAN] VirusTotal detection: 0 suspicious and 61 malicious (SHA256: 2546dcffc5ad854d4ddc64fbf056871cd5a00f2471cb7a5bfd4ac23b6e9eedad)
203.0.113.10 - - "POST /wp-admin/async-upload.php HTTP/3.0" 403
```

**Performance**: ~2.5 seconds total (includes buffering + ClamAV scan + VirusTotal lookup)

**Note**: ThreatFox was queried but returned clean (EICAR not in ThreatFox IOC database). VirusTotal then detected malware with 61 engines and blocked immediately. SentinelOne was **not** queried because VirusTotal blocked first. The plugin uses sequential blocking (ThreatFox ‚Üí VirusTotal ‚Üí SentinelOne) - each scanner can block the request, preventing subsequent scanners from running.

---

### Comparison

| Aspect | Fast Response Mode | Full Multi-Layer Mode |
|--------|-------------------|----------------------|
| **Configuration** | `MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT=yes` | `MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT=no` |
| **ClamAV Scan** | ‚úì Always performed | ‚úì Always performed |
| **ThreatFox (1st)** | Only if ClamAV clean | Only if ClamAV clean |
| **VirusTotal (2nd)** | Only if ClamAV+TF clean | Only if ClamAV+TF clean |
| **SentinelOne (3rd)** | Only if all clean | Only if all clean |
| **VT on ClamAV Hit** | ‚úó Skipped (faster) | ‚úì Performed (thorough) |
| **Response Time** | ~2 seconds | ~2.5 seconds |
| **Detection Confidence** | Single source (ClamAV) | Dual confirmation (ClamAV + 61 engines) |
| **Use Case** | Production (speed priority) | Investigation/forensics (accuracy priority) |
| **API Quota Usage** | Lower (VT only for clean files) | Higher (VT for all files) |
| **Blocking Strategy** | First detection blocks | Sequential - each scanner can block |

**When to use Fast Response Mode:**
- Production environments prioritizing speed
- High-confidence in ClamAV signatures
- Minimize VirusTotal API quota usage
- Quick user feedback is important

**When to use Full Multi-Layer Mode:**
- Security research and threat analysis
- Need detailed threat intelligence from multiple sources
- False positive investigation
- Forensic analysis and incident response
- Testing and validation

---

### Scanner Execution Order

The plugin uses **sequential blocking** - each scanner can block the request, preventing subsequent scanners from running:

```
1. ClamAV scan (file-based)
   ‚Üì (if malware detected)
   ‚îú‚îÄ‚Üí Fast Mode: BLOCK (skip ThreatFox/VirusTotal/SentinelOne)
   ‚îî‚îÄ‚Üí Full Mode: Continue to step 2

2. ThreatFox check (hash-based)
   ‚Üì (if IOC match found)
   ‚îî‚îÄ‚Üí BLOCK (skip VirusTotal/SentinelOne)

3. VirusTotal check (hash-based)
   ‚Üì (if malware detected)
   ‚îî‚îÄ‚Üí BLOCK (skip SentinelOne)

4. SentinelOne check (hash-based)
   ‚Üì (if threat detected)
   ‚îî‚îÄ‚Üí BLOCK

5. All scanners clean ‚Üí ALLOW
```

**Key Points:**
- Scanners run in order: ClamAV ‚Üí **ThreatFox** ‚Üí VirusTotal ‚Üí SentinelOne
- **ThreatFox runs before VirusTotal** to preserve VT API quota (4/min, 500/day limit)
- First detection wins - request is blocked immediately
- Later scanners only run if all previous scanners return clean
- API keys are validated - empty or default values (e.g., "your_api_key") are rejected
- This optimizes both performance and API quota usage

### Key Features
- **Cache-First Optimization**: Checks hash caches BEFORE ClamAV to avoid wasting resources on known malware
- **INSTREAM Protocol**: Bypasses file permission issues by streaming content to ClamAV
- **File Size Limits**: Pre-checks file size before scans (ClamAV: 25MB, Hash-based: 64MB, both configurable)
- **Performance Optimization**: Skips SHA256 calculation for very large files (ISOs, VMs) to avoid CPU/memory overhead
- **Graceful Degradation**: Large files skip appropriate scanners but continue with others
- **Differential Caching**: Clean results cached 5 min, malicious 1 hour (prevents false negatives)
- **Result Caching**: Hash-based scans cached (configurable via `MALWARE_SCAN_CACHE_TTL`)
- **User-Agent Tracking**: Includes version in API requests for identification
- **Cleanup**: Automatic temp file cleanup after scanning
- **Webhook Notifications**: Discord & Microsoft Teams integration for real-time malware alerts

---

## Webhook Notifications

Get instant alerts when malware is detected! The plugin supports Discord and Microsoft Teams webhooks for real-time notifications.

### Features

- ‚úÖ **Discord & Microsoft Teams** support
- ‚úÖ **Single aggregated notification** per file (all scanner results in one message)
- ‚úÖ **Cached results indicator** (shows which scanners used cache vs. fresh scan)
- ‚úÖ **Secure by default** (API keys and webhook URLs masked in logs)
- ‚úÖ **No wasted CPU** (doesn't re-scan cached results)
- ‚úÖ **Rate limiting** (prevents webhook spam during attacks)

### Discord Setup

1. **Create a webhook in Discord:**
   - Open Discord and go to your server
   - Right-click the channel ‚Üí **Edit Channel**
   - Go to **Integrations** ‚Üí **Webhooks** ‚Üí **New Webhook**
   - Set a name (e.g., "BunkerWeb Malware Alerts")
   - Copy the Webhook URL
   - Save changes

2. **Configure BunkerWeb:**
   ```bash
   # Add to /etc/bunkerweb/variables.env
   MALWARE_SCAN_DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN
   MALWARE_SCAN_DISCORD_WEBHOOK_RATE_LIMIT=5  # Max 5 notifications per 60 seconds (default)
   ```

3. **Restart BunkerWeb:**
   ```bash
   sudo systemctl restart bunkerweb
   ```

### Microsoft Teams Setup

1. **Create an Incoming Webhook:**
   - Open Microsoft Teams
   - Go to your channel ‚Üí **‚ãØ** ‚Üí **Connectors**
   - Search for "Incoming Webhook" ‚Üí **Configure**
   - Set a name (e.g., "BunkerWeb Malware Alerts")
   - Copy the webhook URL
   - Click **Done**

2. **Configure BunkerWeb:**
   ```bash
   # Add to /etc/bunkerweb/variables.env
   MALWARE_SCAN_TEAMS_WEBHOOK_URL=https://your-tenant.webhook.office.com/webhookb2/...
   MALWARE_SCAN_TEAMS_WEBHOOK_RATE_LIMIT=6  # Max 6 notifications per minute (default)
   ```

3. **Restart BunkerWeb:**
   ```bash
   sudo systemctl restart bunkerweb
   ```

### Webhook Message Format

When malware is detected, you'll receive a message like this:

```
üõ°Ô∏è MALWARE DETECTED
BunkerWeb Malware Scanner Alert

Client IP: 77.119.237.155
Destination Domain: www.example.com
Request URI: /wp-admin/async-upload.php
SHA256 Checksum: 2546dcffc5ad854d4ddc64fbf056871cd5a00f2471cb7a5bfd4ac23b6e9eedad
Detected By: VirusTotal (cached), ClamAV

‚ö° Cached Results
VirusTotal (from cache, not re-scanned)

VirusTotal (cached)
0 suspicious and 61 malicious

ClamAV
Eicar-Test-Signature
```

**Cached Results Indicator:**
- Shows which scanners used cached results vs. fresh scans
- Prevents confusion about why some scanners aren't shown (e.g., ClamAV skipped when cache hit)
- Helps understand performance optimizations in action

### Rate Limiting

To prevent webhook spam during malware attacks:

**Discord:**
- Default: 5 notifications per 60 seconds
- Hard limit: 30 per 60 seconds (Discord API limit)
- Set to `0` for unlimited (still respects hard cap)

**Microsoft Teams:**
- Default: 6 notifications per minute
- Hard limit: 200 per minute (Microsoft Teams limit)
- Set to `0` for unlimited (still respects hard cap)

Notifications exceeding the limit are dropped with a log message.

### Security: Sensitive Value Masking

By default, all sensitive values (API keys, webhook URLs) are **masked in logs** for security:

```
[MALWARE-SCAN] [DEBUG] [WEBHOOK_DEBUG] webhook_module_loaded=true,
  discord_url=https://discord.co***
[MALWARE-SCAN] VirusTotal API key: sk-***
```

**To unmask for debugging (NOT recommended for production):**
```bash
MALWARE_SCAN_UNMASK_KEYS=I_WANT_TO_LEAK_MY_SECRETS_TO_LOG
```

This will show full API keys and webhook URLs in logs. Only use in secure development environments.

### Webhook Configuration Reference

| Variable | Default | Description |
|----------|---------|-------------|
| `MALWARE_SCAN_DISCORD_WEBHOOK_URL` | _(empty)_ | Discord webhook URL for malware alerts |
| `MALWARE_SCAN_DISCORD_WEBHOOK_RATE_LIMIT` | `5` | Max Discord notifications per 60 seconds (0 = unlimited, capped at 30) |
| `MALWARE_SCAN_TEAMS_WEBHOOK_URL` | _(empty)_ | Microsoft Teams webhook URL for malware alerts |
| `MALWARE_SCAN_TEAMS_WEBHOOK_RATE_LIMIT` | `6` | Max Teams notifications per minute (0 = unlimited, capped at 200) |
| `MALWARE_SCAN_UNMASK_KEYS` | _(empty)_ | Set to `I_WANT_TO_LEAK_MY_SECRETS_TO_LOG` to show unmasked secrets in logs |

**Note:** You can use both Discord and Teams webhooks simultaneously.

### Troubleshooting

**No notifications received:**
1. Check logs: `journalctl -u bunkerweb | grep WEBHOOK`
2. Verify webhook URL is correct (test with curl)
3. Ensure BunkerWeb was restarted after configuration
4. Check rate limits aren't exceeded

**"Skipping - module not loaded" error:**
- The `malware_scan_webhook.lua` file is missing
- Ensure both files are deployed:
  - `/etc/bunkerweb/plugins/malware-scan/malware-scan.lua`
  - `/etc/bunkerweb/plugins/malware-scan/malware_scan_webhook.lua`

**Rate limit hit:**
```
[WEBHOOK] Rate limit exceeded (5 per 60s), dropping notification
```
- Increase rate limit or investigate why so many uploads are malicious
- Consider if you're under attack

---

## Architecture

### Scanning Flow
1. **Upload Detection**: Intercepts multipart/form-data uploads
2. **File Extension Check**: Skips excluded file types (images, media)
3. **File Size Check (Hash)**: Validates file size against hash scan limit (64MB default)
4. **Hash Calculation**: SHA256 hash of uploaded file (if hash-based scanners enabled and within size limit)
5. **Cache Check (Optimization)**: Check all hash-based caches for known malware
6. **Fast Block**: If cached as malicious ‚Üí BLOCK immediately (skip ClamAV)
7. **ClamAV Scan**: Local signature-based scanning via INSTREAM (if cache miss or clean)
8. **File Size Check (ClamAV)**: Validates file size against ClamAV limits (25MB default)
9. **Cloud Scans**: VirusTotal, ThreatFox, SentinelOne hash lookups (if not cached and within hash size limit)
10. **Decision**: Block if malware detected, allow if clean

### Multi-Layer Scanning
- **ClamAV**: Local signature-based scanning (~200ms)
- **VirusTotal**: Cloud ML + 70+ AV engines (hash lookup)
- **ThreatFox**: Community IOC database (hash lookup)
- **SentinelOne**: Enterprise threat intelligence (hash lookup)

## Configuration

All configuration is done via environment variables in `/etc/bunkerweb/variables.env`:

### Core Settings
- `MALWARE_SCAN_ENABLED`: Enable/disable ClamAV scanning
- `MALWARE_SCAN_DEBUG`: Enable debug logging
- `MALWARE_SCAN_EXCLUDED_EXTENSIONS`: File types to skip

### ClamAV Settings
- `MALWARE_SCAN_CLAMAV_HOST`: ClamAV daemon host
- `MALWARE_SCAN_CLAMAV_PORT`: ClamAV daemon port
- `MALWARE_SCAN_CLAMAV_TIMEOUT`: Connection timeout (ms)
- `MALWARE_SCAN_CLAMAV_MAX_SIZE`: Max file size for INSTREAM (bytes)
- `MALWARE_SCAN_HASH_MAX_SIZE`: Max file size for hash-based scanning (bytes, default: 64MB)

### VirusTotal Settings
- `MALWARE_SCAN_USE_VIRUSTOTAL`: Enable VirusTotal integration
- `MALWARE_SCAN_VIRUSTOTAL_API_KEY`: API key (required)
- `MALWARE_SCAN_VT_UPLOAD_UNKNOWN`: Upload unknown malware to VT
- `MALWARE_SCAN_VT_AUTO_VOTE`: Auto-vote on uploaded files

### ThreatFox Settings
- `MALWARE_SCAN_USE_THREATFOX`: Enable ThreatFox integration
- `MALWARE_SCAN_THREATFOX_API_KEY`: API key (required)

### SentinelOne Settings
- `MALWARE_SCAN_USE_SENTINELONE`: Enable SentinelOne integration
- `MALWARE_SCAN_SENTINELONE_MANAGEMENT_URL`: Console URL
- `MALWARE_SCAN_SENTINELONE_API_TOKEN`: API token (required)

### Webhook Settings
- `MALWARE_SCAN_DISCORD_WEBHOOK_URL`: Discord webhook URL for notifications
- `MALWARE_SCAN_DISCORD_WEBHOOK_RATE_LIMIT`: Max Discord notifications per 60 seconds (default: 5)
- `MALWARE_SCAN_TEAMS_WEBHOOK_URL`: Microsoft Teams webhook URL for notifications
- `MALWARE_SCAN_TEAMS_WEBHOOK_RATE_LIMIT`: Max Teams notifications per minute (default: 6)
- `MALWARE_SCAN_UNMASK_KEYS`: Set to `I_WANT_TO_LEAK_MY_SECRETS_TO_LOG` to show unmasked secrets in logs (debugging only)

### Caching
- `MALWARE_SCAN_CACHE_TTL`: Cache duration for **malicious** results in seconds (default: 3600)
  - Clean results are **always** cached for 5 minutes (hardcoded for security)
  - Malicious results use this TTL (default: 1 hour)
  - See [CACHING.md](CACHING.md) for differential caching strategy

## Installation

This plugin is designed to be installed in BunkerWeb's plugin directory:

```bash
/etc/bunkerweb/plugins/malware-scan/
‚îú‚îÄ‚îÄ plugin.json
‚îú‚îÄ‚îÄ malware-scan.lua
‚îî‚îÄ‚îÄ malware_scan_webhook.lua  # Optional: for Discord/Teams notifications
```

**Note:** The `malware_scan_webhook.lua` file is optional. The plugin works without it, but webhook notifications will be disabled.

See [INSTALL.md](INSTALL.md) for detailed installation instructions.

## Files

### plugin.json
Plugin configuration and metadata file that defines:
- Plugin metadata (name, version, description)
- Configuration variables and their defaults
- GUI settings and validation rules
- All configurable parameters for the plugin
- Webhook configuration settings (Discord, Teams)

### malware-scan.lua
Main plugin implementation containing:
- Multi-layer malware scanning logic (ClamAV + VirusTotal + ThreatFox + SentinelOne)
- File upload interception and scanning
- ClamAV INSTREAM protocol implementation
- VirusTotal, ThreatFox, and SentinelOne API integration
- File size checking and graceful degradation
- Caching system for hash-based scans
- Webhook integration (loads malware_scan_webhook.lua module)
- Sensitive value masking for security
- Cleanup and error handling

### malware_scan_webhook.lua
Webhook notification module containing:
- Discord and Microsoft Teams webhook support
- Automatic webhook type detection from URL
- Rate limiting with configurable limits
- Retry logic with exponential backoff
- Cached results indicator in notifications
- Single aggregated notification per malware detection

## Version History

### 0.3.0
- **New:** Discord webhook integration for real-time malware alerts
- **New:** Microsoft Teams webhook integration
- **New:** Single aggregated notification per file (all scanner results in one message)
- **New:** Cached results indicator in webhook notifications
- **New:** Sensitive value masking (API keys, webhook URLs) in logs
- **New:** Configurable `MALWARE_SCAN_UNMASK_KEYS` for debugging
- **New:** Webhook rate limiting (Discord: 5/60s, Teams: 6/min, configurable)
- **New:** Separate webhook module (`malware_scan_webhook.lua`) with retry logic
- **Improved:** Security - secrets masked by default in logs
- **Improved:** Performance - cached results don't waste CPU on re-scanning

### 0.2.0
- Renamed `MALWARE_SCAN_SKIP_VT_ON_CLAMAV_DETECT` to `MALWARE_SCAN_SKIP_OTHERS_ON_CLAMAV_DETECT`
- Improved cloud scanner logic to check all scanners (ThreatFox, VirusTotal, SentinelOne)
- Updated documentation to use "cloud scanners" terminology
- Added threat intelligence file sharing feature via `MALWARE_SCAN_SHARE_FILES`

### 0.1.0
- Initial release
- Multi-layer scanning (ClamAV + VirusTotal + ThreatFox + SentinelOne)
- File size checking and graceful degradation
- Configurable cache TTL
- User-Agent with version tracking
- VirusTotal upload and voting features

## API Limitations

### VirusTotal Public API
- **Rate limits**: 4 requests/minute, 500 requests/day
- **Restrictions**: Not for commercial use or non-contributing workflows
- Free API key from https://www.virustotal.com/gui/join-us

### ThreatFox API
- Free API key required (https://auth.abuse.ch/)
- Generous rate limits for community use

### SentinelOne API
- Requires SentinelOne license
- Rate limit: 10 req/sec (50 burst)

## Development

### Plugin Structure
```lua
-- Plugin instance
local malware_scan = class.new("malware-scan", plugin)

-- Lifecycle hooks
function malware_scan:init_worker()  -- Worker initialization
function malware_scan:access()        -- Request interception
function malware_scan:api()           -- API endpoints

-- Core functions
function malware_scan:scan_file_instream()     -- ClamAV INSTREAM scan (from file)
function malware_scan:scan_content_instream()  -- ClamAV INSTREAM scan (from string)
function malware_scan:check_virustotal()       -- VirusTotal API
function malware_scan:check_threatfox()        -- ThreatFox API
function malware_scan:check_sentinelone()      -- SentinelOne API
```

### API Endpoints

The plugin provides REST API endpoints for testing (internal BunkerWeb API only):

- **POST /malware-scan/ping** - Test ClamAV connectivity (PING command)
- **POST /malware-scan/test-eicar** - Test ClamAV malware detection with EICAR test string
- **POST /malware-scan/virustotal-ping** - Test VirusTotal API connectivity (requires API key)

**Note:** These endpoints are for internal BunkerWeb use only and not directly accessible via HTTP.

### Error Handling
- ClamAV connection failures: Continue with hash-based scanners
- File size exceeds limit: Skip ClamAV, use hash-based scanners
- API failures: Log error, continue (fail-open for availability)

### Caching Strategy
- **ClamAV results**: Not cached (file path based, not hash)
- **Hash-based results**: Cached for `MALWARE_SCAN_CACHE_TTL` seconds (default: 3600 = 1 hour)
  - Both clean and malicious results are cached
  - Prevents repeated API calls for same file SHA256
  - Cache keys: `plugin_malware_scan_{scanner}_{sha256}`
  - Scanners cached: VirusTotal, ThreatFox, SentinelOne
- **Cache expiration**: Entries automatically expire after TTL
- **Force cache clear**: Restart BunkerWeb (`sudo systemctl restart bunkerweb`)

## Support

- BunkerWeb Docs: https://docs.bunkerweb.io/
- ClamAV Docs: https://docs.clamav.net/
- Plugin Issues: Check logs first (`journalctl -u bunkerweb`)

## License

This plugin is part of the BunkerWeb project.

-- BunkerWeb Malware Scan - UI Metrics Tracking Module
-- Tracks scan statistics, detections, and cache performance for UI dashboard
-- Uses BunkerWeb's built-in metrics system (self:set_metric)
--
-- Metrics tracked:
--   - counters:
--     - malware_detected: Total malware files detected
--     - files_scanned: Total files scanned
--     - cache_hits: Total cache hits (all scanners)
--     - cache_hits_<scanner>: Per-scanner cache hits
--     - signature_<name>: Per-signature detection count
--     - scanner_<name>: Per-scanner detection count
--   - tables:
--     - detections: Detailed detection history

local cjson = require("cjson")

-- Module table
local ui_metrics = {}

-- Module version
ui_metrics.VERSION = "0.8.0"

-- Ngx constants (with fallback for testing)
local ngx = ngx or {}
local ERR = ngx.ERR or 3
local WARN = ngx.WARN or 4
local INFO = ngx.INFO or 6

-- ============================================================================
-- COUNTER METRICS
-- ============================================================================

-- Track file scan metric.
-- Increments counter for each file upload scanned.
--
--- @param plugin Plugin The plugin instance
function ui_metrics.track_file_scanned(plugin)
	plugin:set_metric("counters", "files_scanned", 1)
end

-- Track cache hit metric.
-- Increments counter when a cached result is used.
--
--- @param plugin Plugin The plugin instance
--- @param scanner_name Name of scanner that had cache hit (e.g., "clamav", "virustotal")
function ui_metrics.track_cache_hit(plugin, scanner_name)
	plugin:set_metric("counters", "cache_hits", 1)

	-- Also track per-scanner cache hits
	if scanner_name then
		local scanner_key = scanner_name:gsub("[^%w_]", "_"):lower()
		plugin:set_metric("counters", "cache_hits_" .. scanner_key, 1)
	end
end

-- Track malware detection metric.
-- Increments multiple counters:
-- - malware_detected (total)
-- - signature_<name> (per-signature)
-- - scanner_<name> (per-scanner)
--
--- @param plugin Plugin The plugin instance
--- @param scanner_name string Name of scanner that detected malware (e.g., "ClamAV", "VirusTotal")
--- @param signature string The malware signature/name detected
function ui_metrics.track_malware_detected(plugin, scanner_name, signature)
	-- Increment total malware counter
	plugin:set_metric("counters", "malware_detected", 1)

	-- Increment per-scanner counter
	if scanner_name then
		-- Sanitize scanner name: "ClamAV (cached)" -> "clamav_cached"
		local scanner_key = scanner_name:gsub("[^%w_]", "_"):lower()
		plugin:set_metric("counters", "scanner_" .. scanner_key, 1)
	end

	-- Increment per-signature counter
	if signature and signature ~= "" then
		-- Sanitize signature name for metric key (remove special chars, limit length)
		local sig_key = signature:gsub("[^%w_%-]", "_"):lower()
		if #sig_key > 100 then
			sig_key = sig_key:sub(1, 100)
		end
		plugin:set_metric("counters", "signature_" .. sig_key, 1)
	end
end

-- ============================================================================
-- DETECTION HISTORY TABLE
-- ============================================================================

-- Extract filename from multipart upload headers or request.
-- Tries to parse Content-Disposition header to get original filename.
--
--- @param plugin Plugin The plugin instance
--- @return string filename Original filename or "uploaded_file" if not found
local function ui_metrics_extract_filename(plugin)
	-- Try to get filename from request headers
	if plugin.ctx.bw.http_content_disposition then
		local filename = plugin.ctx.bw.http_content_disposition:match('filename="([^"]+)"')
		if filename then
			return filename
		end
	end

	-- Fallback to generic name
	return "uploaded_file"
end

-- Get client country from GeoIP if available.
--
--- @param plugin Plugin The plugin instance
--- @return string country Country code or "unknown" if not available
local function ui_metrics_get_client_country(plugin)
	-- Try to get country from BunkerWeb GeoIP integration
	if plugin.ctx.bw.country_code then
		return plugin.ctx.bw.country_code
	end

	return "unknown"
end

-- Build comprehensive detection data structure.
-- Collects all available information about the detection for metrics.
--
--- @param plugin Plugin The plugin instance
--- @param scanner_name string Name of scanner (e.g., "ClamAV")
--- @param signature string Malware signature
--- @param checksum string File SHA256 hash
--- @param detections table Table of all detections from multiple scanners
--- @return table detection_data Detection data structure with metadata
local function ui_metrics_build_detection_data(plugin, scanner_name, signature, checksum, detections)
	local detection_id = string.format("%d_%s",
		os.time(),
		checksum and checksum:sub(1, 8) or "unknown"
	)

	return {
		id = detection_id,
		timestamp = os.time(),
		signature = signature or "unknown",
		scanner = scanner_name or "unknown",
		sha256 = checksum or "",
		filename = ui_metrics_extract_filename(plugin),
		ip = plugin.ctx.bw.remote_addr or "unknown",
		country = ui_metrics_get_client_country(plugin),
		url = plugin.ctx.bw.uri or "/",
		method = plugin.ctx.bw.request_method or "POST",
		-- Include count of all scanner detections
		detection_count = detections and #detections or 1
	}
end

-- Add detection to history table for UI display.
-- Stores structured detection data in BunkerWeb metrics system.
--
--- @param plugin Plugin The plugin instance
--- @param scanner_name string Name of scanner
--- @param signature string Malware signature
--- @param checksum string File SHA256 hash
--- @param detections table Table of all detections from multiple scanners
function ui_metrics.add_detection(plugin, scanner_name, signature, checksum, detections)
	local detection_data = ui_metrics_build_detection_data(
		plugin, scanner_name, signature, checksum, detections
	)

	-- Store in BunkerWeb metrics tables
	-- The UI will read this via get_metrics("malware-scan")
	plugin:set_metric("tables", "detections", detection_data)
end

-- Track complete malware detection with all metrics.
-- Convenience function that tracks counters and adds to detection table.
--
--- @param plugin Plugin The plugin instance
--- @param scanner_name string Name of scanner
--- @param signature string Malware signature
--- @param checksum string File SHA256 hash
--- @param detections table Table of all detections
function ui_metrics.track_detection_complete(plugin, scanner_name, signature, checksum, detections)
	-- Track counter metrics
	ui_metrics.track_malware_detected(plugin, scanner_name, signature)

	-- Add to detection history table
	ui_metrics.add_detection(plugin, scanner_name, signature, checksum, detections)
end

return ui_metrics
